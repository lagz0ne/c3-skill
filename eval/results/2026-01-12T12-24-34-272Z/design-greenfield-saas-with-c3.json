{
  "name": "Design greenfield SaaS with C3",
  "pass": true,
  "score": 100,
  "duration": 734164,
  "trace": [
    {
      "timestamp": "2026-01-12T12:07:31.523Z",
      "event": "PreToolUse",
      "tool": "Bash",
      "input": {
        "command": "ls -la /tmp/tmp.W3TPal6rM5",
        "description": "List contents of working directory"
      }
    },
    {
      "timestamp": "2026-01-12T12:07:31.564Z",
      "event": "PostToolUse",
      "tool": "Bash",
      "input": {
        "command": "ls -la /tmp/tmp.W3TPal6rM5",
        "description": "List contents of working directory"
      },
      "result": {
        "stdout": ".rw-r--r-- 128 lagz0ne 12 Jan 19:07 package.json\n.rw-r--r-- 350 lagz0ne 12 Jan 19:07 README.md\ndrwxr-xr-x   - lagz0ne 12 Jan 19:07 src",
        "stderr": "",
        "interrupted": false,
        "isImage": false
      }
    },
    {
      "timestamp": "2026-01-12T12:07:32.022Z",
      "event": "PreToolUse",
      "tool": "Skill",
      "input": {
        "skill": "c3-skill:onboard",
        "args": "TaskFlow - task management SaaS for small teams. Design decisions: React SPA frontend + API for mobile, Node.js/TypeScript backend with Express, PostgreSQL + Redis (caching + pub/sub), modular monolith architecture, WebSocket for real-time collaboration, Google OAuth authentication, multi-tenant with team workspaces. Create full C3 architecture with ADR-000 as the system blueprint."
      }
    },
    {
      "timestamp": "2026-01-12T12:07:32.162Z",
      "event": "PostToolUse",
      "tool": "Skill",
      "input": {
        "skill": "c3-skill:onboard",
        "args": "TaskFlow - task management SaaS for small teams. Design decisions: React SPA frontend + API for mobile, Node.js/TypeScript backend with Express, PostgreSQL + Redis (caching + pub/sub), modular monolith architecture, WebSocket for real-time collaboration, Google OAuth authentication, multi-tenant with team workspaces. Create full C3 architecture with ADR-000 as the system blueprint."
      },
      "result": {
        "success": true,
        "commandName": "c3-skill:onboard",
        "allowedTools": [
          "Bash(rm:*)",
          "Bash(test:*)",
          "Bash(PROJECT=*)",
          "Read",
          "Glob",
          "Grep",
          "Write",
          "Edit",
          "AskUserQuestion",
          "Skill"
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:07:38.606Z",
      "event": "PreToolUse",
      "tool": "Bash",
      "input": {
        "command": "mkdir -p .c3/components .c3/refs .c3/adrs",
        "description": "Create C3 directory structure"
      }
    },
    {
      "timestamp": "2026-01-12T12:07:38.633Z",
      "event": "PostToolUse",
      "tool": "Bash",
      "input": {
        "command": "mkdir -p .c3/components .c3/refs .c3/adrs",
        "description": "Create C3 directory structure"
      },
      "result": {
        "stdout": "",
        "stderr": "",
        "interrupted": false,
        "isImage": false
      }
    },
    {
      "timestamp": "2026-01-12T12:07:43.487Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "in_progress",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "pending",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:07:43.504Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "in_progress",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "pending",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "in_progress",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "pending",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:08:54.915Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/Users/jrutyna/Development/SoftwareArchitecture/c3/.c3/adrs/adr-000-system-blueprint.md",
        "content": "# ADR-000: TaskFlow System Blueprint\n\n## Status\n**Accepted** | 2026-01-12\n\n## Context\n\nTaskFlow is a task management SaaS application designed for small teams. The system needs to support:\n\n- **Real-time collaboration** on task boards with multiple simultaneous users\n- **Multi-tenant architecture** with team workspaces for data isolation\n- **Future mobile expansion** via a well-designed API layer\n- **Scalable growth path** from MVP to enterprise without major rewrites\n\n### Business Requirements\n1. Teams can create workspaces with isolated task boards\n2. Real-time updates when team members modify tasks\n3. Google OAuth for frictionless onboarding\n4. Responsive web interface with future native mobile apps\n\n### Technical Constraints\n1. Small team (2-4 developers initially)\n2. Need to ship MVP in 3 months\n3. Must support 100+ concurrent users per workspace\n4. Budget-conscious infrastructure (start small, scale as needed)\n\n## Decision\n\nWe adopt a **modular monolith architecture** with the following technology stack and architectural patterns:\n\n### Technology Stack\n\n| Layer | Technology | Rationale |\n|-------|------------|-----------|\n| Frontend | React SPA + TypeScript | Component reuse, strong typing, large ecosystem |\n| Backend | Node.js + Express + TypeScript | Full-stack TypeScript, async I/O for real-time |\n| Database | PostgreSQL | ACID compliance, JSON support, proven reliability |\n| Cache | Redis | Caching, session storage, pub/sub for real-time |\n| Real-time | WebSocket (Socket.io) | Bidirectional communication for live updates |\n| Auth | Google OAuth 2.0 + JWT | Zero-friction signup, stateless auth tokens |\n\n### Architectural Patterns\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        TASKFLOW SYSTEM                          │\n├─────────────────────────────────────────────────────────────────┤\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │\n│  │   React     │    │   Mobile    │    │   External          │  │\n│  │   SPA       │    │   Apps      │    │   Integrations      │  │\n│  │  (Web UI)   │    │  (Future)   │    │   (Webhooks)        │  │\n│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │\n│         │                  │                       │             │\n│         └──────────────────┼───────────────────────┘             │\n│                            ▼                                     │\n│  ┌─────────────────────────────────────────────────────────────┐ │\n│  │                     API GATEWAY                              │ │\n│  │    (Express + JWT Auth + Rate Limiting + Request Logging)   │ │\n│  └─────────────────────────┬───────────────────────────────────┘ │\n│                            │                                     │\n│  ┌─────────────────────────▼───────────────────────────────────┐ │\n│  │                  MODULAR MONOLITH                            │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │                 FEATURE MODULES                       │   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │    Auth    │ │ Workspace  │ │   Task Board       ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │   User     │ │   Team     │ │   Notification     ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │              FOUNDATION LAYER                         │   │ │\n│  │  │  Database │ Cache │ WebSocket │ Events │ Logging     │   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  └─────────────────────────────────────────────────────────────┘ │\n│                            │                                     │\n│         ┌──────────────────┼──────────────────┐                  │\n│         ▼                  ▼                  ▼                  │\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │\n│  │ PostgreSQL  │    │   Redis     │    │   Redis     │          │\n│  │  (Primary)  │    │  (Cache)    │    │  (Pub/Sub)  │          │\n│  └─────────────┘    └─────────────┘    └─────────────┘          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Module Boundaries (Modular Monolith)\n\nEach module encapsulates a business domain with clear boundaries:\n\n| Module | Responsibility | Public Interface |\n|--------|----------------|------------------|\n| **Auth** | OAuth flow, JWT tokens, sessions | `authenticate()`, `authorize()`, `refreshToken()` |\n| **User** | User profiles, preferences | `getUser()`, `updateProfile()`, `getUsersByTeam()` |\n| **Workspace** | Tenant isolation, workspace CRUD | `createWorkspace()`, `getWorkspace()`, `inviteMember()` |\n| **Team** | Team membership, roles, permissions | `addMember()`, `removeMember()`, `setRole()` |\n| **TaskBoard** | Boards, columns, tasks, comments | `createTask()`, `moveTask()`, `subscribeToBoard()` |\n| **Notification** | Email, in-app, push notifications | `notify()`, `getNotifications()`, `markRead()` |\n\n### Multi-Tenancy Strategy\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                    TENANT ISOLATION                      │\n├─────────────────────────────────────────────────────────┤\n│  Strategy: Shared Database, Schema-based Isolation      │\n│                                                         │\n│  ┌─────────────────────────────────────────────────┐   │\n│  │              PostgreSQL Database                 │   │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌───────────┐  │   │\n│  │  │  workspace_ │ │  workspace_ │ │ workspace_│  │   │\n│  │  │  {uuid_1}   │ │  {uuid_2}   │ │ {uuid_n}  │  │   │\n│  │  │  ─────────  │ │  ─────────  │ │ ─────────│  │   │\n│  │  │  tasks      │ │  tasks      │ │ tasks    │  │   │\n│  │  │  boards     │ │  boards     │ │ boards   │  │   │\n│  │  │  columns    │ │  columns    │ │ columns  │  │   │\n│  │  └─────────────┘ └─────────────┘ └───────────┘  │   │\n│  │                                                  │   │\n│  │  ┌─────────────────────────────────────────┐    │   │\n│  │  │           public schema                  │    │   │\n│  │  │  users │ workspaces │ team_memberships  │    │   │\n│  │  └─────────────────────────────────────────┘    │   │\n│  └─────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────┘\n```\n\n### Real-Time Architecture\n\n```\n┌────────────────────────────────────────────────────────────┐\n│                 REAL-TIME COLLABORATION                     │\n├────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Client A ◄───────┐                    ┌───────► Client B   │\n│  (Browser)        │     WebSocket      │        (Browser)   │\n│                   │      Server        │                    │\n│                   └────────┬───────────┘                    │\n│                            │                                │\n│                     ┌──────▼──────┐                         │\n│                     │   Redis     │                         │\n│                     │   Pub/Sub   │                         │\n│                     └──────┬──────┘                         │\n│                            │                                │\n│              ┌─────────────┼─────────────┐                  │\n│              ▼             ▼             ▼                  │\n│         [Server 1]    [Server 2]    [Server N]              │\n│         (future horizontal scaling)                         │\n│                                                             │\n│  Event Types:                                               │\n│  • task:created    • task:moved      • task:deleted        │\n│  • board:updated   • member:joined   • comment:added       │\n└────────────────────────────────────────────────────────────┘\n```\n\n### API Design Principles\n\n1. **RESTful** for CRUD operations: `GET/POST/PUT/DELETE /api/v1/workspaces/:id/tasks`\n2. **WebSocket** for real-time: `ws://api/v1/boards/:id/subscribe`\n3. **Versioned APIs**: `/api/v1/` prefix for all endpoints\n4. **Consistent error format**: `{ error: { code, message, details } }`\n\n### Security Model\n\n| Concern | Solution |\n|---------|----------|\n| Authentication | Google OAuth 2.0 + JWT access tokens (15min) + Refresh tokens (7d) |\n| Authorization | RBAC (Owner, Admin, Member, Guest) per workspace |\n| Data Isolation | Workspace ID in JWT claims, enforced at middleware level |\n| Rate Limiting | Redis-based sliding window (100 req/min per user) |\n| Input Validation | Zod schemas for all API inputs |\n\n### Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA\n│   │   ├── src/\n│   │   │   ├── components/     # Shared UI components\n│   │   │   ├── features/       # Feature-based modules\n│   │   │   ├── hooks/          # Custom React hooks\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API server\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   │   ├── auth/\n│   │   │   │   ├── user/\n│   │   │   │   ├── workspace/\n│   │   │   │   ├── team/\n│   │   │   │   ├── taskboard/\n│   │   │   │   └── notification/\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   │   ├── database/\n│   │   │   │   ├── cache/\n│   │   │   │   ├── websocket/\n│   │   │   │   ├── events/\n│   │   │   │   └── logging/\n│   │   │   └── shared/         # Shared utilities\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types/utilities\n│       ├── src/\n│       │   ├── types/\n│       │   └── validation/\n│       └── package.json\n│\n├── .c3/                        # Architecture documentation\n├── docker-compose.yml          # Local development\n├── package.json                # Monorepo root\n└── turbo.json                  # Turborepo config\n```\n\n## Consequences\n\n### Positive\n- **Single deployable unit** simplifies DevOps and debugging\n- **Clear module boundaries** enable future microservice extraction\n- **Shared TypeScript** between frontend/backend reduces type mismatches\n- **Redis pub/sub** allows horizontal scaling of WebSocket servers\n- **Schema-based multi-tenancy** provides isolation without database sprawl\n\n### Negative\n- **Monolith coupling risk** if module boundaries aren't enforced\n- **Single point of failure** until horizontal scaling is implemented\n- **PostgreSQL schema management** adds complexity for tenant provisioning\n\n### Mitigations\n- Enforce module boundaries via eslint rules and import restrictions\n- Implement health checks and graceful degradation early\n- Automate schema provisioning in workspace creation flow\n\n## C3 Documentation Structure\n\nThis blueprint is implemented across the following C3 artifacts:\n\n| Artifact | Purpose |\n|----------|---------|\n| `c3-0-context.md` | System context - external actors and systems |\n| `c3-1-web.md` | React SPA container and components |\n| `c3-2-api.md` | Express API container and components |\n| `c3-3-database.md` | PostgreSQL schemas and data model |\n| `c3-4-cache.md` | Redis caching and pub/sub |\n| `components/*.md` | Detailed component specifications |\n| `refs/*.md` | Shared patterns and conventions |\n\n## References\n\n- [C4 Model](https://c4model.com/) - Architectural diagram methodology\n- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Architecture pattern\n- [Socket.io Redis Adapter](https://socket.io/docs/v4/redis-adapter/) - Scaling WebSockets\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:08:54.915Z",
      "event": "Blocked",
      "tool": "Write",
      "input": {
        "file_path": "/Users/jrutyna/Development/SoftwareArchitecture/c3/.c3/adrs/adr-000-system-blueprint.md",
        "content": "# ADR-000: TaskFlow System Blueprint\n\n## Status\n**Accepted** | 2026-01-12\n\n## Context\n\nTaskFlow is a task management SaaS application designed for small teams. The system needs to support:\n\n- **Real-time collaboration** on task boards with multiple simultaneous users\n- **Multi-tenant architecture** with team workspaces for data isolation\n- **Future mobile expansion** via a well-designed API layer\n- **Scalable growth path** from MVP to enterprise without major rewrites\n\n### Business Requirements\n1. Teams can create workspaces with isolated task boards\n2. Real-time updates when team members modify tasks\n3. Google OAuth for frictionless onboarding\n4. Responsive web interface with future native mobile apps\n\n### Technical Constraints\n1. Small team (2-4 developers initially)\n2. Need to ship MVP in 3 months\n3. Must support 100+ concurrent users per workspace\n4. Budget-conscious infrastructure (start small, scale as needed)\n\n## Decision\n\nWe adopt a **modular monolith architecture** with the following technology stack and architectural patterns:\n\n### Technology Stack\n\n| Layer | Technology | Rationale |\n|-------|------------|-----------|\n| Frontend | React SPA + TypeScript | Component reuse, strong typing, large ecosystem |\n| Backend | Node.js + Express + TypeScript | Full-stack TypeScript, async I/O for real-time |\n| Database | PostgreSQL | ACID compliance, JSON support, proven reliability |\n| Cache | Redis | Caching, session storage, pub/sub for real-time |\n| Real-time | WebSocket (Socket.io) | Bidirectional communication for live updates |\n| Auth | Google OAuth 2.0 + JWT | Zero-friction signup, stateless auth tokens |\n\n### Architectural Patterns\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        TASKFLOW SYSTEM                          │\n├─────────────────────────────────────────────────────────────────┤\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │\n│  │   React     │    │   Mobile    │    │   External          │  │\n│  │   SPA       │    │   Apps      │    │   Integrations      │  │\n│  │  (Web UI)   │    │  (Future)   │    │   (Webhooks)        │  │\n│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │\n│         │                  │                       │             │\n│         └──────────────────┼───────────────────────┘             │\n│                            ▼                                     │\n│  ┌─────────────────────────────────────────────────────────────┐ │\n│  │                     API GATEWAY                              │ │\n│  │    (Express + JWT Auth + Rate Limiting + Request Logging)   │ │\n│  └─────────────────────────┬───────────────────────────────────┘ │\n│                            │                                     │\n│  ┌─────────────────────────▼───────────────────────────────────┐ │\n│  │                  MODULAR MONOLITH                            │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │                 FEATURE MODULES                       │   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │    Auth    │ │ Workspace  │ │   Task Board       ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │   User     │ │   Team     │ │   Notification     ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │              FOUNDATION LAYER                         │   │ │\n│  │  │  Database │ Cache │ WebSocket │ Events │ Logging     │   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  └─────────────────────────────────────────────────────────────┘ │\n│                            │                                     │\n│         ┌──────────────────┼──────────────────┐                  │\n│         ▼                  ▼                  ▼                  │\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │\n│  │ PostgreSQL  │    │   Redis     │    │   Redis     │          │\n│  │  (Primary)  │    │  (Cache)    │    │  (Pub/Sub)  │          │\n│  └─────────────┘    └─────────────┘    └─────────────┘          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Module Boundaries (Modular Monolith)\n\nEach module encapsulates a business domain with clear boundaries:\n\n| Module | Responsibility | Public Interface |\n|--------|----------------|------------------|\n| **Auth** | OAuth flow, JWT tokens, sessions | `authenticate()`, `authorize()`, `refreshToken()` |\n| **User** | User profiles, preferences | `getUser()`, `updateProfile()`, `getUsersByTeam()` |\n| **Workspace** | Tenant isolation, workspace CRUD | `createWorkspace()`, `getWorkspace()`, `inviteMember()` |\n| **Team** | Team membership, roles, permissions | `addMember()`, `removeMember()`, `setRole()` |\n| **TaskBoard** | Boards, columns, tasks, comments | `createTask()`, `moveTask()`, `subscribeToBoard()` |\n| **Notification** | Email, in-app, push notifications | `notify()`, `getNotifications()`, `markRead()` |\n\n### Multi-Tenancy Strategy\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                    TENANT ISOLATION                      │\n├─────────────────────────────────────────────────────────┤\n│  Strategy: Shared Database, Schema-based Isolation      │\n│                                                         │\n│  ┌─────────────────────────────────────────────────┐   │\n│  │              PostgreSQL Database                 │   │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌───────────┐  │   │\n│  │  │  workspace_ │ │  workspace_ │ │ workspace_│  │   │\n│  │  │  {uuid_1}   │ │  {uuid_2}   │ │ {uuid_n}  │  │   │\n│  │  │  ─────────  │ │  ─────────  │ │ ─────────│  │   │\n│  │  │  tasks      │ │  tasks      │ │ tasks    │  │   │\n│  │  │  boards     │ │  boards     │ │ boards   │  │   │\n│  │  │  columns    │ │  columns    │ │ columns  │  │   │\n│  │  └─────────────┘ └─────────────┘ └───────────┘  │   │\n│  │                                                  │   │\n│  │  ┌─────────────────────────────────────────┐    │   │\n│  │  │           public schema                  │    │   │\n│  │  │  users │ workspaces │ team_memberships  │    │   │\n│  │  └─────────────────────────────────────────┘    │   │\n│  └─────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────┘\n```\n\n### Real-Time Architecture\n\n```\n┌────────────────────────────────────────────────────────────┐\n│                 REAL-TIME COLLABORATION                     │\n├────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Client A ◄───────┐                    ┌───────► Client B   │\n│  (Browser)        │     WebSocket      │        (Browser)   │\n│                   │      Server        │                    │\n│                   └────────┬───────────┘                    │\n│                            │                                │\n│                     ┌──────▼──────┐                         │\n│                     │   Redis     │                         │\n│                     │   Pub/Sub   │                         │\n│                     └──────┬──────┘                         │\n│                            │                                │\n│              ┌─────────────┼─────────────┐                  │\n│              ▼             ▼             ▼                  │\n│         [Server 1]    [Server 2]    [Server N]              │\n│         (future horizontal scaling)                         │\n│                                                             │\n│  Event Types:                                               │\n│  • task:created    • task:moved      • task:deleted        │\n│  • board:updated   • member:joined   • comment:added       │\n└────────────────────────────────────────────────────────────┘\n```\n\n### API Design Principles\n\n1. **RESTful** for CRUD operations: `GET/POST/PUT/DELETE /api/v1/workspaces/:id/tasks`\n2. **WebSocket** for real-time: `ws://api/v1/boards/:id/subscribe`\n3. **Versioned APIs**: `/api/v1/` prefix for all endpoints\n4. **Consistent error format**: `{ error: { code, message, details } }`\n\n### Security Model\n\n| Concern | Solution |\n|---------|----------|\n| Authentication | Google OAuth 2.0 + JWT access tokens (15min) + Refresh tokens (7d) |\n| Authorization | RBAC (Owner, Admin, Member, Guest) per workspace |\n| Data Isolation | Workspace ID in JWT claims, enforced at middleware level |\n| Rate Limiting | Redis-based sliding window (100 req/min per user) |\n| Input Validation | Zod schemas for all API inputs |\n\n### Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA\n│   │   ├── src/\n│   │   │   ├── components/     # Shared UI components\n│   │   │   ├── features/       # Feature-based modules\n│   │   │   ├── hooks/          # Custom React hooks\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API server\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   │   ├── auth/\n│   │   │   │   ├── user/\n│   │   │   │   ├── workspace/\n│   │   │   │   ├── team/\n│   │   │   │   ├── taskboard/\n│   │   │   │   └── notification/\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   │   ├── database/\n│   │   │   │   ├── cache/\n│   │   │   │   ├── websocket/\n│   │   │   │   ├── events/\n│   │   │   │   └── logging/\n│   │   │   └── shared/         # Shared utilities\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types/utilities\n│       ├── src/\n│       │   ├── types/\n│       │   └── validation/\n│       └── package.json\n│\n├── .c3/                        # Architecture documentation\n├── docker-compose.yml          # Local development\n├── package.json                # Monorepo root\n└── turbo.json                  # Turborepo config\n```\n\n## Consequences\n\n### Positive\n- **Single deployable unit** simplifies DevOps and debugging\n- **Clear module boundaries** enable future microservice extraction\n- **Shared TypeScript** between frontend/backend reduces type mismatches\n- **Redis pub/sub** allows horizontal scaling of WebSocket servers\n- **Schema-based multi-tenancy** provides isolation without database sprawl\n\n### Negative\n- **Monolith coupling risk** if module boundaries aren't enforced\n- **Single point of failure** until horizontal scaling is implemented\n- **PostgreSQL schema management** adds complexity for tenant provisioning\n\n### Mitigations\n- Enforce module boundaries via eslint rules and import restrictions\n- Implement health checks and graceful degradation early\n- Automate schema provisioning in workspace creation flow\n\n## C3 Documentation Structure\n\nThis blueprint is implemented across the following C3 artifacts:\n\n| Artifact | Purpose |\n|----------|---------|\n| `c3-0-context.md` | System context - external actors and systems |\n| `c3-1-web.md` | React SPA container and components |\n| `c3-2-api.md` | Express API container and components |\n| `c3-3-database.md` | PostgreSQL schemas and data model |\n| `c3-4-cache.md` | Redis caching and pub/sub |\n| `components/*.md` | Detailed component specifications |\n| `refs/*.md` | Shared patterns and conventions |\n\n## References\n\n- [C4 Model](https://c4model.com/) - Architectural diagram methodology\n- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Architecture pattern\n- [Socket.io Redis Adapter](https://socket.io/docs/v4/redis-adapter/) - Scaling WebSockets\n"
      },
      "blocked": true,
      "reason": "Path outside sandbox: /Users/jrutyna/Development/SoftwareArchitecture/c3/.c3/adrs/adr-000-system-blueprint.md"
    },
    {
      "timestamp": "2026-01-12T12:08:58.423Z",
      "event": "PreToolUse",
      "tool": "Bash",
      "input": {
        "command": "pwd",
        "description": "Check current working directory"
      }
    },
    {
      "timestamp": "2026-01-12T12:08:58.459Z",
      "event": "PostToolUse",
      "tool": "Bash",
      "input": {
        "command": "pwd",
        "description": "Check current working directory"
      },
      "result": {
        "stdout": "/tmp/tmp.W3TPal6rM5",
        "stderr": "",
        "interrupted": false,
        "isImage": false
      }
    },
    {
      "timestamp": "2026-01-12T12:09:01.074Z",
      "event": "PreToolUse",
      "tool": "Bash",
      "input": {
        "command": "mkdir -p /tmp/tmp.W3TPal6rM5/.c3/components /tmp/tmp.W3TPal6rM5/.c3/refs /tmp/tmp.W3TPal6rM5/.c3/adrs",
        "description": "Create C3 directory structure in current directory"
      }
    },
    {
      "timestamp": "2026-01-12T12:09:01.109Z",
      "event": "PostToolUse",
      "tool": "Bash",
      "input": {
        "command": "mkdir -p /tmp/tmp.W3TPal6rM5/.c3/components /tmp/tmp.W3TPal6rM5/.c3/refs /tmp/tmp.W3TPal6rM5/.c3/adrs",
        "description": "Create C3 directory structure in current directory"
      },
      "result": {
        "stdout": "",
        "stderr": "",
        "interrupted": false,
        "isImage": false
      }
    },
    {
      "timestamp": "2026-01-12T12:10:05.695Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/adrs/adr-000-system-blueprint.md",
        "content": "# ADR-000: TaskFlow System Blueprint\n\n## Status\n**Accepted** | 2026-01-12\n\n## Context\n\nTaskFlow is a task management SaaS application designed for small teams. The system needs to support:\n\n- **Real-time collaboration** on task boards with multiple simultaneous users\n- **Multi-tenant architecture** with team workspaces for data isolation\n- **Future mobile expansion** via a well-designed API layer\n- **Scalable growth path** from MVP to enterprise without major rewrites\n\n### Business Requirements\n1. Teams can create workspaces with isolated task boards\n2. Real-time updates when team members modify tasks\n3. Google OAuth for frictionless onboarding\n4. Responsive web interface with future native mobile apps\n\n### Technical Constraints\n1. Small team (2-4 developers initially)\n2. Need to ship MVP in 3 months\n3. Must support 100+ concurrent users per workspace\n4. Budget-conscious infrastructure (start small, scale as needed)\n\n## Decision\n\nWe adopt a **modular monolith architecture** with the following technology stack and architectural patterns:\n\n### Technology Stack\n\n| Layer | Technology | Rationale |\n|-------|------------|-----------|\n| Frontend | React SPA + TypeScript | Component reuse, strong typing, large ecosystem |\n| Backend | Node.js + Express + TypeScript | Full-stack TypeScript, async I/O for real-time |\n| Database | PostgreSQL | ACID compliance, JSON support, proven reliability |\n| Cache | Redis | Caching, session storage, pub/sub for real-time |\n| Real-time | WebSocket (Socket.io) | Bidirectional communication for live updates |\n| Auth | Google OAuth 2.0 + JWT | Zero-friction signup, stateless auth tokens |\n\n### Architectural Patterns\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        TASKFLOW SYSTEM                          │\n├─────────────────────────────────────────────────────────────────┤\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │\n│  │   React     │    │   Mobile    │    │   External          │  │\n│  │   SPA       │    │   Apps      │    │   Integrations      │  │\n│  │  (Web UI)   │    │  (Future)   │    │   (Webhooks)        │  │\n│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │\n│         │                  │                       │             │\n│         └──────────────────┼───────────────────────┘             │\n│                            ▼                                     │\n│  ┌─────────────────────────────────────────────────────────────┐ │\n│  │                     API GATEWAY                              │ │\n│  │    (Express + JWT Auth + Rate Limiting + Request Logging)   │ │\n│  └─────────────────────────┬───────────────────────────────────┘ │\n│                            │                                     │\n│  ┌─────────────────────────▼───────────────────────────────────┐ │\n│  │                  MODULAR MONOLITH                            │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │                 FEATURE MODULES                       │   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │    Auth    │ │ Workspace  │ │   Task Board       ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │   User     │ │   Team     │ │   Notification     ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │              FOUNDATION LAYER                         │   │ │\n│  │  │  Database │ Cache │ WebSocket │ Events │ Logging     │   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  └─────────────────────────────────────────────────────────────┘ │\n│                            │                                     │\n│         ┌──────────────────┼──────────────────┐                  │\n│         ▼                  ▼                  ▼                  │\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │\n│  │ PostgreSQL  │    │   Redis     │    │   Redis     │          │\n│  │  (Primary)  │    │  (Cache)    │    │  (Pub/Sub)  │          │\n│  └─────────────┘    └─────────────┘    └─────────────┘          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Module Boundaries (Modular Monolith)\n\nEach module encapsulates a business domain with clear boundaries:\n\n| Module | Responsibility | Public Interface |\n|--------|----------------|------------------|\n| **Auth** | OAuth flow, JWT tokens, sessions | `authenticate()`, `authorize()`, `refreshToken()` |\n| **User** | User profiles, preferences | `getUser()`, `updateProfile()`, `getUsersByTeam()` |\n| **Workspace** | Tenant isolation, workspace CRUD | `createWorkspace()`, `getWorkspace()`, `inviteMember()` |\n| **Team** | Team membership, roles, permissions | `addMember()`, `removeMember()`, `setRole()` |\n| **TaskBoard** | Boards, columns, tasks, comments | `createTask()`, `moveTask()`, `subscribeToBoard()` |\n| **Notification** | Email, in-app, push notifications | `notify()`, `getNotifications()`, `markRead()` |\n\n### Multi-Tenancy Strategy\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    TENANT ISOLATION                              │\n├─────────────────────────────────────────────────────────────────┤\n│  Strategy: Shared Database, Schema-based Isolation              │\n│                                                                  │\n│  ┌───────────────────────────────────────────────────────────┐  │\n│  │                   PostgreSQL Database                      │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │  │\n│  │  │  workspace_ │ │  workspace_ │ │  workspace_ │          │  │\n│  │  │  {uuid_1}   │ │  {uuid_2}   │ │  {uuid_n}   │          │  │\n│  │  │  ─────────  │ │  ─────────  │ │  ─────────  │          │  │\n│  │  │  tasks      │ │  tasks      │ │  tasks      │          │  │\n│  │  │  boards     │ │  boards     │ │  boards     │          │  │\n│  │  │  columns    │ │  columns    │ │  columns    │          │  │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘          │  │\n│  │                                                            │  │\n│  │  ┌─────────────────────────────────────────────────────┐  │  │\n│  │  │                  public schema                       │  │  │\n│  │  │  users │ workspaces │ team_memberships │ invites    │  │  │\n│  │  └─────────────────────────────────────────────────────┘  │  │\n│  └───────────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Real-Time Architecture\n\n```\n┌────────────────────────────────────────────────────────────┐\n│                 REAL-TIME COLLABORATION                     │\n├────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Client A ◄───────┐                    ┌───────► Client B   │\n│  (Browser)        │     WebSocket      │        (Browser)   │\n│                   │      Server        │                    │\n│                   └────────┬───────────┘                    │\n│                            │                                │\n│                     ┌──────▼──────┐                         │\n│                     │   Redis     │                         │\n│                     │   Pub/Sub   │                         │\n│                     └──────┬──────┘                         │\n│                            │                                │\n│              ┌─────────────┼─────────────┐                  │\n│              ▼             ▼             ▼                  │\n│         [Server 1]    [Server 2]    [Server N]              │\n│         (future horizontal scaling)                         │\n│                                                             │\n│  Event Types:                                               │\n│  • task:created    • task:moved      • task:deleted        │\n│  • board:updated   • member:joined   • comment:added       │\n└────────────────────────────────────────────────────────────┘\n```\n\n### API Design Principles\n\n1. **RESTful** for CRUD operations: `GET/POST/PUT/DELETE /api/v1/workspaces/:id/tasks`\n2. **WebSocket** for real-time: `ws://api/v1/boards/:id/subscribe`\n3. **Versioned APIs**: `/api/v1/` prefix for all endpoints\n4. **Consistent error format**: `{ error: { code, message, details } }`\n\n### Security Model\n\n| Concern | Solution |\n|---------|----------|\n| Authentication | Google OAuth 2.0 + JWT access tokens (15min) + Refresh tokens (7d) |\n| Authorization | RBAC (Owner, Admin, Member, Guest) per workspace |\n| Data Isolation | Workspace ID in JWT claims, enforced at middleware level |\n| Rate Limiting | Redis-based sliding window (100 req/min per user) |\n| Input Validation | Zod schemas for all API inputs |\n\n### Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA\n│   │   ├── src/\n│   │   │   ├── components/     # Shared UI components\n│   │   │   ├── features/       # Feature-based modules\n│   │   │   ├── hooks/          # Custom React hooks\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API server\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   │   ├── auth/\n│   │   │   │   ├── user/\n│   │   │   │   ├── workspace/\n│   │   │   │   ├── team/\n│   │   │   │   ├── taskboard/\n│   │   │   │   └── notification/\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   │   ├── database/\n│   │   │   │   ├── cache/\n│   │   │   │   ├── websocket/\n│   │   │   │   ├── events/\n│   │   │   │   └── logging/\n│   │   │   └── shared/         # Shared utilities\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types/utilities\n│       ├── src/\n│       │   ├── types/\n│       │   └── validation/\n│       └── package.json\n│\n├── .c3/                        # Architecture documentation\n├── docker-compose.yml          # Local development\n├── package.json                # Monorepo root\n└── turbo.json                  # Turborepo config\n```\n\n## Consequences\n\n### Positive\n- **Single deployable unit** simplifies DevOps and debugging\n- **Clear module boundaries** enable future microservice extraction\n- **Shared TypeScript** between frontend/backend reduces type mismatches\n- **Redis pub/sub** allows horizontal scaling of WebSocket servers\n- **Schema-based multi-tenancy** provides isolation without database sprawl\n\n### Negative\n- **Monolith coupling risk** if module boundaries aren't enforced\n- **Single point of failure** until horizontal scaling is implemented\n- **PostgreSQL schema management** adds complexity for tenant provisioning\n\n### Mitigations\n- Enforce module boundaries via eslint rules and import restrictions\n- Implement health checks and graceful degradation early\n- Automate schema provisioning in workspace creation flow\n\n## C3 Documentation Structure\n\nThis blueprint is implemented across the following C3 artifacts:\n\n| Artifact | Purpose |\n|----------|---------|\n| `c3-0-context.md` | System context - external actors and systems |\n| `c3-1-web.md` | React SPA container and components |\n| `c3-2-api.md` | Express API container and components |\n| `c3-3-database.md` | PostgreSQL schemas and data model |\n| `c3-4-cache.md` | Redis caching and pub/sub |\n| `components/*.md` | Detailed component specifications |\n| `refs/*.md` | Shared patterns and conventions |\n\n## References\n\n- [C4 Model](https://c4model.com/) - Architectural diagram methodology\n- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Architecture pattern\n- [Socket.io Redis Adapter](https://socket.io/docs/v4/redis-adapter/) - Scaling WebSockets\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:10:05.728Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/adrs/adr-000-system-blueprint.md",
        "content": "# ADR-000: TaskFlow System Blueprint\n\n## Status\n**Accepted** | 2026-01-12\n\n## Context\n\nTaskFlow is a task management SaaS application designed for small teams. The system needs to support:\n\n- **Real-time collaboration** on task boards with multiple simultaneous users\n- **Multi-tenant architecture** with team workspaces for data isolation\n- **Future mobile expansion** via a well-designed API layer\n- **Scalable growth path** from MVP to enterprise without major rewrites\n\n### Business Requirements\n1. Teams can create workspaces with isolated task boards\n2. Real-time updates when team members modify tasks\n3. Google OAuth for frictionless onboarding\n4. Responsive web interface with future native mobile apps\n\n### Technical Constraints\n1. Small team (2-4 developers initially)\n2. Need to ship MVP in 3 months\n3. Must support 100+ concurrent users per workspace\n4. Budget-conscious infrastructure (start small, scale as needed)\n\n## Decision\n\nWe adopt a **modular monolith architecture** with the following technology stack and architectural patterns:\n\n### Technology Stack\n\n| Layer | Technology | Rationale |\n|-------|------------|-----------|\n| Frontend | React SPA + TypeScript | Component reuse, strong typing, large ecosystem |\n| Backend | Node.js + Express + TypeScript | Full-stack TypeScript, async I/O for real-time |\n| Database | PostgreSQL | ACID compliance, JSON support, proven reliability |\n| Cache | Redis | Caching, session storage, pub/sub for real-time |\n| Real-time | WebSocket (Socket.io) | Bidirectional communication for live updates |\n| Auth | Google OAuth 2.0 + JWT | Zero-friction signup, stateless auth tokens |\n\n### Architectural Patterns\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        TASKFLOW SYSTEM                          │\n├─────────────────────────────────────────────────────────────────┤\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │\n│  │   React     │    │   Mobile    │    │   External          │  │\n│  │   SPA       │    │   Apps      │    │   Integrations      │  │\n│  │  (Web UI)   │    │  (Future)   │    │   (Webhooks)        │  │\n│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │\n│         │                  │                       │             │\n│         └──────────────────┼───────────────────────┘             │\n│                            ▼                                     │\n│  ┌─────────────────────────────────────────────────────────────┐ │\n│  │                     API GATEWAY                              │ │\n│  │    (Express + JWT Auth + Rate Limiting + Request Logging)   │ │\n│  └─────────────────────────┬───────────────────────────────────┘ │\n│                            │                                     │\n│  ┌─────────────────────────▼───────────────────────────────────┐ │\n│  │                  MODULAR MONOLITH                            │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │                 FEATURE MODULES                       │   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │    Auth    │ │ Workspace  │ │   Task Board       ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │   User     │ │   Team     │ │   Notification     ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │              FOUNDATION LAYER                         │   │ │\n│  │  │  Database │ Cache │ WebSocket │ Events │ Logging     │   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  └─────────────────────────────────────────────────────────────┘ │\n│                            │                                     │\n│         ┌──────────────────┼──────────────────┐                  │\n│         ▼                  ▼                  ▼                  │\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │\n│  │ PostgreSQL  │    │   Redis     │    │   Redis     │          │\n│  │  (Primary)  │    │  (Cache)    │    │  (Pub/Sub)  │          │\n│  └─────────────┘    └─────────────┘    └─────────────┘          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Module Boundaries (Modular Monolith)\n\nEach module encapsulates a business domain with clear boundaries:\n\n| Module | Responsibility | Public Interface |\n|--------|----------------|------------------|\n| **Auth** | OAuth flow, JWT tokens, sessions | `authenticate()`, `authorize()`, `refreshToken()` |\n| **User** | User profiles, preferences | `getUser()`, `updateProfile()`, `getUsersByTeam()` |\n| **Workspace** | Tenant isolation, workspace CRUD | `createWorkspace()`, `getWorkspace()`, `inviteMember()` |\n| **Team** | Team membership, roles, permissions | `addMember()`, `removeMember()`, `setRole()` |\n| **TaskBoard** | Boards, columns, tasks, comments | `createTask()`, `moveTask()`, `subscribeToBoard()` |\n| **Notification** | Email, in-app, push notifications | `notify()`, `getNotifications()`, `markRead()` |\n\n### Multi-Tenancy Strategy\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    TENANT ISOLATION                              │\n├─────────────────────────────────────────────────────────────────┤\n│  Strategy: Shared Database, Schema-based Isolation              │\n│                                                                  │\n│  ┌───────────────────────────────────────────────────────────┐  │\n│  │                   PostgreSQL Database                      │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │  │\n│  │  │  workspace_ │ │  workspace_ │ │  workspace_ │          │  │\n│  │  │  {uuid_1}   │ │  {uuid_2}   │ │  {uuid_n}   │          │  │\n│  │  │  ─────────  │ │  ─────────  │ │  ─────────  │          │  │\n│  │  │  tasks      │ │  tasks      │ │  tasks      │          │  │\n│  │  │  boards     │ │  boards     │ │  boards     │          │  │\n│  │  │  columns    │ │  columns    │ │  columns    │          │  │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘          │  │\n│  │                                                            │  │\n│  │  ┌─────────────────────────────────────────────────────┐  │  │\n│  │  │                  public schema                       │  │  │\n│  │  │  users │ workspaces │ team_memberships │ invites    │  │  │\n│  │  └─────────────────────────────────────────────────────┘  │  │\n│  └───────────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Real-Time Architecture\n\n```\n┌────────────────────────────────────────────────────────────┐\n│                 REAL-TIME COLLABORATION                     │\n├────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Client A ◄───────┐                    ┌───────► Client B   │\n│  (Browser)        │     WebSocket      │        (Browser)   │\n│                   │      Server        │                    │\n│                   └────────┬───────────┘                    │\n│                            │                                │\n│                     ┌──────▼──────┐                         │\n│                     │   Redis     │                         │\n│                     │   Pub/Sub   │                         │\n│                     └──────┬──────┘                         │\n│                            │                                │\n│              ┌─────────────┼─────────────┐                  │\n│              ▼             ▼             ▼                  │\n│         [Server 1]    [Server 2]    [Server N]              │\n│         (future horizontal scaling)                         │\n│                                                             │\n│  Event Types:                                               │\n│  • task:created    • task:moved      • task:deleted        │\n│  • board:updated   • member:joined   • comment:added       │\n└────────────────────────────────────────────────────────────┘\n```\n\n### API Design Principles\n\n1. **RESTful** for CRUD operations: `GET/POST/PUT/DELETE /api/v1/workspaces/:id/tasks`\n2. **WebSocket** for real-time: `ws://api/v1/boards/:id/subscribe`\n3. **Versioned APIs**: `/api/v1/` prefix for all endpoints\n4. **Consistent error format**: `{ error: { code, message, details } }`\n\n### Security Model\n\n| Concern | Solution |\n|---------|----------|\n| Authentication | Google OAuth 2.0 + JWT access tokens (15min) + Refresh tokens (7d) |\n| Authorization | RBAC (Owner, Admin, Member, Guest) per workspace |\n| Data Isolation | Workspace ID in JWT claims, enforced at middleware level |\n| Rate Limiting | Redis-based sliding window (100 req/min per user) |\n| Input Validation | Zod schemas for all API inputs |\n\n### Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA\n│   │   ├── src/\n│   │   │   ├── components/     # Shared UI components\n│   │   │   ├── features/       # Feature-based modules\n│   │   │   ├── hooks/          # Custom React hooks\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API server\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   │   ├── auth/\n│   │   │   │   ├── user/\n│   │   │   │   ├── workspace/\n│   │   │   │   ├── team/\n│   │   │   │   ├── taskboard/\n│   │   │   │   └── notification/\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   │   ├── database/\n│   │   │   │   ├── cache/\n│   │   │   │   ├── websocket/\n│   │   │   │   ├── events/\n│   │   │   │   └── logging/\n│   │   │   └── shared/         # Shared utilities\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types/utilities\n│       ├── src/\n│       │   ├── types/\n│       │   └── validation/\n│       └── package.json\n│\n├── .c3/                        # Architecture documentation\n├── docker-compose.yml          # Local development\n├── package.json                # Monorepo root\n└── turbo.json                  # Turborepo config\n```\n\n## Consequences\n\n### Positive\n- **Single deployable unit** simplifies DevOps and debugging\n- **Clear module boundaries** enable future microservice extraction\n- **Shared TypeScript** between frontend/backend reduces type mismatches\n- **Redis pub/sub** allows horizontal scaling of WebSocket servers\n- **Schema-based multi-tenancy** provides isolation without database sprawl\n\n### Negative\n- **Monolith coupling risk** if module boundaries aren't enforced\n- **Single point of failure** until horizontal scaling is implemented\n- **PostgreSQL schema management** adds complexity for tenant provisioning\n\n### Mitigations\n- Enforce module boundaries via eslint rules and import restrictions\n- Implement health checks and graceful degradation early\n- Automate schema provisioning in workspace creation flow\n\n## C3 Documentation Structure\n\nThis blueprint is implemented across the following C3 artifacts:\n\n| Artifact | Purpose |\n|----------|---------|\n| `c3-0-context.md` | System context - external actors and systems |\n| `c3-1-web.md` | React SPA container and components |\n| `c3-2-api.md` | Express API container and components |\n| `c3-3-database.md` | PostgreSQL schemas and data model |\n| `c3-4-cache.md` | Redis caching and pub/sub |\n| `components/*.md` | Detailed component specifications |\n| `refs/*.md` | Shared patterns and conventions |\n\n## References\n\n- [C4 Model](https://c4model.com/) - Architectural diagram methodology\n- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Architecture pattern\n- [Socket.io Redis Adapter](https://socket.io/docs/v4/redis-adapter/) - Scaling WebSockets\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/adrs/adr-000-system-blueprint.md",
        "content": "# ADR-000: TaskFlow System Blueprint\n\n## Status\n**Accepted** | 2026-01-12\n\n## Context\n\nTaskFlow is a task management SaaS application designed for small teams. The system needs to support:\n\n- **Real-time collaboration** on task boards with multiple simultaneous users\n- **Multi-tenant architecture** with team workspaces for data isolation\n- **Future mobile expansion** via a well-designed API layer\n- **Scalable growth path** from MVP to enterprise without major rewrites\n\n### Business Requirements\n1. Teams can create workspaces with isolated task boards\n2. Real-time updates when team members modify tasks\n3. Google OAuth for frictionless onboarding\n4. Responsive web interface with future native mobile apps\n\n### Technical Constraints\n1. Small team (2-4 developers initially)\n2. Need to ship MVP in 3 months\n3. Must support 100+ concurrent users per workspace\n4. Budget-conscious infrastructure (start small, scale as needed)\n\n## Decision\n\nWe adopt a **modular monolith architecture** with the following technology stack and architectural patterns:\n\n### Technology Stack\n\n| Layer | Technology | Rationale |\n|-------|------------|-----------|\n| Frontend | React SPA + TypeScript | Component reuse, strong typing, large ecosystem |\n| Backend | Node.js + Express + TypeScript | Full-stack TypeScript, async I/O for real-time |\n| Database | PostgreSQL | ACID compliance, JSON support, proven reliability |\n| Cache | Redis | Caching, session storage, pub/sub for real-time |\n| Real-time | WebSocket (Socket.io) | Bidirectional communication for live updates |\n| Auth | Google OAuth 2.0 + JWT | Zero-friction signup, stateless auth tokens |\n\n### Architectural Patterns\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        TASKFLOW SYSTEM                          │\n├─────────────────────────────────────────────────────────────────┤\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐  │\n│  │   React     │    │   Mobile    │    │   External          │  │\n│  │   SPA       │    │   Apps      │    │   Integrations      │  │\n│  │  (Web UI)   │    │  (Future)   │    │   (Webhooks)        │  │\n│  └──────┬──────┘    └──────┬──────┘    └──────────┬──────────┘  │\n│         │                  │                       │             │\n│         └──────────────────┼───────────────────────┘             │\n│                            ▼                                     │\n│  ┌─────────────────────────────────────────────────────────────┐ │\n│  │                     API GATEWAY                              │ │\n│  │    (Express + JWT Auth + Rate Limiting + Request Logging)   │ │\n│  └─────────────────────────┬───────────────────────────────────┘ │\n│                            │                                     │\n│  ┌─────────────────────────▼───────────────────────────────────┐ │\n│  │                  MODULAR MONOLITH                            │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │                 FEATURE MODULES                       │   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │    Auth    │ │ Workspace  │ │   Task Board       ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────────────┐│   │ │\n│  │  │  │   User     │ │   Team     │ │   Notification     ││   │ │\n│  │  │  │   Module   │ │   Module   │ │     Module         ││   │ │\n│  │  │  └────────────┘ └────────────┘ └────────────────────┘│   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  │  ┌──────────────────────────────────────────────────────┐   │ │\n│  │  │              FOUNDATION LAYER                         │   │ │\n│  │  │  Database │ Cache │ WebSocket │ Events │ Logging     │   │ │\n│  │  └──────────────────────────────────────────────────────┘   │ │\n│  └─────────────────────────────────────────────────────────────┘ │\n│                            │                                     │\n│         ┌──────────────────┼──────────────────┐                  │\n│         ▼                  ▼                  ▼                  │\n│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │\n│  │ PostgreSQL  │    │   Redis     │    │   Redis     │          │\n│  │  (Primary)  │    │  (Cache)    │    │  (Pub/Sub)  │          │\n│  └─────────────┘    └─────────────┘    └─────────────┘          │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Module Boundaries (Modular Monolith)\n\nEach module encapsulates a business domain with clear boundaries:\n\n| Module | Responsibility | Public Interface |\n|--------|----------------|------------------|\n| **Auth** | OAuth flow, JWT tokens, sessions | `authenticate()`, `authorize()`, `refreshToken()` |\n| **User** | User profiles, preferences | `getUser()`, `updateProfile()`, `getUsersByTeam()` |\n| **Workspace** | Tenant isolation, workspace CRUD | `createWorkspace()`, `getWorkspace()`, `inviteMember()` |\n| **Team** | Team membership, roles, permissions | `addMember()`, `removeMember()`, `setRole()` |\n| **TaskBoard** | Boards, columns, tasks, comments | `createTask()`, `moveTask()`, `subscribeToBoard()` |\n| **Notification** | Email, in-app, push notifications | `notify()`, `getNotifications()`, `markRead()` |\n\n### Multi-Tenancy Strategy\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                    TENANT ISOLATION                              │\n├─────────────────────────────────────────────────────────────────┤\n│  Strategy: Shared Database, Schema-based Isolation              │\n│                                                                  │\n│  ┌───────────────────────────────────────────────────────────┐  │\n│  │                   PostgreSQL Database                      │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │  │\n│  │  │  workspace_ │ │  workspace_ │ │  workspace_ │          │  │\n│  │  │  {uuid_1}   │ │  {uuid_2}   │ │  {uuid_n}   │          │  │\n│  │  │  ─────────  │ │  ─────────  │ │  ─────────  │          │  │\n│  │  │  tasks      │ │  tasks      │ │  tasks      │          │  │\n│  │  │  boards     │ │  boards     │ │  boards     │          │  │\n│  │  │  columns    │ │  columns    │ │  columns    │          │  │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘          │  │\n│  │                                                            │  │\n│  │  ┌─────────────────────────────────────────────────────┐  │  │\n│  │  │                  public schema                       │  │  │\n│  │  │  users │ workspaces │ team_memberships │ invites    │  │  │\n│  │  └─────────────────────────────────────────────────────┘  │  │\n│  └───────────────────────────────────────────────────────────┘  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### Real-Time Architecture\n\n```\n┌────────────────────────────────────────────────────────────┐\n│                 REAL-TIME COLLABORATION                     │\n├────────────────────────────────────────────────────────────┤\n│                                                             │\n│  Client A ◄───────┐                    ┌───────► Client B   │\n│  (Browser)        │     WebSocket      │        (Browser)   │\n│                   │      Server        │                    │\n│                   └────────┬───────────┘                    │\n│                            │                                │\n│                     ┌──────▼──────┐                         │\n│                     │   Redis     │                         │\n│                     │   Pub/Sub   │                         │\n│                     └──────┬──────┘                         │\n│                            │                                │\n│              ┌─────────────┼─────────────┐                  │\n│              ▼             ▼             ▼                  │\n│         [Server 1]    [Server 2]    [Server N]              │\n│         (future horizontal scaling)                         │\n│                                                             │\n│  Event Types:                                               │\n│  • task:created    • task:moved      • task:deleted        │\n│  • board:updated   • member:joined   • comment:added       │\n└────────────────────────────────────────────────────────────┘\n```\n\n### API Design Principles\n\n1. **RESTful** for CRUD operations: `GET/POST/PUT/DELETE /api/v1/workspaces/:id/tasks`\n2. **WebSocket** for real-time: `ws://api/v1/boards/:id/subscribe`\n3. **Versioned APIs**: `/api/v1/` prefix for all endpoints\n4. **Consistent error format**: `{ error: { code, message, details } }`\n\n### Security Model\n\n| Concern | Solution |\n|---------|----------|\n| Authentication | Google OAuth 2.0 + JWT access tokens (15min) + Refresh tokens (7d) |\n| Authorization | RBAC (Owner, Admin, Member, Guest) per workspace |\n| Data Isolation | Workspace ID in JWT claims, enforced at middleware level |\n| Rate Limiting | Redis-based sliding window (100 req/min per user) |\n| Input Validation | Zod schemas for all API inputs |\n\n### Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA\n│   │   ├── src/\n│   │   │   ├── components/     # Shared UI components\n│   │   │   ├── features/       # Feature-based modules\n│   │   │   ├── hooks/          # Custom React hooks\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API server\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   │   ├── auth/\n│   │   │   │   ├── user/\n│   │   │   │   ├── workspace/\n│   │   │   │   ├── team/\n│   │   │   │   ├── taskboard/\n│   │   │   │   └── notification/\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   │   ├── database/\n│   │   │   │   ├── cache/\n│   │   │   │   ├── websocket/\n│   │   │   │   ├── events/\n│   │   │   │   └── logging/\n│   │   │   └── shared/         # Shared utilities\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types/utilities\n│       ├── src/\n│       │   ├── types/\n│       │   └── validation/\n│       └── package.json\n│\n├── .c3/                        # Architecture documentation\n├── docker-compose.yml          # Local development\n├── package.json                # Monorepo root\n└── turbo.json                  # Turborepo config\n```\n\n## Consequences\n\n### Positive\n- **Single deployable unit** simplifies DevOps and debugging\n- **Clear module boundaries** enable future microservice extraction\n- **Shared TypeScript** between frontend/backend reduces type mismatches\n- **Redis pub/sub** allows horizontal scaling of WebSocket servers\n- **Schema-based multi-tenancy** provides isolation without database sprawl\n\n### Negative\n- **Monolith coupling risk** if module boundaries aren't enforced\n- **Single point of failure** until horizontal scaling is implemented\n- **PostgreSQL schema management** adds complexity for tenant provisioning\n\n### Mitigations\n- Enforce module boundaries via eslint rules and import restrictions\n- Implement health checks and graceful degradation early\n- Automate schema provisioning in workspace creation flow\n\n## C3 Documentation Structure\n\nThis blueprint is implemented across the following C3 artifacts:\n\n| Artifact | Purpose |\n|----------|---------|\n| `c3-0-context.md` | System context - external actors and systems |\n| `c3-1-web.md` | React SPA container and components |\n| `c3-2-api.md` | Express API container and components |\n| `c3-3-database.md` | PostgreSQL schemas and data model |\n| `c3-4-cache.md` | Redis caching and pub/sub |\n| `components/*.md` | Detailed component specifications |\n| `refs/*.md` | Shared patterns and conventions |\n\n## References\n\n- [C4 Model](https://c4model.com/) - Architectural diagram methodology\n- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Architecture pattern\n- [Socket.io Redis Adapter](https://socket.io/docs/v4/redis-adapter/) - Scaling WebSockets\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:10:11.970Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "in_progress",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:10:11.977Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "in_progress",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "in_progress",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "pending",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "in_progress",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:10:40.863Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-0-context.md",
        "content": "# c3-0: TaskFlow System Context\n\n> **Level**: Context | **Type**: System | **ADR**: [adr-000](adrs/adr-000-system-blueprint.md)\n\n## Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on task boards within isolated team workspaces.\n\n## System Context Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                            SYSTEM CONTEXT                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│    ┌──────────────┐                              ┌──────────────┐       │\n│    │  Team Member │                              │  Team Admin  │       │\n│    │   (Person)   │                              │   (Person)   │       │\n│    └──────┬───────┘                              └──────┬───────┘       │\n│           │ Uses                                        │ Manages       │\n│           │                                             │               │\n│           └─────────────────┬───────────────────────────┘               │\n│                             │                                            │\n│                             ▼                                            │\n│           ┌─────────────────────────────────────┐                       │\n│           │                                     │                       │\n│           │         TASKFLOW SYSTEM             │                       │\n│           │    [c3-0: Task Management SaaS]     │                       │\n│           │                                     │                       │\n│           │   Enables teams to collaborate on   │                       │\n│           │   task boards in real-time within   │                       │\n│           │   isolated workspaces               │                       │\n│           │                                     │                       │\n│           └──────────────────┬──────────────────┘                       │\n│                              │                                           │\n│        ┌─────────────────────┼─────────────────────┐                    │\n│        │                     │                     │                    │\n│        ▼                     ▼                     ▼                    │\n│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐             │\n│  │    Google     │   │    Email      │   │   Webhook     │             │\n│  │    OAuth      │   │   Service     │   │  Consumers    │             │\n│  │  (External)   │   │  (External)   │   │  (External)   │             │\n│  │               │   │               │   │               │             │\n│  │ Authenticates │   │ Sends email   │   │ Receives      │             │\n│  │ users via     │   │ notifications │   │ event         │             │\n│  │ Google SSO    │   │ (invites,     │   │ notifications │             │\n│  │               │   │  alerts)      │   │               │             │\n│  └───────────────┘   └───────────────┘   └───────────────┘             │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Actors\n\n| Actor | Type | Description |\n|-------|------|-------------|\n| **Team Member** | Person | Creates and manages tasks, collaborates on boards, receives notifications |\n| **Team Admin** | Person | Manages workspace settings, invites members, configures integrations |\n| **Workspace Owner** | Person | Full control including billing, workspace deletion, admin management |\n\n## External Systems\n\n| System | Type | Integration | Purpose |\n|--------|------|-------------|---------|\n| **Google OAuth** | Identity Provider | OAuth 2.0 | User authentication and identity verification |\n| **Email Service** | Communication | SMTP/API | Transactional emails (invites, notifications, password reset) |\n| **Webhook Consumers** | Integration | HTTP POST | External systems receiving TaskFlow events |\n\n## System Boundaries\n\n### Included in TaskFlow\n- User authentication and session management\n- Workspace and team management\n- Task boards with real-time collaboration\n- In-app notifications\n- User preferences and profiles\n\n### Excluded (External Dependencies)\n- User identity storage (delegated to Google)\n- Email delivery infrastructure\n- Payment processing (future consideration)\n- File storage for attachments (future consideration)\n\n## Key Interactions\n\n```\nTeam Member → TaskFlow\n  • Sign in with Google\n  • Create/edit/move tasks\n  • Comment on tasks\n  • Receive real-time updates\n\nTeam Admin → TaskFlow\n  • Invite team members\n  • Manage roles and permissions\n  • Configure workspace settings\n\nTaskFlow → Google OAuth\n  • Redirect for authentication\n  • Exchange authorization code for tokens\n  • Fetch user profile information\n\nTaskFlow → Email Service\n  • Send workspace invitations\n  • Notify on task assignments\n  • Alert on mentions and comments\n\nTaskFlow → Webhook Consumers\n  • POST task events (created, updated, completed)\n  • POST board events (column changes)\n```\n\n## Containers\n\nThis system is decomposed into the following containers:\n\n| Container | ID | Description |\n|-----------|-----|-------------|\n| [Web Application](c3-1-web.md) | c3-1 | React SPA providing the user interface |\n| [API Server](c3-2-api.md) | c3-2 | Express.js backend with REST + WebSocket |\n| [Database](c3-3-database.md) | c3-3 | PostgreSQL for persistent data storage |\n| [Cache](c3-4-cache.md) | c3-4 | Redis for caching and real-time pub/sub |\n\n## Quality Attributes\n\n| Attribute | Target | Rationale |\n|-----------|--------|-----------|\n| **Availability** | 99.9% uptime | Small teams rely on TaskFlow for daily work |\n| **Latency** | < 200ms API response | Real-time feel for task operations |\n| **Scalability** | 100+ concurrent users/workspace | Support active team collaboration |\n| **Security** | SOC 2 Type II (future) | Enterprise customers require compliance |\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:10:40.886Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-0-context.md",
        "content": "# c3-0: TaskFlow System Context\n\n> **Level**: Context | **Type**: System | **ADR**: [adr-000](adrs/adr-000-system-blueprint.md)\n\n## Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on task boards within isolated team workspaces.\n\n## System Context Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                            SYSTEM CONTEXT                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│    ┌──────────────┐                              ┌──────────────┐       │\n│    │  Team Member │                              │  Team Admin  │       │\n│    │   (Person)   │                              │   (Person)   │       │\n│    └──────┬───────┘                              └──────┬───────┘       │\n│           │ Uses                                        │ Manages       │\n│           │                                             │               │\n│           └─────────────────┬───────────────────────────┘               │\n│                             │                                            │\n│                             ▼                                            │\n│           ┌─────────────────────────────────────┐                       │\n│           │                                     │                       │\n│           │         TASKFLOW SYSTEM             │                       │\n│           │    [c3-0: Task Management SaaS]     │                       │\n│           │                                     │                       │\n│           │   Enables teams to collaborate on   │                       │\n│           │   task boards in real-time within   │                       │\n│           │   isolated workspaces               │                       │\n│           │                                     │                       │\n│           └──────────────────┬──────────────────┘                       │\n│                              │                                           │\n│        ┌─────────────────────┼─────────────────────┐                    │\n│        │                     │                     │                    │\n│        ▼                     ▼                     ▼                    │\n│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐             │\n│  │    Google     │   │    Email      │   │   Webhook     │             │\n│  │    OAuth      │   │   Service     │   │  Consumers    │             │\n│  │  (External)   │   │  (External)   │   │  (External)   │             │\n│  │               │   │               │   │               │             │\n│  │ Authenticates │   │ Sends email   │   │ Receives      │             │\n│  │ users via     │   │ notifications │   │ event         │             │\n│  │ Google SSO    │   │ (invites,     │   │ notifications │             │\n│  │               │   │  alerts)      │   │               │             │\n│  └───────────────┘   └───────────────┘   └───────────────┘             │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Actors\n\n| Actor | Type | Description |\n|-------|------|-------------|\n| **Team Member** | Person | Creates and manages tasks, collaborates on boards, receives notifications |\n| **Team Admin** | Person | Manages workspace settings, invites members, configures integrations |\n| **Workspace Owner** | Person | Full control including billing, workspace deletion, admin management |\n\n## External Systems\n\n| System | Type | Integration | Purpose |\n|--------|------|-------------|---------|\n| **Google OAuth** | Identity Provider | OAuth 2.0 | User authentication and identity verification |\n| **Email Service** | Communication | SMTP/API | Transactional emails (invites, notifications, password reset) |\n| **Webhook Consumers** | Integration | HTTP POST | External systems receiving TaskFlow events |\n\n## System Boundaries\n\n### Included in TaskFlow\n- User authentication and session management\n- Workspace and team management\n- Task boards with real-time collaboration\n- In-app notifications\n- User preferences and profiles\n\n### Excluded (External Dependencies)\n- User identity storage (delegated to Google)\n- Email delivery infrastructure\n- Payment processing (future consideration)\n- File storage for attachments (future consideration)\n\n## Key Interactions\n\n```\nTeam Member → TaskFlow\n  • Sign in with Google\n  • Create/edit/move tasks\n  • Comment on tasks\n  • Receive real-time updates\n\nTeam Admin → TaskFlow\n  • Invite team members\n  • Manage roles and permissions\n  • Configure workspace settings\n\nTaskFlow → Google OAuth\n  • Redirect for authentication\n  • Exchange authorization code for tokens\n  • Fetch user profile information\n\nTaskFlow → Email Service\n  • Send workspace invitations\n  • Notify on task assignments\n  • Alert on mentions and comments\n\nTaskFlow → Webhook Consumers\n  • POST task events (created, updated, completed)\n  • POST board events (column changes)\n```\n\n## Containers\n\nThis system is decomposed into the following containers:\n\n| Container | ID | Description |\n|-----------|-----|-------------|\n| [Web Application](c3-1-web.md) | c3-1 | React SPA providing the user interface |\n| [API Server](c3-2-api.md) | c3-2 | Express.js backend with REST + WebSocket |\n| [Database](c3-3-database.md) | c3-3 | PostgreSQL for persistent data storage |\n| [Cache](c3-4-cache.md) | c3-4 | Redis for caching and real-time pub/sub |\n\n## Quality Attributes\n\n| Attribute | Target | Rationale |\n|-----------|--------|-----------|\n| **Availability** | 99.9% uptime | Small teams rely on TaskFlow for daily work |\n| **Latency** | < 200ms API response | Real-time feel for task operations |\n| **Scalability** | 100+ concurrent users/workspace | Support active team collaboration |\n| **Security** | SOC 2 Type II (future) | Enterprise customers require compliance |\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/c3-0-context.md",
        "content": "# c3-0: TaskFlow System Context\n\n> **Level**: Context | **Type**: System | **ADR**: [adr-000](adrs/adr-000-system-blueprint.md)\n\n## Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on task boards within isolated team workspaces.\n\n## System Context Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                            SYSTEM CONTEXT                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│    ┌──────────────┐                              ┌──────────────┐       │\n│    │  Team Member │                              │  Team Admin  │       │\n│    │   (Person)   │                              │   (Person)   │       │\n│    └──────┬───────┘                              └──────┬───────┘       │\n│           │ Uses                                        │ Manages       │\n│           │                                             │               │\n│           └─────────────────┬───────────────────────────┘               │\n│                             │                                            │\n│                             ▼                                            │\n│           ┌─────────────────────────────────────┐                       │\n│           │                                     │                       │\n│           │         TASKFLOW SYSTEM             │                       │\n│           │    [c3-0: Task Management SaaS]     │                       │\n│           │                                     │                       │\n│           │   Enables teams to collaborate on   │                       │\n│           │   task boards in real-time within   │                       │\n│           │   isolated workspaces               │                       │\n│           │                                     │                       │\n│           └──────────────────┬──────────────────┘                       │\n│                              │                                           │\n│        ┌─────────────────────┼─────────────────────┐                    │\n│        │                     │                     │                    │\n│        ▼                     ▼                     ▼                    │\n│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐             │\n│  │    Google     │   │    Email      │   │   Webhook     │             │\n│  │    OAuth      │   │   Service     │   │  Consumers    │             │\n│  │  (External)   │   │  (External)   │   │  (External)   │             │\n│  │               │   │               │   │               │             │\n│  │ Authenticates │   │ Sends email   │   │ Receives      │             │\n│  │ users via     │   │ notifications │   │ event         │             │\n│  │ Google SSO    │   │ (invites,     │   │ notifications │             │\n│  │               │   │  alerts)      │   │               │             │\n│  └───────────────┘   └───────────────┘   └───────────────┘             │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Actors\n\n| Actor | Type | Description |\n|-------|------|-------------|\n| **Team Member** | Person | Creates and manages tasks, collaborates on boards, receives notifications |\n| **Team Admin** | Person | Manages workspace settings, invites members, configures integrations |\n| **Workspace Owner** | Person | Full control including billing, workspace deletion, admin management |\n\n## External Systems\n\n| System | Type | Integration | Purpose |\n|--------|------|-------------|---------|\n| **Google OAuth** | Identity Provider | OAuth 2.0 | User authentication and identity verification |\n| **Email Service** | Communication | SMTP/API | Transactional emails (invites, notifications, password reset) |\n| **Webhook Consumers** | Integration | HTTP POST | External systems receiving TaskFlow events |\n\n## System Boundaries\n\n### Included in TaskFlow\n- User authentication and session management\n- Workspace and team management\n- Task boards with real-time collaboration\n- In-app notifications\n- User preferences and profiles\n\n### Excluded (External Dependencies)\n- User identity storage (delegated to Google)\n- Email delivery infrastructure\n- Payment processing (future consideration)\n- File storage for attachments (future consideration)\n\n## Key Interactions\n\n```\nTeam Member → TaskFlow\n  • Sign in with Google\n  • Create/edit/move tasks\n  • Comment on tasks\n  • Receive real-time updates\n\nTeam Admin → TaskFlow\n  • Invite team members\n  • Manage roles and permissions\n  • Configure workspace settings\n\nTaskFlow → Google OAuth\n  • Redirect for authentication\n  • Exchange authorization code for tokens\n  • Fetch user profile information\n\nTaskFlow → Email Service\n  • Send workspace invitations\n  • Notify on task assignments\n  • Alert on mentions and comments\n\nTaskFlow → Webhook Consumers\n  • POST task events (created, updated, completed)\n  • POST board events (column changes)\n```\n\n## Containers\n\nThis system is decomposed into the following containers:\n\n| Container | ID | Description |\n|-----------|-----|-------------|\n| [Web Application](c3-1-web.md) | c3-1 | React SPA providing the user interface |\n| [API Server](c3-2-api.md) | c3-2 | Express.js backend with REST + WebSocket |\n| [Database](c3-3-database.md) | c3-3 | PostgreSQL for persistent data storage |\n| [Cache](c3-4-cache.md) | c3-4 | Redis for caching and real-time pub/sub |\n\n## Quality Attributes\n\n| Attribute | Target | Rationale |\n|-----------|--------|-----------|\n| **Availability** | 99.9% uptime | Small teams rely on TaskFlow for daily work |\n| **Latency** | < 200ms API response | Real-time feel for task operations |\n| **Scalability** | 100+ concurrent users/workspace | Support active team collaboration |\n| **Security** | SOC 2 Type II (future) | Enterprise customers require compliance |\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:10:46.024Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "in_progress",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:10:46.030Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "in_progress",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "in_progress",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "pending",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "in_progress",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:11:18.968Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-1-web.md",
        "content": "# c3-1: Web Application (React SPA)\n\n> **Level**: Container | **Type**: Frontend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nSingle-page React application providing the TaskFlow user interface. Built with TypeScript for type safety and Vite for fast development experience.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        WEB APPLICATION [c3-1]                            │\n│                    React SPA + TypeScript + Vite                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                         PRESENTATION LAYER                          │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   Layout    │ │  Dashboard  │ │  TaskBoard  │ │  Settings   │  │ │\n│  │  │   Shell     │ │    Page     │ │    Page     │ │    Page     │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         FEATURE MODULES                             │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │  Workspace  │ │    Board    │ │   Profile   │  │ │\n│  │  │  Features   │ │  Features   │ │  Features   │ │  Features   │  │ │\n│  │  │  [c3-1.1]   │ │  [c3-1.2]   │ │  [c3-1.3]   │ │  [c3-1.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         SHARED LAYER                                │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │     UI      │ │   Hooks     │ │   State     │ │    API      │  │ │\n│  │  │ Components  │ │   Library   │ │   Store     │ │   Client    │  │ │\n│  │  │  [c3-1.5]   │ │  [c3-1.6]   │ │  [c3-1.7]   │ │  [c3-1.8]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└────────────────────────────────────────┬────────────────────────────────┘\n                                         │\n                           ┌─────────────┴─────────────┐\n                           │                           │\n                           ▼                           ▼\n                  ┌─────────────────┐        ┌─────────────────┐\n                  │   REST API      │        │   WebSocket     │\n                  │   [c3-2]        │        │   [c3-2]        │\n                  └─────────────────┘        └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| React | 18.x | UI framework |\n| TypeScript | 5.x | Type safety |\n| Vite | 5.x | Build tool and dev server |\n| TanStack Query | 5.x | Server state management |\n| Zustand | 4.x | Client state management |\n| React Router | 6.x | Client-side routing |\n| Socket.io Client | 4.x | Real-time communication |\n| Tailwind CSS | 3.x | Styling |\n| Radix UI | Latest | Accessible UI primitives |\n\n## Components\n\n### Feature Modules\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [Auth Features](components/c3-1.1-auth-features.md) | c3-1.1 | Login, OAuth callback, session management | `src/features/auth/` |\n| [Workspace Features](components/c3-1.2-workspace-features.md) | c3-1.2 | Workspace selection, creation, settings | `src/features/workspace/` |\n| [Board Features](components/c3-1.3-board-features.md) | c3-1.3 | Task board UI, drag-drop, real-time sync | `src/features/board/` |\n| [Profile Features](components/c3-1.4-profile-features.md) | c3-1.4 | User profile, preferences, notifications | `src/features/profile/` |\n\n### Shared Layer\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [UI Components](components/c3-1.5-ui-components.md) | c3-1.5 | Design system, buttons, forms, modals | `src/components/` |\n| [Hooks Library](components/c3-1.6-hooks.md) | c3-1.6 | Custom React hooks for common patterns | `src/hooks/` |\n| [State Store](components/c3-1.7-state.md) | c3-1.7 | Zustand stores for client state | `src/store/` |\n| [API Client](components/c3-1.8-api-client.md) | c3-1.8 | HTTP + WebSocket client configuration | `src/lib/api/` |\n\n## Directory Structure\n\n```\npackages/web/\n├── src/\n│   ├── features/              # Feature modules\n│   │   ├── auth/\n│   │   │   ├── components/    # Feature-specific components\n│   │   │   ├── hooks/         # Feature-specific hooks\n│   │   │   ├── api/           # API calls for this feature\n│   │   │   └── index.ts       # Public exports\n│   │   ├── workspace/\n│   │   ├── board/\n│   │   └── profile/\n│   ├── components/            # Shared UI components\n│   │   ├── ui/                # Primitives (Button, Input, etc.)\n│   │   └── layout/            # Layout components\n│   ├── hooks/                 # Shared hooks\n│   ├── store/                 # Zustand stores\n│   ├── lib/                   # Utilities\n│   │   ├── api/               # API client\n│   │   └── utils/             # Helper functions\n│   ├── types/                 # TypeScript types\n│   ├── App.tsx\n│   └── main.tsx\n├── public/\n├── index.html\n├── vite.config.ts\n├── tailwind.config.ts\n└── package.json\n```\n\n## Key Interactions\n\n### Authentication Flow\n```\nUser clicks \"Sign in with Google\"\n  → Auth Feature initiates OAuth redirect\n  → Google authenticates user\n  → Callback received at /auth/callback\n  → API Client exchanges code for JWT\n  → State Store saves tokens\n  → Router redirects to dashboard\n```\n\n### Real-Time Task Updates\n```\nUser opens task board\n  → Board Feature subscribes via WebSocket\n  → API Client joins board room\n  → Server pushes task updates\n  → State Store updates task data\n  → React re-renders affected components\n```\n\n## State Management Strategy\n\n| State Type | Solution | Examples |\n|------------|----------|----------|\n| Server State | TanStack Query | Tasks, boards, users |\n| Client State | Zustand | UI preferences, modal state |\n| URL State | React Router | Current board, filters |\n| Form State | React Hook Form | Task creation, settings |\n\n## Performance Considerations\n\n- **Code splitting**: Lazy load feature modules\n- **Optimistic updates**: Update UI before API confirmation\n- **Virtual scrolling**: For boards with many tasks\n- **Image optimization**: Lazy load avatars and attachments\n- **Bundle size**: Monitor with Vite's built-in analyzer\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:11:18.982Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-1-web.md",
        "content": "# c3-1: Web Application (React SPA)\n\n> **Level**: Container | **Type**: Frontend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nSingle-page React application providing the TaskFlow user interface. Built with TypeScript for type safety and Vite for fast development experience.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        WEB APPLICATION [c3-1]                            │\n│                    React SPA + TypeScript + Vite                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                         PRESENTATION LAYER                          │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   Layout    │ │  Dashboard  │ │  TaskBoard  │ │  Settings   │  │ │\n│  │  │   Shell     │ │    Page     │ │    Page     │ │    Page     │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         FEATURE MODULES                             │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │  Workspace  │ │    Board    │ │   Profile   │  │ │\n│  │  │  Features   │ │  Features   │ │  Features   │ │  Features   │  │ │\n│  │  │  [c3-1.1]   │ │  [c3-1.2]   │ │  [c3-1.3]   │ │  [c3-1.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         SHARED LAYER                                │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │     UI      │ │   Hooks     │ │   State     │ │    API      │  │ │\n│  │  │ Components  │ │   Library   │ │   Store     │ │   Client    │  │ │\n│  │  │  [c3-1.5]   │ │  [c3-1.6]   │ │  [c3-1.7]   │ │  [c3-1.8]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└────────────────────────────────────────┬────────────────────────────────┘\n                                         │\n                           ┌─────────────┴─────────────┐\n                           │                           │\n                           ▼                           ▼\n                  ┌─────────────────┐        ┌─────────────────┐\n                  │   REST API      │        │   WebSocket     │\n                  │   [c3-2]        │        │   [c3-2]        │\n                  └─────────────────┘        └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| React | 18.x | UI framework |\n| TypeScript | 5.x | Type safety |\n| Vite | 5.x | Build tool and dev server |\n| TanStack Query | 5.x | Server state management |\n| Zustand | 4.x | Client state management |\n| React Router | 6.x | Client-side routing |\n| Socket.io Client | 4.x | Real-time communication |\n| Tailwind CSS | 3.x | Styling |\n| Radix UI | Latest | Accessible UI primitives |\n\n## Components\n\n### Feature Modules\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [Auth Features](components/c3-1.1-auth-features.md) | c3-1.1 | Login, OAuth callback, session management | `src/features/auth/` |\n| [Workspace Features](components/c3-1.2-workspace-features.md) | c3-1.2 | Workspace selection, creation, settings | `src/features/workspace/` |\n| [Board Features](components/c3-1.3-board-features.md) | c3-1.3 | Task board UI, drag-drop, real-time sync | `src/features/board/` |\n| [Profile Features](components/c3-1.4-profile-features.md) | c3-1.4 | User profile, preferences, notifications | `src/features/profile/` |\n\n### Shared Layer\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [UI Components](components/c3-1.5-ui-components.md) | c3-1.5 | Design system, buttons, forms, modals | `src/components/` |\n| [Hooks Library](components/c3-1.6-hooks.md) | c3-1.6 | Custom React hooks for common patterns | `src/hooks/` |\n| [State Store](components/c3-1.7-state.md) | c3-1.7 | Zustand stores for client state | `src/store/` |\n| [API Client](components/c3-1.8-api-client.md) | c3-1.8 | HTTP + WebSocket client configuration | `src/lib/api/` |\n\n## Directory Structure\n\n```\npackages/web/\n├── src/\n│   ├── features/              # Feature modules\n│   │   ├── auth/\n│   │   │   ├── components/    # Feature-specific components\n│   │   │   ├── hooks/         # Feature-specific hooks\n│   │   │   ├── api/           # API calls for this feature\n│   │   │   └── index.ts       # Public exports\n│   │   ├── workspace/\n│   │   ├── board/\n│   │   └── profile/\n│   ├── components/            # Shared UI components\n│   │   ├── ui/                # Primitives (Button, Input, etc.)\n│   │   └── layout/            # Layout components\n│   ├── hooks/                 # Shared hooks\n│   ├── store/                 # Zustand stores\n│   ├── lib/                   # Utilities\n│   │   ├── api/               # API client\n│   │   └── utils/             # Helper functions\n│   ├── types/                 # TypeScript types\n│   ├── App.tsx\n│   └── main.tsx\n├── public/\n├── index.html\n├── vite.config.ts\n├── tailwind.config.ts\n└── package.json\n```\n\n## Key Interactions\n\n### Authentication Flow\n```\nUser clicks \"Sign in with Google\"\n  → Auth Feature initiates OAuth redirect\n  → Google authenticates user\n  → Callback received at /auth/callback\n  → API Client exchanges code for JWT\n  → State Store saves tokens\n  → Router redirects to dashboard\n```\n\n### Real-Time Task Updates\n```\nUser opens task board\n  → Board Feature subscribes via WebSocket\n  → API Client joins board room\n  → Server pushes task updates\n  → State Store updates task data\n  → React re-renders affected components\n```\n\n## State Management Strategy\n\n| State Type | Solution | Examples |\n|------------|----------|----------|\n| Server State | TanStack Query | Tasks, boards, users |\n| Client State | Zustand | UI preferences, modal state |\n| URL State | React Router | Current board, filters |\n| Form State | React Hook Form | Task creation, settings |\n\n## Performance Considerations\n\n- **Code splitting**: Lazy load feature modules\n- **Optimistic updates**: Update UI before API confirmation\n- **Virtual scrolling**: For boards with many tasks\n- **Image optimization**: Lazy load avatars and attachments\n- **Bundle size**: Monitor with Vite's built-in analyzer\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/c3-1-web.md",
        "content": "# c3-1: Web Application (React SPA)\n\n> **Level**: Container | **Type**: Frontend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nSingle-page React application providing the TaskFlow user interface. Built with TypeScript for type safety and Vite for fast development experience.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        WEB APPLICATION [c3-1]                            │\n│                    React SPA + TypeScript + Vite                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                         PRESENTATION LAYER                          │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   Layout    │ │  Dashboard  │ │  TaskBoard  │ │  Settings   │  │ │\n│  │  │   Shell     │ │    Page     │ │    Page     │ │    Page     │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         FEATURE MODULES                             │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │  Workspace  │ │    Board    │ │   Profile   │  │ │\n│  │  │  Features   │ │  Features   │ │  Features   │ │  Features   │  │ │\n│  │  │  [c3-1.1]   │ │  [c3-1.2]   │ │  [c3-1.3]   │ │  [c3-1.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                         SHARED LAYER                                │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │     UI      │ │   Hooks     │ │   State     │ │    API      │  │ │\n│  │  │ Components  │ │   Library   │ │   Store     │ │   Client    │  │ │\n│  │  │  [c3-1.5]   │ │  [c3-1.6]   │ │  [c3-1.7]   │ │  [c3-1.8]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└────────────────────────────────────────┬────────────────────────────────┘\n                                         │\n                           ┌─────────────┴─────────────┐\n                           │                           │\n                           ▼                           ▼\n                  ┌─────────────────┐        ┌─────────────────┐\n                  │   REST API      │        │   WebSocket     │\n                  │   [c3-2]        │        │   [c3-2]        │\n                  └─────────────────┘        └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| React | 18.x | UI framework |\n| TypeScript | 5.x | Type safety |\n| Vite | 5.x | Build tool and dev server |\n| TanStack Query | 5.x | Server state management |\n| Zustand | 4.x | Client state management |\n| React Router | 6.x | Client-side routing |\n| Socket.io Client | 4.x | Real-time communication |\n| Tailwind CSS | 3.x | Styling |\n| Radix UI | Latest | Accessible UI primitives |\n\n## Components\n\n### Feature Modules\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [Auth Features](components/c3-1.1-auth-features.md) | c3-1.1 | Login, OAuth callback, session management | `src/features/auth/` |\n| [Workspace Features](components/c3-1.2-workspace-features.md) | c3-1.2 | Workspace selection, creation, settings | `src/features/workspace/` |\n| [Board Features](components/c3-1.3-board-features.md) | c3-1.3 | Task board UI, drag-drop, real-time sync | `src/features/board/` |\n| [Profile Features](components/c3-1.4-profile-features.md) | c3-1.4 | User profile, preferences, notifications | `src/features/profile/` |\n\n### Shared Layer\n\n| Component | ID | Description | Path |\n|-----------|-----|-------------|------|\n| [UI Components](components/c3-1.5-ui-components.md) | c3-1.5 | Design system, buttons, forms, modals | `src/components/` |\n| [Hooks Library](components/c3-1.6-hooks.md) | c3-1.6 | Custom React hooks for common patterns | `src/hooks/` |\n| [State Store](components/c3-1.7-state.md) | c3-1.7 | Zustand stores for client state | `src/store/` |\n| [API Client](components/c3-1.8-api-client.md) | c3-1.8 | HTTP + WebSocket client configuration | `src/lib/api/` |\n\n## Directory Structure\n\n```\npackages/web/\n├── src/\n│   ├── features/              # Feature modules\n│   │   ├── auth/\n│   │   │   ├── components/    # Feature-specific components\n│   │   │   ├── hooks/         # Feature-specific hooks\n│   │   │   ├── api/           # API calls for this feature\n│   │   │   └── index.ts       # Public exports\n│   │   ├── workspace/\n│   │   ├── board/\n│   │   └── profile/\n│   ├── components/            # Shared UI components\n│   │   ├── ui/                # Primitives (Button, Input, etc.)\n│   │   └── layout/            # Layout components\n│   ├── hooks/                 # Shared hooks\n│   ├── store/                 # Zustand stores\n│   ├── lib/                   # Utilities\n│   │   ├── api/               # API client\n│   │   └── utils/             # Helper functions\n│   ├── types/                 # TypeScript types\n│   ├── App.tsx\n│   └── main.tsx\n├── public/\n├── index.html\n├── vite.config.ts\n├── tailwind.config.ts\n└── package.json\n```\n\n## Key Interactions\n\n### Authentication Flow\n```\nUser clicks \"Sign in with Google\"\n  → Auth Feature initiates OAuth redirect\n  → Google authenticates user\n  → Callback received at /auth/callback\n  → API Client exchanges code for JWT\n  → State Store saves tokens\n  → Router redirects to dashboard\n```\n\n### Real-Time Task Updates\n```\nUser opens task board\n  → Board Feature subscribes via WebSocket\n  → API Client joins board room\n  → Server pushes task updates\n  → State Store updates task data\n  → React re-renders affected components\n```\n\n## State Management Strategy\n\n| State Type | Solution | Examples |\n|------------|----------|----------|\n| Server State | TanStack Query | Tasks, boards, users |\n| Client State | Zustand | UI preferences, modal state |\n| URL State | React Router | Current board, filters |\n| Form State | React Hook Form | Task creation, settings |\n\n## Performance Considerations\n\n- **Code splitting**: Lazy load feature modules\n- **Optimistic updates**: Update UI before API confirmation\n- **Virtual scrolling**: For boards with many tasks\n- **Image optimization**: Lazy load avatars and attachments\n- **Bundle size**: Monitor with Vite's built-in analyzer\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:12:06.033Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-2-api.md",
        "content": "# c3-2: API Server (Express.js)\n\n> **Level**: Container | **Type**: Backend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nNode.js/Express backend implementing a modular monolith architecture. Provides REST APIs for CRUD operations and WebSocket connections for real-time collaboration. TypeScript throughout for type safety with the frontend.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         API SERVER [c3-2]                                │\n│                   Express.js + TypeScript + Socket.io                    │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        GATEWAY LAYER                                │ │\n│  │  ┌────────────────────────────────────────────────────────────┐   │ │\n│  │  │  Express Router + Middleware Pipeline                       │   │ │\n│  │  │  ├── CORS                  ├── Rate Limiting               │   │ │\n│  │  │  ├── JWT Validation        ├── Request Logging             │   │ │\n│  │  │  ├── Workspace Context     └── Error Handler               │   │ │\n│  │  └────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                       FEATURE MODULES                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │    User     │ │  Workspace  │ │    Team     │  │ │\n│  │  │   Module    │ │   Module    │ │   Module    │ │   Module    │  │ │\n│  │  │  [c3-2.1]   │ │  [c3-2.2]   │ │  [c3-2.3]   │ │  [c3-2.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │  TaskBoard  │ │Notification │                                   │ │\n│  │  │   Module    │ │   Module    │                                   │ │\n│  │  │  [c3-2.5]   │ │  [c3-2.6]   │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                      FOUNDATION LAYER                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │  Database   │ │   Cache     │ │  WebSocket  │ │   Events    │  │ │\n│  │  │   Client    │ │   Client    │ │   Server    │ │    Bus      │  │ │\n│  │  │  [c3-2.7]   │ │  [c3-2.8]   │ │  [c3-2.9]   │ │  [c3-2.10]  │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   Logger    │ │   Config    │                                   │ │\n│  │  │  [c3-2.11]  │ │  [c3-2.12]  │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└───────────┬─────────────────────────────────┬───────────────────────────┘\n            │                                 │\n            ▼                                 ▼\n   ┌─────────────────┐               ┌─────────────────┐\n   │   PostgreSQL    │               │     Redis       │\n   │     [c3-3]      │               │     [c3-4]      │\n   └─────────────────┘               └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| Node.js | 20.x LTS | Runtime |\n| Express | 4.x | HTTP framework |\n| TypeScript | 5.x | Type safety |\n| Socket.io | 4.x | WebSocket server |\n| Prisma | 5.x | Database ORM |\n| Zod | 3.x | Request validation |\n| Passport | 0.7.x | Authentication strategies |\n| Winston | 3.x | Logging |\n| ioredis | 5.x | Redis client |\n\n## Components\n\n### Gateway Layer\n\nMiddleware pipeline processing all incoming requests:\n\n```typescript\n// Middleware execution order\napp.use(cors(corsConfig));\napp.use(helmet());\napp.use(express.json());\napp.use(requestLogger);\napp.use(rateLimiter);\napp.use('/api', jwtValidator);\napp.use('/api', workspaceContext);\napp.use(errorHandler);\n```\n\n### Feature Modules\n\n| Module | ID | Responsibility | Routes |\n|--------|-----|----------------|--------|\n| [Auth Module](components/c3-2.1-auth-module.md) | c3-2.1 | OAuth flow, JWT management | `/auth/*` |\n| [User Module](components/c3-2.2-user-module.md) | c3-2.2 | User profiles, preferences | `/api/v1/users/*` |\n| [Workspace Module](components/c3-2.3-workspace-module.md) | c3-2.3 | Workspace CRUD, settings | `/api/v1/workspaces/*` |\n| [Team Module](components/c3-2.4-team-module.md) | c3-2.4 | Membership, roles, invites | `/api/v1/teams/*` |\n| [TaskBoard Module](components/c3-2.5-taskboard-module.md) | c3-2.5 | Boards, columns, tasks | `/api/v1/boards/*` |\n| [Notification Module](components/c3-2.6-notification-module.md) | c3-2.6 | In-app, email, webhooks | `/api/v1/notifications/*` |\n\n### Foundation Layer\n\n| Component | ID | Responsibility |\n|-----------|-----|----------------|\n| [Database Client](components/c3-2.7-database.md) | c3-2.7 | Prisma client, connection pool, migrations |\n| [Cache Client](components/c3-2.8-cache.md) | c3-2.8 | Redis operations, TTL management |\n| [WebSocket Server](components/c3-2.9-websocket.md) | c3-2.9 | Socket.io setup, room management |\n| [Events Bus](components/c3-2.10-events.md) | c3-2.10 | Internal event pub/sub, Redis bridge |\n| [Logger](components/c3-2.11-logger.md) | c3-2.11 | Winston config, log aggregation |\n| [Config](components/c3-2.12-config.md) | c3-2.12 | Environment variables, feature flags |\n\n## Directory Structure\n\n```\npackages/api/\n├── src/\n│   ├── modules/                    # Feature modules\n│   │   ├── auth/\n│   │   │   ├── auth.controller.ts  # Route handlers\n│   │   │   ├── auth.service.ts     # Business logic\n│   │   │   ├── auth.schema.ts      # Zod validation\n│   │   │   ├── auth.routes.ts      # Express routes\n│   │   │   └── index.ts            # Public exports\n│   │   ├── user/\n│   │   ├── workspace/\n│   │   ├── team/\n│   │   ├── taskboard/\n│   │   └── notification/\n│   ├── foundation/                 # Foundation layer\n│   │   ├── database/\n│   │   │   ├── client.ts           # Prisma client\n│   │   │   └── migrations/         # Schema migrations\n│   │   ├── cache/\n│   │   │   ├── client.ts           # Redis client\n│   │   │   └── keys.ts             # Key patterns\n│   │   ├── websocket/\n│   │   │   ├── server.ts           # Socket.io setup\n│   │   │   └── handlers/           # Event handlers\n│   │   ├── events/\n│   │   │   ├── bus.ts              # Event emitter\n│   │   │   └── types.ts            # Event definitions\n│   │   ├── logger/\n│   │   └── config/\n│   ├── middleware/                 # Express middleware\n│   │   ├── auth.ts                 # JWT validation\n│   │   ├── workspace.ts            # Tenant context\n│   │   ├── rateLimiter.ts\n│   │   └── errorHandler.ts\n│   ├── shared/                     # Shared utilities\n│   │   ├── types/\n│   │   └── utils/\n│   ├── app.ts                      # Express app setup\n│   └── server.ts                   # Server entry point\n├── prisma/\n│   └── schema.prisma\n├── tests/\n└── package.json\n```\n\n## Module Structure Pattern\n\nEach feature module follows a consistent structure:\n\n```typescript\n// modules/taskboard/index.ts - Public interface\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type { Task, Board, Column } from './taskboard.types';\n\n// Private implementation stays internal\n// - taskboard.controller.ts\n// - taskboard.repository.ts\n// - taskboard.schema.ts\n```\n\n## API Design\n\n### REST Endpoints\n\n```\nAuthentication:\nPOST   /auth/google              # Initiate OAuth\nGET    /auth/google/callback     # OAuth callback\nPOST   /auth/refresh             # Refresh tokens\nPOST   /auth/logout              # Invalidate session\n\nWorkspaces:\nGET    /api/v1/workspaces        # List user's workspaces\nPOST   /api/v1/workspaces        # Create workspace\nGET    /api/v1/workspaces/:id    # Get workspace details\nPUT    /api/v1/workspaces/:id    # Update workspace\nDELETE /api/v1/workspaces/:id    # Delete workspace\n\nBoards:\nGET    /api/v1/boards            # List boards in workspace\nPOST   /api/v1/boards            # Create board\nGET    /api/v1/boards/:id        # Get board with columns/tasks\nPUT    /api/v1/boards/:id        # Update board\nDELETE /api/v1/boards/:id        # Delete board\n\nTasks:\nPOST   /api/v1/boards/:id/tasks  # Create task\nPUT    /api/v1/tasks/:id         # Update task\nDELETE /api/v1/tasks/:id         # Delete task\nPOST   /api/v1/tasks/:id/move    # Move task (column/position)\n```\n\n### WebSocket Events\n\n```typescript\n// Client → Server\nsocket.emit('board:join', { boardId });\nsocket.emit('board:leave', { boardId });\nsocket.emit('task:update', { taskId, changes });\n\n// Server → Client\nsocket.on('task:created', (task) => {});\nsocket.on('task:updated', (task) => {});\nsocket.on('task:moved', ({ taskId, columnId, position }) => {});\nsocket.on('task:deleted', ({ taskId }) => {});\nsocket.on('member:joined', (member) => {});\n```\n\n## Error Handling\n\nConsistent error response format:\n\n```typescript\ninterface ApiError {\n  error: {\n    code: string;          // Machine-readable code\n    message: string;       // Human-readable message\n    details?: unknown;     // Additional context\n    requestId: string;     // For support/debugging\n  };\n}\n\n// Example\n{\n  \"error\": {\n    \"code\": \"TASK_NOT_FOUND\",\n    \"message\": \"Task with ID abc123 not found\",\n    \"requestId\": \"req_xyz789\"\n  }\n}\n```\n\n## Security\n\n| Layer | Implementation |\n|-------|----------------|\n| Authentication | JWT with 15-min expiry, secure refresh tokens |\n| Authorization | RBAC middleware checking workspace role |\n| Input Validation | Zod schemas on all endpoints |\n| Rate Limiting | 100 req/min per user (Redis-backed) |\n| SQL Injection | Prisma parameterized queries |\n| XSS | Helmet security headers |\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:12:06.051Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-2-api.md",
        "content": "# c3-2: API Server (Express.js)\n\n> **Level**: Container | **Type**: Backend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nNode.js/Express backend implementing a modular monolith architecture. Provides REST APIs for CRUD operations and WebSocket connections for real-time collaboration. TypeScript throughout for type safety with the frontend.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         API SERVER [c3-2]                                │\n│                   Express.js + TypeScript + Socket.io                    │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        GATEWAY LAYER                                │ │\n│  │  ┌────────────────────────────────────────────────────────────┐   │ │\n│  │  │  Express Router + Middleware Pipeline                       │   │ │\n│  │  │  ├── CORS                  ├── Rate Limiting               │   │ │\n│  │  │  ├── JWT Validation        ├── Request Logging             │   │ │\n│  │  │  ├── Workspace Context     └── Error Handler               │   │ │\n│  │  └────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                       FEATURE MODULES                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │    User     │ │  Workspace  │ │    Team     │  │ │\n│  │  │   Module    │ │   Module    │ │   Module    │ │   Module    │  │ │\n│  │  │  [c3-2.1]   │ │  [c3-2.2]   │ │  [c3-2.3]   │ │  [c3-2.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │  TaskBoard  │ │Notification │                                   │ │\n│  │  │   Module    │ │   Module    │                                   │ │\n│  │  │  [c3-2.5]   │ │  [c3-2.6]   │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                      FOUNDATION LAYER                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │  Database   │ │   Cache     │ │  WebSocket  │ │   Events    │  │ │\n│  │  │   Client    │ │   Client    │ │   Server    │ │    Bus      │  │ │\n│  │  │  [c3-2.7]   │ │  [c3-2.8]   │ │  [c3-2.9]   │ │  [c3-2.10]  │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   Logger    │ │   Config    │                                   │ │\n│  │  │  [c3-2.11]  │ │  [c3-2.12]  │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└───────────┬─────────────────────────────────┬───────────────────────────┘\n            │                                 │\n            ▼                                 ▼\n   ┌─────────────────┐               ┌─────────────────┐\n   │   PostgreSQL    │               │     Redis       │\n   │     [c3-3]      │               │     [c3-4]      │\n   └─────────────────┘               └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| Node.js | 20.x LTS | Runtime |\n| Express | 4.x | HTTP framework |\n| TypeScript | 5.x | Type safety |\n| Socket.io | 4.x | WebSocket server |\n| Prisma | 5.x | Database ORM |\n| Zod | 3.x | Request validation |\n| Passport | 0.7.x | Authentication strategies |\n| Winston | 3.x | Logging |\n| ioredis | 5.x | Redis client |\n\n## Components\n\n### Gateway Layer\n\nMiddleware pipeline processing all incoming requests:\n\n```typescript\n// Middleware execution order\napp.use(cors(corsConfig));\napp.use(helmet());\napp.use(express.json());\napp.use(requestLogger);\napp.use(rateLimiter);\napp.use('/api', jwtValidator);\napp.use('/api', workspaceContext);\napp.use(errorHandler);\n```\n\n### Feature Modules\n\n| Module | ID | Responsibility | Routes |\n|--------|-----|----------------|--------|\n| [Auth Module](components/c3-2.1-auth-module.md) | c3-2.1 | OAuth flow, JWT management | `/auth/*` |\n| [User Module](components/c3-2.2-user-module.md) | c3-2.2 | User profiles, preferences | `/api/v1/users/*` |\n| [Workspace Module](components/c3-2.3-workspace-module.md) | c3-2.3 | Workspace CRUD, settings | `/api/v1/workspaces/*` |\n| [Team Module](components/c3-2.4-team-module.md) | c3-2.4 | Membership, roles, invites | `/api/v1/teams/*` |\n| [TaskBoard Module](components/c3-2.5-taskboard-module.md) | c3-2.5 | Boards, columns, tasks | `/api/v1/boards/*` |\n| [Notification Module](components/c3-2.6-notification-module.md) | c3-2.6 | In-app, email, webhooks | `/api/v1/notifications/*` |\n\n### Foundation Layer\n\n| Component | ID | Responsibility |\n|-----------|-----|----------------|\n| [Database Client](components/c3-2.7-database.md) | c3-2.7 | Prisma client, connection pool, migrations |\n| [Cache Client](components/c3-2.8-cache.md) | c3-2.8 | Redis operations, TTL management |\n| [WebSocket Server](components/c3-2.9-websocket.md) | c3-2.9 | Socket.io setup, room management |\n| [Events Bus](components/c3-2.10-events.md) | c3-2.10 | Internal event pub/sub, Redis bridge |\n| [Logger](components/c3-2.11-logger.md) | c3-2.11 | Winston config, log aggregation |\n| [Config](components/c3-2.12-config.md) | c3-2.12 | Environment variables, feature flags |\n\n## Directory Structure\n\n```\npackages/api/\n├── src/\n│   ├── modules/                    # Feature modules\n│   │   ├── auth/\n│   │   │   ├── auth.controller.ts  # Route handlers\n│   │   │   ├── auth.service.ts     # Business logic\n│   │   │   ├── auth.schema.ts      # Zod validation\n│   │   │   ├── auth.routes.ts      # Express routes\n│   │   │   └── index.ts            # Public exports\n│   │   ├── user/\n│   │   ├── workspace/\n│   │   ├── team/\n│   │   ├── taskboard/\n│   │   └── notification/\n│   ├── foundation/                 # Foundation layer\n│   │   ├── database/\n│   │   │   ├── client.ts           # Prisma client\n│   │   │   └── migrations/         # Schema migrations\n│   │   ├── cache/\n│   │   │   ├── client.ts           # Redis client\n│   │   │   └── keys.ts             # Key patterns\n│   │   ├── websocket/\n│   │   │   ├── server.ts           # Socket.io setup\n│   │   │   └── handlers/           # Event handlers\n│   │   ├── events/\n│   │   │   ├── bus.ts              # Event emitter\n│   │   │   └── types.ts            # Event definitions\n│   │   ├── logger/\n│   │   └── config/\n│   ├── middleware/                 # Express middleware\n│   │   ├── auth.ts                 # JWT validation\n│   │   ├── workspace.ts            # Tenant context\n│   │   ├── rateLimiter.ts\n│   │   └── errorHandler.ts\n│   ├── shared/                     # Shared utilities\n│   │   ├── types/\n│   │   └── utils/\n│   ├── app.ts                      # Express app setup\n│   └── server.ts                   # Server entry point\n├── prisma/\n│   └── schema.prisma\n├── tests/\n└── package.json\n```\n\n## Module Structure Pattern\n\nEach feature module follows a consistent structure:\n\n```typescript\n// modules/taskboard/index.ts - Public interface\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type { Task, Board, Column } from './taskboard.types';\n\n// Private implementation stays internal\n// - taskboard.controller.ts\n// - taskboard.repository.ts\n// - taskboard.schema.ts\n```\n\n## API Design\n\n### REST Endpoints\n\n```\nAuthentication:\nPOST   /auth/google              # Initiate OAuth\nGET    /auth/google/callback     # OAuth callback\nPOST   /auth/refresh             # Refresh tokens\nPOST   /auth/logout              # Invalidate session\n\nWorkspaces:\nGET    /api/v1/workspaces        # List user's workspaces\nPOST   /api/v1/workspaces        # Create workspace\nGET    /api/v1/workspaces/:id    # Get workspace details\nPUT    /api/v1/workspaces/:id    # Update workspace\nDELETE /api/v1/workspaces/:id    # Delete workspace\n\nBoards:\nGET    /api/v1/boards            # List boards in workspace\nPOST   /api/v1/boards            # Create board\nGET    /api/v1/boards/:id        # Get board with columns/tasks\nPUT    /api/v1/boards/:id        # Update board\nDELETE /api/v1/boards/:id        # Delete board\n\nTasks:\nPOST   /api/v1/boards/:id/tasks  # Create task\nPUT    /api/v1/tasks/:id         # Update task\nDELETE /api/v1/tasks/:id         # Delete task\nPOST   /api/v1/tasks/:id/move    # Move task (column/position)\n```\n\n### WebSocket Events\n\n```typescript\n// Client → Server\nsocket.emit('board:join', { boardId });\nsocket.emit('board:leave', { boardId });\nsocket.emit('task:update', { taskId, changes });\n\n// Server → Client\nsocket.on('task:created', (task) => {});\nsocket.on('task:updated', (task) => {});\nsocket.on('task:moved', ({ taskId, columnId, position }) => {});\nsocket.on('task:deleted', ({ taskId }) => {});\nsocket.on('member:joined', (member) => {});\n```\n\n## Error Handling\n\nConsistent error response format:\n\n```typescript\ninterface ApiError {\n  error: {\n    code: string;          // Machine-readable code\n    message: string;       // Human-readable message\n    details?: unknown;     // Additional context\n    requestId: string;     // For support/debugging\n  };\n}\n\n// Example\n{\n  \"error\": {\n    \"code\": \"TASK_NOT_FOUND\",\n    \"message\": \"Task with ID abc123 not found\",\n    \"requestId\": \"req_xyz789\"\n  }\n}\n```\n\n## Security\n\n| Layer | Implementation |\n|-------|----------------|\n| Authentication | JWT with 15-min expiry, secure refresh tokens |\n| Authorization | RBAC middleware checking workspace role |\n| Input Validation | Zod schemas on all endpoints |\n| Rate Limiting | 100 req/min per user (Redis-backed) |\n| SQL Injection | Prisma parameterized queries |\n| XSS | Helmet security headers |\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/c3-2-api.md",
        "content": "# c3-2: API Server (Express.js)\n\n> **Level**: Container | **Type**: Backend | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nNode.js/Express backend implementing a modular monolith architecture. Provides REST APIs for CRUD operations and WebSocket connections for real-time collaboration. TypeScript throughout for type safety with the frontend.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         API SERVER [c3-2]                                │\n│                   Express.js + TypeScript + Socket.io                    │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        GATEWAY LAYER                                │ │\n│  │  ┌────────────────────────────────────────────────────────────┐   │ │\n│  │  │  Express Router + Middleware Pipeline                       │   │ │\n│  │  │  ├── CORS                  ├── Rate Limiting               │   │ │\n│  │  │  ├── JWT Validation        ├── Request Logging             │   │ │\n│  │  │  ├── Workspace Context     └── Error Handler               │   │ │\n│  │  └────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                       FEATURE MODULES                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │    Auth     │ │    User     │ │  Workspace  │ │    Team     │  │ │\n│  │  │   Module    │ │   Module    │ │   Module    │ │   Module    │  │ │\n│  │  │  [c3-2.1]   │ │  [c3-2.2]   │ │  [c3-2.3]   │ │  [c3-2.4]   │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │  TaskBoard  │ │Notification │                                   │ │\n│  │  │   Module    │ │   Module    │                                   │ │\n│  │  │  [c3-2.5]   │ │  [c3-2.6]   │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                    │                                     │\n│  ┌────────────────────────────────▼───────────────────────────────────┐ │\n│  │                      FOUNDATION LAYER                               │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │  Database   │ │   Cache     │ │  WebSocket  │ │   Events    │  │ │\n│  │  │   Client    │ │   Client    │ │   Server    │ │    Bus      │  │ │\n│  │  │  [c3-2.7]   │ │  [c3-2.8]   │ │  [c3-2.9]   │ │  [c3-2.10]  │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   Logger    │ │   Config    │                                   │ │\n│  │  │  [c3-2.11]  │ │  [c3-2.12]  │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└───────────┬─────────────────────────────────┬───────────────────────────┘\n            │                                 │\n            ▼                                 ▼\n   ┌─────────────────┐               ┌─────────────────┐\n   │   PostgreSQL    │               │     Redis       │\n   │     [c3-3]      │               │     [c3-4]      │\n   └─────────────────┘               └─────────────────┘\n```\n\n## Technology Stack\n\n| Technology | Version | Purpose |\n|------------|---------|---------|\n| Node.js | 20.x LTS | Runtime |\n| Express | 4.x | HTTP framework |\n| TypeScript | 5.x | Type safety |\n| Socket.io | 4.x | WebSocket server |\n| Prisma | 5.x | Database ORM |\n| Zod | 3.x | Request validation |\n| Passport | 0.7.x | Authentication strategies |\n| Winston | 3.x | Logging |\n| ioredis | 5.x | Redis client |\n\n## Components\n\n### Gateway Layer\n\nMiddleware pipeline processing all incoming requests:\n\n```typescript\n// Middleware execution order\napp.use(cors(corsConfig));\napp.use(helmet());\napp.use(express.json());\napp.use(requestLogger);\napp.use(rateLimiter);\napp.use('/api', jwtValidator);\napp.use('/api', workspaceContext);\napp.use(errorHandler);\n```\n\n### Feature Modules\n\n| Module | ID | Responsibility | Routes |\n|--------|-----|----------------|--------|\n| [Auth Module](components/c3-2.1-auth-module.md) | c3-2.1 | OAuth flow, JWT management | `/auth/*` |\n| [User Module](components/c3-2.2-user-module.md) | c3-2.2 | User profiles, preferences | `/api/v1/users/*` |\n| [Workspace Module](components/c3-2.3-workspace-module.md) | c3-2.3 | Workspace CRUD, settings | `/api/v1/workspaces/*` |\n| [Team Module](components/c3-2.4-team-module.md) | c3-2.4 | Membership, roles, invites | `/api/v1/teams/*` |\n| [TaskBoard Module](components/c3-2.5-taskboard-module.md) | c3-2.5 | Boards, columns, tasks | `/api/v1/boards/*` |\n| [Notification Module](components/c3-2.6-notification-module.md) | c3-2.6 | In-app, email, webhooks | `/api/v1/notifications/*` |\n\n### Foundation Layer\n\n| Component | ID | Responsibility |\n|-----------|-----|----------------|\n| [Database Client](components/c3-2.7-database.md) | c3-2.7 | Prisma client, connection pool, migrations |\n| [Cache Client](components/c3-2.8-cache.md) | c3-2.8 | Redis operations, TTL management |\n| [WebSocket Server](components/c3-2.9-websocket.md) | c3-2.9 | Socket.io setup, room management |\n| [Events Bus](components/c3-2.10-events.md) | c3-2.10 | Internal event pub/sub, Redis bridge |\n| [Logger](components/c3-2.11-logger.md) | c3-2.11 | Winston config, log aggregation |\n| [Config](components/c3-2.12-config.md) | c3-2.12 | Environment variables, feature flags |\n\n## Directory Structure\n\n```\npackages/api/\n├── src/\n│   ├── modules/                    # Feature modules\n│   │   ├── auth/\n│   │   │   ├── auth.controller.ts  # Route handlers\n│   │   │   ├── auth.service.ts     # Business logic\n│   │   │   ├── auth.schema.ts      # Zod validation\n│   │   │   ├── auth.routes.ts      # Express routes\n│   │   │   └── index.ts            # Public exports\n│   │   ├── user/\n│   │   ├── workspace/\n│   │   ├── team/\n│   │   ├── taskboard/\n│   │   └── notification/\n│   ├── foundation/                 # Foundation layer\n│   │   ├── database/\n│   │   │   ├── client.ts           # Prisma client\n│   │   │   └── migrations/         # Schema migrations\n│   │   ├── cache/\n│   │   │   ├── client.ts           # Redis client\n│   │   │   └── keys.ts             # Key patterns\n│   │   ├── websocket/\n│   │   │   ├── server.ts           # Socket.io setup\n│   │   │   └── handlers/           # Event handlers\n│   │   ├── events/\n│   │   │   ├── bus.ts              # Event emitter\n│   │   │   └── types.ts            # Event definitions\n│   │   ├── logger/\n│   │   └── config/\n│   ├── middleware/                 # Express middleware\n│   │   ├── auth.ts                 # JWT validation\n│   │   ├── workspace.ts            # Tenant context\n│   │   ├── rateLimiter.ts\n│   │   └── errorHandler.ts\n│   ├── shared/                     # Shared utilities\n│   │   ├── types/\n│   │   └── utils/\n│   ├── app.ts                      # Express app setup\n│   └── server.ts                   # Server entry point\n├── prisma/\n│   └── schema.prisma\n├── tests/\n└── package.json\n```\n\n## Module Structure Pattern\n\nEach feature module follows a consistent structure:\n\n```typescript\n// modules/taskboard/index.ts - Public interface\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type { Task, Board, Column } from './taskboard.types';\n\n// Private implementation stays internal\n// - taskboard.controller.ts\n// - taskboard.repository.ts\n// - taskboard.schema.ts\n```\n\n## API Design\n\n### REST Endpoints\n\n```\nAuthentication:\nPOST   /auth/google              # Initiate OAuth\nGET    /auth/google/callback     # OAuth callback\nPOST   /auth/refresh             # Refresh tokens\nPOST   /auth/logout              # Invalidate session\n\nWorkspaces:\nGET    /api/v1/workspaces        # List user's workspaces\nPOST   /api/v1/workspaces        # Create workspace\nGET    /api/v1/workspaces/:id    # Get workspace details\nPUT    /api/v1/workspaces/:id    # Update workspace\nDELETE /api/v1/workspaces/:id    # Delete workspace\n\nBoards:\nGET    /api/v1/boards            # List boards in workspace\nPOST   /api/v1/boards            # Create board\nGET    /api/v1/boards/:id        # Get board with columns/tasks\nPUT    /api/v1/boards/:id        # Update board\nDELETE /api/v1/boards/:id        # Delete board\n\nTasks:\nPOST   /api/v1/boards/:id/tasks  # Create task\nPUT    /api/v1/tasks/:id         # Update task\nDELETE /api/v1/tasks/:id         # Delete task\nPOST   /api/v1/tasks/:id/move    # Move task (column/position)\n```\n\n### WebSocket Events\n\n```typescript\n// Client → Server\nsocket.emit('board:join', { boardId });\nsocket.emit('board:leave', { boardId });\nsocket.emit('task:update', { taskId, changes });\n\n// Server → Client\nsocket.on('task:created', (task) => {});\nsocket.on('task:updated', (task) => {});\nsocket.on('task:moved', ({ taskId, columnId, position }) => {});\nsocket.on('task:deleted', ({ taskId }) => {});\nsocket.on('member:joined', (member) => {});\n```\n\n## Error Handling\n\nConsistent error response format:\n\n```typescript\ninterface ApiError {\n  error: {\n    code: string;          // Machine-readable code\n    message: string;       // Human-readable message\n    details?: unknown;     // Additional context\n    requestId: string;     // For support/debugging\n  };\n}\n\n// Example\n{\n  \"error\": {\n    \"code\": \"TASK_NOT_FOUND\",\n    \"message\": \"Task with ID abc123 not found\",\n    \"requestId\": \"req_xyz789\"\n  }\n}\n```\n\n## Security\n\n| Layer | Implementation |\n|-------|----------------|\n| Authentication | JWT with 15-min expiry, secure refresh tokens |\n| Authorization | RBAC middleware checking workspace role |\n| Input Validation | Zod schemas on all endpoints |\n| Rate Limiting | 100 req/min per user (Redis-backed) |\n| SQL Injection | Prisma parameterized queries |\n| XSS | Helmet security headers |\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:13:04.693Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-3-database.md",
        "content": "# c3-3: Database (PostgreSQL)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nPostgreSQL database implementing schema-based multi-tenancy. Global entities (users, workspaces) live in the public schema while workspace-specific data (boards, tasks) live in isolated per-workspace schemas.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        DATABASE [c3-3]                                   │\n│                    PostgreSQL 16 + Prisma ORM                            │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                       PUBLIC SCHEMA                                 │ │\n│  │                    (Global/Cross-tenant data)                       │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   users     │ │ workspaces  │ │   team_     │ │  invites    │  │ │\n│  │  │             │ │             │ │ memberships │ │             │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   refresh   │ │   audit_    │                                   │ │\n│  │  │   tokens    │ │    log      │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                     WORKSPACE SCHEMAS                               │ │\n│  │               (Isolated per-tenant data)                            │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐  │ │\n│  │  │    ws_{workspace_id_1}      │  │    ws_{workspace_id_2}      │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ boards │ │  columns   │ │  │  │ boards │ │  columns   │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ tasks  │ │  comments  │ │  │  │ tasks  │ │  comments  │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ labels │ │attachments │ │  │  │ labels │ │attachments │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  └─────────────────────────────┘  └─────────────────────────────┘  │ │\n│  │                                                                     │ │\n│  │  ... additional workspace schemas ...                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Schema Design\n\n### Public Schema - Global Entities\n\n```sql\n-- users: Authenticated users from Google OAuth\nCREATE TABLE public.users (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    google_id       VARCHAR(255) UNIQUE NOT NULL,\n    email           VARCHAR(255) UNIQUE NOT NULL,\n    name            VARCHAR(255) NOT NULL,\n    avatar_url      VARCHAR(500),\n    preferences     JSONB DEFAULT '{}',\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- workspaces: Multi-tenant containers\nCREATE TABLE public.workspaces (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    slug            VARCHAR(100) UNIQUE NOT NULL,\n    owner_id        UUID NOT NULL REFERENCES users(id),\n    settings        JSONB DEFAULT '{}',\n    schema_name     VARCHAR(100) UNIQUE NOT NULL,  -- ws_{uuid}\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- team_memberships: User <-> Workspace relationship\nCREATE TABLE public.team_memberships (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    joined_at       TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(user_id, workspace_id),\n    CHECK (role IN ('owner', 'admin', 'member', 'guest'))\n);\n\n-- invites: Pending workspace invitations\nCREATE TABLE public.invites (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    email           VARCHAR(255) NOT NULL,\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    invited_by      UUID NOT NULL REFERENCES users(id),\n    token           VARCHAR(255) UNIQUE NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    accepted_at     TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- refresh_tokens: JWT refresh token storage\nCREATE TABLE public.refresh_tokens (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    token_hash      VARCHAR(255) NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    revoked_at      TIMESTAMPTZ\n);\n\n-- audit_log: System-wide audit trail\nCREATE TABLE public.audit_log (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID REFERENCES users(id),\n    workspace_id    UUID REFERENCES workspaces(id),\n    action          VARCHAR(100) NOT NULL,\n    entity_type     VARCHAR(100) NOT NULL,\n    entity_id       UUID,\n    changes         JSONB,\n    ip_address      INET,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n### Workspace Schema - Tenant Entities\n\n```sql\n-- Template applied to each workspace schema (ws_{workspace_id})\n\n-- boards: Task board containers\nCREATE TABLE boards (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    description     TEXT,\n    is_archived     BOOLEAN DEFAULT FALSE,\n    position        INTEGER NOT NULL DEFAULT 0,\n    created_by      UUID NOT NULL,  -- References public.users\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- columns: Board columns (e.g., To Do, In Progress, Done)\nCREATE TABLE columns (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    board_id        UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n    name            VARCHAR(255) NOT NULL,\n    color           VARCHAR(7),  -- Hex color code\n    position        INTEGER NOT NULL,\n    wip_limit       INTEGER,     -- Optional work-in-progress limit\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- tasks: Individual task items\nCREATE TABLE tasks (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    column_id       UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n    title           VARCHAR(500) NOT NULL,\n    description     TEXT,\n    position        INTEGER NOT NULL,\n    priority        VARCHAR(20) DEFAULT 'medium',\n    due_date        DATE,\n    assignee_id     UUID,        -- References public.users\n    created_by      UUID NOT NULL,\n    completed_at    TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW(),\n    CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- comments: Task comments/discussion\nCREATE TABLE comments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    user_id         UUID NOT NULL,  -- References public.users\n    content         TEXT NOT NULL,\n    edited_at       TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- labels: Task labels/tags\nCREATE TABLE labels (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(100) NOT NULL,\n    color           VARCHAR(7) NOT NULL,\n    UNIQUE(name)\n);\n\n-- task_labels: Many-to-many relationship\nCREATE TABLE task_labels (\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    label_id        UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n    PRIMARY KEY (task_id, label_id)\n);\n\n-- attachments: File attachments metadata\nCREATE TABLE attachments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    filename        VARCHAR(255) NOT NULL,\n    file_url        VARCHAR(1000) NOT NULL,\n    file_size       BIGINT NOT NULL,\n    mime_type       VARCHAR(100) NOT NULL,\n    uploaded_by     UUID NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n## Entity Relationship Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         DATA MODEL                                       │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  PUBLIC SCHEMA:                                                          │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   users    │───────<│team_memberships │>───────│ workspaces │        │\n│  │            │   1:N  │                 │  N:1   │            │        │\n│  │ - id       │        │ - user_id       │        │ - id       │        │\n│  │ - email    │        │ - workspace_id  │        │ - name     │        │\n│  │ - name     │        │ - role          │        │ - owner_id │        │\n│  └────────────┘        └─────────────────┘        └────────────┘        │\n│        │                                                 │               │\n│        │ 1:N                                            │               │\n│        ▼                                                │               │\n│  ┌────────────┐                                         │               │\n│  │  invites   │─────────────────────────────────────────┘               │\n│  │            │                                    N:1                  │\n│  └────────────┘                                                          │\n│                                                                          │\n│  WORKSPACE SCHEMA (ws_{id}):                                            │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   boards   │───────<│    columns      │>───────│   tasks    │        │\n│  │            │   1:N  │                 │  1:N   │            │        │\n│  │ - id       │        │ - id            │        │ - id       │        │\n│  │ - name     │        │ - board_id      │        │ - column_id│        │\n│  └────────────┘        │ - position      │        │ - title    │        │\n│                        └─────────────────┘        │ - position │        │\n│                                                   └────────────┘        │\n│                                                         │               │\n│                          ┌──────────────────────────────┤               │\n│                          │                    1:N       │ 1:N           │\n│                          ▼                              ▼               │\n│                    ┌────────────┐              ┌────────────┐           │\n│                    │  comments  │              │task_labels │           │\n│                    │            │              │            │           │\n│                    └────────────┘              └────────────┘           │\n│                                                      │                  │\n│                                                      │ N:1              │\n│                                                      ▼                  │\n│                                                ┌────────────┐           │\n│                                                │   labels   │           │\n│                                                └────────────┘           │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Indexes\n\n```sql\n-- Public schema indexes\nCREATE INDEX idx_users_google_id ON public.users(google_id);\nCREATE INDEX idx_users_email ON public.users(email);\nCREATE INDEX idx_team_memberships_user ON public.team_memberships(user_id);\nCREATE INDEX idx_team_memberships_workspace ON public.team_memberships(workspace_id);\nCREATE INDEX idx_invites_token ON public.invites(token);\nCREATE INDEX idx_invites_email ON public.invites(email);\nCREATE INDEX idx_refresh_tokens_user ON public.refresh_tokens(user_id);\nCREATE INDEX idx_audit_log_workspace ON public.audit_log(workspace_id, created_at);\n\n-- Workspace schema indexes (applied to each ws_{id} schema)\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n```\n\n## Multi-Tenancy Implementation\n\n### Schema Provisioning\n\nWhen a workspace is created:\n\n```typescript\n// foundation/database/tenant.ts\nasync function provisionWorkspaceSchema(workspaceId: string): Promise<void> {\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await prisma.$executeRaw`CREATE SCHEMA IF NOT EXISTS ${schemaName}`;\n\n  // Apply workspace schema template\n  await prisma.$executeRaw`SET search_path TO ${schemaName}`;\n  await applyWorkspaceSchemaTemplate();\n  await prisma.$executeRaw`SET search_path TO public`;\n\n  // Update workspace record\n  await prisma.workspace.update({\n    where: { id: workspaceId },\n    data: { schemaName }\n  });\n}\n```\n\n### Query Routing\n\n```typescript\n// middleware/workspace.ts\nasync function workspaceContext(req: Request, res: Response, next: NextFunction) {\n  const workspaceId = req.headers['x-workspace-id'] as string;\n\n  if (!workspaceId) {\n    return res.status(400).json({ error: 'Workspace ID required' });\n  }\n\n  const workspace = await prisma.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    return res.status(404).json({ error: 'Workspace not found' });\n  }\n\n  // Set schema for this request\n  req.workspaceSchema = workspace.schemaName;\n  await prisma.$executeRaw`SET search_path TO ${workspace.schemaName}, public`;\n\n  next();\n}\n```\n\n## Prisma Configuration\n\n```prisma\n// prisma/schema.prisma\n\ngenerator client {\n  provider        = \"prisma-client-js\"\n  previewFeatures = [\"multiSchema\"]\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n  schemas  = [\"public\"]  // Dynamic schemas handled at runtime\n}\n\n// Public schema models\nmodel User {\n  id            String   @id @default(uuid())\n  googleId      String   @unique @map(\"google_id\")\n  email         String   @unique\n  name          String\n  avatarUrl     String?  @map(\"avatar_url\")\n  preferences   Json     @default(\"{}\")\n  createdAt     DateTime @default(now()) @map(\"created_at\")\n  updatedAt     DateTime @updatedAt @map(\"updated_at\")\n\n  memberships   TeamMembership[]\n  ownedWorkspaces Workspace[]\n\n  @@map(\"users\")\n  @@schema(\"public\")\n}\n\n// ... additional models\n```\n\n## Backup Strategy\n\n| Type | Frequency | Retention | Method |\n|------|-----------|-----------|--------|\n| Full backup | Daily | 30 days | pg_dump |\n| WAL archiving | Continuous | 7 days | Archive to S3 |\n| Point-in-time | On demand | N/A | WAL replay |\n\n## Performance Considerations\n\n- **Connection pooling**: PgBouncer for connection management\n- **Query optimization**: EXPLAIN ANALYZE for slow queries\n- **Partitioning**: Consider time-based partitioning for audit_log\n- **Vacuum**: Automated vacuum settings tuned for update-heavy tables\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:13:04.710Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-3-database.md",
        "content": "# c3-3: Database (PostgreSQL)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nPostgreSQL database implementing schema-based multi-tenancy. Global entities (users, workspaces) live in the public schema while workspace-specific data (boards, tasks) live in isolated per-workspace schemas.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        DATABASE [c3-3]                                   │\n│                    PostgreSQL 16 + Prisma ORM                            │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                       PUBLIC SCHEMA                                 │ │\n│  │                    (Global/Cross-tenant data)                       │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   users     │ │ workspaces  │ │   team_     │ │  invites    │  │ │\n│  │  │             │ │             │ │ memberships │ │             │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   refresh   │ │   audit_    │                                   │ │\n│  │  │   tokens    │ │    log      │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                     WORKSPACE SCHEMAS                               │ │\n│  │               (Isolated per-tenant data)                            │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐  │ │\n│  │  │    ws_{workspace_id_1}      │  │    ws_{workspace_id_2}      │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ boards │ │  columns   │ │  │  │ boards │ │  columns   │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ tasks  │ │  comments  │ │  │  │ tasks  │ │  comments  │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ labels │ │attachments │ │  │  │ labels │ │attachments │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  └─────────────────────────────┘  └─────────────────────────────┘  │ │\n│  │                                                                     │ │\n│  │  ... additional workspace schemas ...                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Schema Design\n\n### Public Schema - Global Entities\n\n```sql\n-- users: Authenticated users from Google OAuth\nCREATE TABLE public.users (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    google_id       VARCHAR(255) UNIQUE NOT NULL,\n    email           VARCHAR(255) UNIQUE NOT NULL,\n    name            VARCHAR(255) NOT NULL,\n    avatar_url      VARCHAR(500),\n    preferences     JSONB DEFAULT '{}',\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- workspaces: Multi-tenant containers\nCREATE TABLE public.workspaces (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    slug            VARCHAR(100) UNIQUE NOT NULL,\n    owner_id        UUID NOT NULL REFERENCES users(id),\n    settings        JSONB DEFAULT '{}',\n    schema_name     VARCHAR(100) UNIQUE NOT NULL,  -- ws_{uuid}\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- team_memberships: User <-> Workspace relationship\nCREATE TABLE public.team_memberships (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    joined_at       TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(user_id, workspace_id),\n    CHECK (role IN ('owner', 'admin', 'member', 'guest'))\n);\n\n-- invites: Pending workspace invitations\nCREATE TABLE public.invites (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    email           VARCHAR(255) NOT NULL,\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    invited_by      UUID NOT NULL REFERENCES users(id),\n    token           VARCHAR(255) UNIQUE NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    accepted_at     TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- refresh_tokens: JWT refresh token storage\nCREATE TABLE public.refresh_tokens (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    token_hash      VARCHAR(255) NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    revoked_at      TIMESTAMPTZ\n);\n\n-- audit_log: System-wide audit trail\nCREATE TABLE public.audit_log (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID REFERENCES users(id),\n    workspace_id    UUID REFERENCES workspaces(id),\n    action          VARCHAR(100) NOT NULL,\n    entity_type     VARCHAR(100) NOT NULL,\n    entity_id       UUID,\n    changes         JSONB,\n    ip_address      INET,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n### Workspace Schema - Tenant Entities\n\n```sql\n-- Template applied to each workspace schema (ws_{workspace_id})\n\n-- boards: Task board containers\nCREATE TABLE boards (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    description     TEXT,\n    is_archived     BOOLEAN DEFAULT FALSE,\n    position        INTEGER NOT NULL DEFAULT 0,\n    created_by      UUID NOT NULL,  -- References public.users\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- columns: Board columns (e.g., To Do, In Progress, Done)\nCREATE TABLE columns (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    board_id        UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n    name            VARCHAR(255) NOT NULL,\n    color           VARCHAR(7),  -- Hex color code\n    position        INTEGER NOT NULL,\n    wip_limit       INTEGER,     -- Optional work-in-progress limit\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- tasks: Individual task items\nCREATE TABLE tasks (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    column_id       UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n    title           VARCHAR(500) NOT NULL,\n    description     TEXT,\n    position        INTEGER NOT NULL,\n    priority        VARCHAR(20) DEFAULT 'medium',\n    due_date        DATE,\n    assignee_id     UUID,        -- References public.users\n    created_by      UUID NOT NULL,\n    completed_at    TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW(),\n    CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- comments: Task comments/discussion\nCREATE TABLE comments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    user_id         UUID NOT NULL,  -- References public.users\n    content         TEXT NOT NULL,\n    edited_at       TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- labels: Task labels/tags\nCREATE TABLE labels (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(100) NOT NULL,\n    color           VARCHAR(7) NOT NULL,\n    UNIQUE(name)\n);\n\n-- task_labels: Many-to-many relationship\nCREATE TABLE task_labels (\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    label_id        UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n    PRIMARY KEY (task_id, label_id)\n);\n\n-- attachments: File attachments metadata\nCREATE TABLE attachments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    filename        VARCHAR(255) NOT NULL,\n    file_url        VARCHAR(1000) NOT NULL,\n    file_size       BIGINT NOT NULL,\n    mime_type       VARCHAR(100) NOT NULL,\n    uploaded_by     UUID NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n## Entity Relationship Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         DATA MODEL                                       │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  PUBLIC SCHEMA:                                                          │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   users    │───────<│team_memberships │>───────│ workspaces │        │\n│  │            │   1:N  │                 │  N:1   │            │        │\n│  │ - id       │        │ - user_id       │        │ - id       │        │\n│  │ - email    │        │ - workspace_id  │        │ - name     │        │\n│  │ - name     │        │ - role          │        │ - owner_id │        │\n│  └────────────┘        └─────────────────┘        └────────────┘        │\n│        │                                                 │               │\n│        │ 1:N                                            │               │\n│        ▼                                                │               │\n│  ┌────────────┐                                         │               │\n│  │  invites   │─────────────────────────────────────────┘               │\n│  │            │                                    N:1                  │\n│  └────────────┘                                                          │\n│                                                                          │\n│  WORKSPACE SCHEMA (ws_{id}):                                            │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   boards   │───────<│    columns      │>───────│   tasks    │        │\n│  │            │   1:N  │                 │  1:N   │            │        │\n│  │ - id       │        │ - id            │        │ - id       │        │\n│  │ - name     │        │ - board_id      │        │ - column_id│        │\n│  └────────────┘        │ - position      │        │ - title    │        │\n│                        └─────────────────┘        │ - position │        │\n│                                                   └────────────┘        │\n│                                                         │               │\n│                          ┌──────────────────────────────┤               │\n│                          │                    1:N       │ 1:N           │\n│                          ▼                              ▼               │\n│                    ┌────────────┐              ┌────────────┐           │\n│                    │  comments  │              │task_labels │           │\n│                    │            │              │            │           │\n│                    └────────────┘              └────────────┘           │\n│                                                      │                  │\n│                                                      │ N:1              │\n│                                                      ▼                  │\n│                                                ┌────────────┐           │\n│                                                │   labels   │           │\n│                                                └────────────┘           │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Indexes\n\n```sql\n-- Public schema indexes\nCREATE INDEX idx_users_google_id ON public.users(google_id);\nCREATE INDEX idx_users_email ON public.users(email);\nCREATE INDEX idx_team_memberships_user ON public.team_memberships(user_id);\nCREATE INDEX idx_team_memberships_workspace ON public.team_memberships(workspace_id);\nCREATE INDEX idx_invites_token ON public.invites(token);\nCREATE INDEX idx_invites_email ON public.invites(email);\nCREATE INDEX idx_refresh_tokens_user ON public.refresh_tokens(user_id);\nCREATE INDEX idx_audit_log_workspace ON public.audit_log(workspace_id, created_at);\n\n-- Workspace schema indexes (applied to each ws_{id} schema)\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n```\n\n## Multi-Tenancy Implementation\n\n### Schema Provisioning\n\nWhen a workspace is created:\n\n```typescript\n// foundation/database/tenant.ts\nasync function provisionWorkspaceSchema(workspaceId: string): Promise<void> {\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await prisma.$executeRaw`CREATE SCHEMA IF NOT EXISTS ${schemaName}`;\n\n  // Apply workspace schema template\n  await prisma.$executeRaw`SET search_path TO ${schemaName}`;\n  await applyWorkspaceSchemaTemplate();\n  await prisma.$executeRaw`SET search_path TO public`;\n\n  // Update workspace record\n  await prisma.workspace.update({\n    where: { id: workspaceId },\n    data: { schemaName }\n  });\n}\n```\n\n### Query Routing\n\n```typescript\n// middleware/workspace.ts\nasync function workspaceContext(req: Request, res: Response, next: NextFunction) {\n  const workspaceId = req.headers['x-workspace-id'] as string;\n\n  if (!workspaceId) {\n    return res.status(400).json({ error: 'Workspace ID required' });\n  }\n\n  const workspace = await prisma.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    return res.status(404).json({ error: 'Workspace not found' });\n  }\n\n  // Set schema for this request\n  req.workspaceSchema = workspace.schemaName;\n  await prisma.$executeRaw`SET search_path TO ${workspace.schemaName}, public`;\n\n  next();\n}\n```\n\n## Prisma Configuration\n\n```prisma\n// prisma/schema.prisma\n\ngenerator client {\n  provider        = \"prisma-client-js\"\n  previewFeatures = [\"multiSchema\"]\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n  schemas  = [\"public\"]  // Dynamic schemas handled at runtime\n}\n\n// Public schema models\nmodel User {\n  id            String   @id @default(uuid())\n  googleId      String   @unique @map(\"google_id\")\n  email         String   @unique\n  name          String\n  avatarUrl     String?  @map(\"avatar_url\")\n  preferences   Json     @default(\"{}\")\n  createdAt     DateTime @default(now()) @map(\"created_at\")\n  updatedAt     DateTime @updatedAt @map(\"updated_at\")\n\n  memberships   TeamMembership[]\n  ownedWorkspaces Workspace[]\n\n  @@map(\"users\")\n  @@schema(\"public\")\n}\n\n// ... additional models\n```\n\n## Backup Strategy\n\n| Type | Frequency | Retention | Method |\n|------|-----------|-----------|--------|\n| Full backup | Daily | 30 days | pg_dump |\n| WAL archiving | Continuous | 7 days | Archive to S3 |\n| Point-in-time | On demand | N/A | WAL replay |\n\n## Performance Considerations\n\n- **Connection pooling**: PgBouncer for connection management\n- **Query optimization**: EXPLAIN ANALYZE for slow queries\n- **Partitioning**: Consider time-based partitioning for audit_log\n- **Vacuum**: Automated vacuum settings tuned for update-heavy tables\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/c3-3-database.md",
        "content": "# c3-3: Database (PostgreSQL)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nPostgreSQL database implementing schema-based multi-tenancy. Global entities (users, workspaces) live in the public schema while workspace-specific data (boards, tasks) live in isolated per-workspace schemas.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        DATABASE [c3-3]                                   │\n│                    PostgreSQL 16 + Prisma ORM                            │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                       PUBLIC SCHEMA                                 │ │\n│  │                    (Global/Cross-tenant data)                       │ │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │ │\n│  │  │   users     │ │ workspaces  │ │   team_     │ │  invites    │  │ │\n│  │  │             │ │             │ │ memberships │ │             │  │ │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │ │\n│  │  ┌─────────────┐ ┌─────────────┐                                   │ │\n│  │  │   refresh   │ │   audit_    │                                   │ │\n│  │  │   tokens    │ │    log      │                                   │ │\n│  │  └─────────────┘ └─────────────┘                                   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                     WORKSPACE SCHEMAS                               │ │\n│  │               (Isolated per-tenant data)                            │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐  │ │\n│  │  │    ws_{workspace_id_1}      │  │    ws_{workspace_id_2}      │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ boards │ │  columns   │ │  │  │ boards │ │  columns   │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ tasks  │ │  comments  │ │  │  │ tasks  │ │  comments  │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  │  ┌────────┐ ┌────────────┐ │  │  ┌────────┐ ┌────────────┐ │  │ │\n│  │  │  │ labels │ │attachments │ │  │  │ labels │ │attachments │ │  │ │\n│  │  │  └────────┘ └────────────┘ │  │  └────────┘ └────────────┘ │  │ │\n│  │  └─────────────────────────────┘  └─────────────────────────────┘  │ │\n│  │                                                                     │ │\n│  │  ... additional workspace schemas ...                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Schema Design\n\n### Public Schema - Global Entities\n\n```sql\n-- users: Authenticated users from Google OAuth\nCREATE TABLE public.users (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    google_id       VARCHAR(255) UNIQUE NOT NULL,\n    email           VARCHAR(255) UNIQUE NOT NULL,\n    name            VARCHAR(255) NOT NULL,\n    avatar_url      VARCHAR(500),\n    preferences     JSONB DEFAULT '{}',\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- workspaces: Multi-tenant containers\nCREATE TABLE public.workspaces (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    slug            VARCHAR(100) UNIQUE NOT NULL,\n    owner_id        UUID NOT NULL REFERENCES users(id),\n    settings        JSONB DEFAULT '{}',\n    schema_name     VARCHAR(100) UNIQUE NOT NULL,  -- ws_{uuid}\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- team_memberships: User <-> Workspace relationship\nCREATE TABLE public.team_memberships (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    joined_at       TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(user_id, workspace_id),\n    CHECK (role IN ('owner', 'admin', 'member', 'guest'))\n);\n\n-- invites: Pending workspace invitations\nCREATE TABLE public.invites (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    workspace_id    UUID NOT NULL REFERENCES workspaces(id),\n    email           VARCHAR(255) NOT NULL,\n    role            VARCHAR(50) NOT NULL DEFAULT 'member',\n    invited_by      UUID NOT NULL REFERENCES users(id),\n    token           VARCHAR(255) UNIQUE NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    accepted_at     TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- refresh_tokens: JWT refresh token storage\nCREATE TABLE public.refresh_tokens (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID NOT NULL REFERENCES users(id),\n    token_hash      VARCHAR(255) NOT NULL,\n    expires_at      TIMESTAMPTZ NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    revoked_at      TIMESTAMPTZ\n);\n\n-- audit_log: System-wide audit trail\nCREATE TABLE public.audit_log (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id         UUID REFERENCES users(id),\n    workspace_id    UUID REFERENCES workspaces(id),\n    action          VARCHAR(100) NOT NULL,\n    entity_type     VARCHAR(100) NOT NULL,\n    entity_id       UUID,\n    changes         JSONB,\n    ip_address      INET,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n### Workspace Schema - Tenant Entities\n\n```sql\n-- Template applied to each workspace schema (ws_{workspace_id})\n\n-- boards: Task board containers\nCREATE TABLE boards (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(255) NOT NULL,\n    description     TEXT,\n    is_archived     BOOLEAN DEFAULT FALSE,\n    position        INTEGER NOT NULL DEFAULT 0,\n    created_by      UUID NOT NULL,  -- References public.users\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- columns: Board columns (e.g., To Do, In Progress, Done)\nCREATE TABLE columns (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    board_id        UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n    name            VARCHAR(255) NOT NULL,\n    color           VARCHAR(7),  -- Hex color code\n    position        INTEGER NOT NULL,\n    wip_limit       INTEGER,     -- Optional work-in-progress limit\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- tasks: Individual task items\nCREATE TABLE tasks (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    column_id       UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n    title           VARCHAR(500) NOT NULL,\n    description     TEXT,\n    position        INTEGER NOT NULL,\n    priority        VARCHAR(20) DEFAULT 'medium',\n    due_date        DATE,\n    assignee_id     UUID,        -- References public.users\n    created_by      UUID NOT NULL,\n    completed_at    TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW(),\n    updated_at      TIMESTAMPTZ DEFAULT NOW(),\n    CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- comments: Task comments/discussion\nCREATE TABLE comments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    user_id         UUID NOT NULL,  -- References public.users\n    content         TEXT NOT NULL,\n    edited_at       TIMESTAMPTZ,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- labels: Task labels/tags\nCREATE TABLE labels (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name            VARCHAR(100) NOT NULL,\n    color           VARCHAR(7) NOT NULL,\n    UNIQUE(name)\n);\n\n-- task_labels: Many-to-many relationship\nCREATE TABLE task_labels (\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    label_id        UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n    PRIMARY KEY (task_id, label_id)\n);\n\n-- attachments: File attachments metadata\nCREATE TABLE attachments (\n    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    task_id         UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n    filename        VARCHAR(255) NOT NULL,\n    file_url        VARCHAR(1000) NOT NULL,\n    file_size       BIGINT NOT NULL,\n    mime_type       VARCHAR(100) NOT NULL,\n    uploaded_by     UUID NOT NULL,\n    created_at      TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n## Entity Relationship Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                         DATA MODEL                                       │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  PUBLIC SCHEMA:                                                          │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   users    │───────<│team_memberships │>───────│ workspaces │        │\n│  │            │   1:N  │                 │  N:1   │            │        │\n│  │ - id       │        │ - user_id       │        │ - id       │        │\n│  │ - email    │        │ - workspace_id  │        │ - name     │        │\n│  │ - name     │        │ - role          │        │ - owner_id │        │\n│  └────────────┘        └─────────────────┘        └────────────┘        │\n│        │                                                 │               │\n│        │ 1:N                                            │               │\n│        ▼                                                │               │\n│  ┌────────────┐                                         │               │\n│  │  invites   │─────────────────────────────────────────┘               │\n│  │            │                                    N:1                  │\n│  └────────────┘                                                          │\n│                                                                          │\n│  WORKSPACE SCHEMA (ws_{id}):                                            │\n│                                                                          │\n│  ┌────────────┐        ┌─────────────────┐        ┌────────────┐        │\n│  │   boards   │───────<│    columns      │>───────│   tasks    │        │\n│  │            │   1:N  │                 │  1:N   │            │        │\n│  │ - id       │        │ - id            │        │ - id       │        │\n│  │ - name     │        │ - board_id      │        │ - column_id│        │\n│  └────────────┘        │ - position      │        │ - title    │        │\n│                        └─────────────────┘        │ - position │        │\n│                                                   └────────────┘        │\n│                                                         │               │\n│                          ┌──────────────────────────────┤               │\n│                          │                    1:N       │ 1:N           │\n│                          ▼                              ▼               │\n│                    ┌────────────┐              ┌────────────┐           │\n│                    │  comments  │              │task_labels │           │\n│                    │            │              │            │           │\n│                    └────────────┘              └────────────┘           │\n│                                                      │                  │\n│                                                      │ N:1              │\n│                                                      ▼                  │\n│                                                ┌────────────┐           │\n│                                                │   labels   │           │\n│                                                └────────────┘           │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Indexes\n\n```sql\n-- Public schema indexes\nCREATE INDEX idx_users_google_id ON public.users(google_id);\nCREATE INDEX idx_users_email ON public.users(email);\nCREATE INDEX idx_team_memberships_user ON public.team_memberships(user_id);\nCREATE INDEX idx_team_memberships_workspace ON public.team_memberships(workspace_id);\nCREATE INDEX idx_invites_token ON public.invites(token);\nCREATE INDEX idx_invites_email ON public.invites(email);\nCREATE INDEX idx_refresh_tokens_user ON public.refresh_tokens(user_id);\nCREATE INDEX idx_audit_log_workspace ON public.audit_log(workspace_id, created_at);\n\n-- Workspace schema indexes (applied to each ws_{id} schema)\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n```\n\n## Multi-Tenancy Implementation\n\n### Schema Provisioning\n\nWhen a workspace is created:\n\n```typescript\n// foundation/database/tenant.ts\nasync function provisionWorkspaceSchema(workspaceId: string): Promise<void> {\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await prisma.$executeRaw`CREATE SCHEMA IF NOT EXISTS ${schemaName}`;\n\n  // Apply workspace schema template\n  await prisma.$executeRaw`SET search_path TO ${schemaName}`;\n  await applyWorkspaceSchemaTemplate();\n  await prisma.$executeRaw`SET search_path TO public`;\n\n  // Update workspace record\n  await prisma.workspace.update({\n    where: { id: workspaceId },\n    data: { schemaName }\n  });\n}\n```\n\n### Query Routing\n\n```typescript\n// middleware/workspace.ts\nasync function workspaceContext(req: Request, res: Response, next: NextFunction) {\n  const workspaceId = req.headers['x-workspace-id'] as string;\n\n  if (!workspaceId) {\n    return res.status(400).json({ error: 'Workspace ID required' });\n  }\n\n  const workspace = await prisma.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    return res.status(404).json({ error: 'Workspace not found' });\n  }\n\n  // Set schema for this request\n  req.workspaceSchema = workspace.schemaName;\n  await prisma.$executeRaw`SET search_path TO ${workspace.schemaName}, public`;\n\n  next();\n}\n```\n\n## Prisma Configuration\n\n```prisma\n// prisma/schema.prisma\n\ngenerator client {\n  provider        = \"prisma-client-js\"\n  previewFeatures = [\"multiSchema\"]\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n  schemas  = [\"public\"]  // Dynamic schemas handled at runtime\n}\n\n// Public schema models\nmodel User {\n  id            String   @id @default(uuid())\n  googleId      String   @unique @map(\"google_id\")\n  email         String   @unique\n  name          String\n  avatarUrl     String?  @map(\"avatar_url\")\n  preferences   Json     @default(\"{}\")\n  createdAt     DateTime @default(now()) @map(\"created_at\")\n  updatedAt     DateTime @updatedAt @map(\"updated_at\")\n\n  memberships   TeamMembership[]\n  ownedWorkspaces Workspace[]\n\n  @@map(\"users\")\n  @@schema(\"public\")\n}\n\n// ... additional models\n```\n\n## Backup Strategy\n\n| Type | Frequency | Retention | Method |\n|------|-----------|-----------|--------|\n| Full backup | Daily | 30 days | pg_dump |\n| WAL archiving | Continuous | 7 days | Archive to S3 |\n| Point-in-time | On demand | N/A | WAL replay |\n\n## Performance Considerations\n\n- **Connection pooling**: PgBouncer for connection management\n- **Query optimization**: EXPLAIN ANALYZE for slow queries\n- **Partitioning**: Consider time-based partitioning for audit_log\n- **Vacuum**: Automated vacuum settings tuned for update-heavy tables\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:13:58.023Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-4-cache.md",
        "content": "# c3-4: Cache (Redis)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nRedis serves dual purposes in TaskFlow: high-performance caching layer for frequently accessed data, and pub/sub backbone for real-time event distribution across WebSocket server instances.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                           CACHE [c3-4]                                   │\n│                      Redis 7.x (Single Instance)                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        CACHING LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │ │\n│  │  │  Session Cache  │ │   User Cache    │ │  Board Cache    │       │ │\n│  │  │                 │ │                 │ │                 │       │ │\n│  │  │ session:{id}    │ │ user:{id}       │ │ board:{id}      │       │ │\n│  │  │ JWT blacklist   │ │ user:ws:{id}    │ │ board:tasks:{id}│       │ │\n│  │  │ TTL: 15min      │ │ TTL: 5min       │ │ TTL: 2min       │       │ │\n│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘       │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐                           │ │\n│  │  │  Rate Limiting  │ │  Feature Flags  │                           │ │\n│  │  │                 │ │                 │                           │ │\n│  │  │ rate:{user}:{ep}│ │ flags:{key}     │                           │ │\n│  │  │ TTL: 1min       │ │ TTL: 30sec      │                           │ │\n│  │  └─────────────────┘ └─────────────────┘                           │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        PUB/SUB LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────────────────────────────────────┐   │ │\n│  │  │                    CHANNELS                                  │   │ │\n│  │  │                                                              │   │ │\n│  │  │  board:{boardId}        → Task/column events per board      │   │ │\n│  │  │  workspace:{wsId}       → Workspace-wide events             │   │ │\n│  │  │  user:{userId}          → User-specific notifications       │   │ │\n│  │  │  system                 → System-wide broadcasts            │   │ │\n│  │  └─────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                      PRESENCE TRACKING                              │ │\n│  │                                                                     │ │\n│  │  board:{boardId}:presence  → SET of active user IDs               │ │\n│  │  user:{userId}:status      → online/away/offline                  │ │\n│  │  TTL: 30sec (with heartbeat refresh)                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Key Patterns\n\n### Naming Convention\n\n```\n{namespace}:{entity}:{identifier}:{subkey}\n\nExamples:\n  session:abc123                    # User session data\n  user:uuid-here                    # User profile cache\n  user:uuid-here:workspaces        # User's workspace list\n  board:uuid-here                   # Board metadata cache\n  board:uuid-here:tasks            # Board tasks cache\n  board:uuid-here:presence         # Active users on board\n  rate:user-uuid:POST:/api/tasks   # Rate limit counter\n  lock:board:uuid-here             # Distributed lock\n```\n\n### TTL Strategy\n\n| Data Type | TTL | Reason |\n|-----------|-----|--------|\n| Session data | 15 min | Match JWT access token expiry |\n| User profile | 5 min | Infrequent changes, high read rate |\n| Board data | 2 min | Moderate change rate, critical for performance |\n| Rate limits | 1 min | Sliding window implementation |\n| Presence | 30 sec | Requires heartbeat refresh |\n| Feature flags | 30 sec | Allow quick flag updates |\n\n## Caching Patterns\n\n### Cache-Aside (Lazy Loading)\n\n```typescript\n// foundation/cache/patterns.ts\nasync function getWithCache<T>(\n  key: string,\n  ttlSeconds: number,\n  fetcher: () => Promise<T>\n): Promise<T> {\n  // Try cache first\n  const cached = await redis.get(key);\n  if (cached) {\n    return JSON.parse(cached);\n  }\n\n  // Fetch from source\n  const data = await fetcher();\n\n  // Store in cache\n  await redis.setex(key, ttlSeconds, JSON.stringify(data));\n\n  return data;\n}\n\n// Usage\nconst user = await getWithCache(\n  `user:${userId}`,\n  300, // 5 minutes\n  () => prisma.user.findUnique({ where: { id: userId } })\n);\n```\n\n### Write-Through (Invalidate on Write)\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nasync function updateTask(taskId: string, data: UpdateTaskDto) {\n  // Update database\n  const task = await prisma.task.update({\n    where: { id: taskId },\n    data\n  });\n\n  // Invalidate related caches\n  const boardId = task.column.boardId;\n  await redis.del(`board:${boardId}:tasks`);\n\n  // Publish update event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'task:updated',\n    payload: task\n  }));\n\n  return task;\n}\n```\n\n## Pub/Sub Architecture\n\n### Event Flow\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                      REAL-TIME EVENT FLOW                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌──────────────┐                                                       │\n│  │   Client A   │ ──── WebSocket ────┐                                  │\n│  │  (Browser)   │                    │                                  │\n│  └──────────────┘                    │                                  │\n│                                      ▼                                  │\n│                              ┌──────────────┐                           │\n│                              │   Server 1   │                           │\n│                              │  (Socket.io) │                           │\n│                              └───────┬──────┘                           │\n│                                      │                                  │\n│                                      │ PUBLISH board:{boardId}          │\n│                                      ▼                                  │\n│                           ┌────────────────────┐                        │\n│                           │                    │                        │\n│                           │    REDIS PUB/SUB   │                        │\n│                           │                    │                        │\n│                           └─────────┬──────────┘                        │\n│                                     │                                   │\n│                    ┌────────────────┼────────────────┐                  │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Server 1   │ │   Server 2   │ │   Server N   │          │\n│            │  (receives)  │ │  (receives)  │ │  (receives)  │          │\n│            └───────┬──────┘ └───────┬──────┘ └───────┬──────┘          │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Client A   │ │   Client B   │ │   Client C   │          │\n│            │  (Browser)   │ │  (Browser)   │ │  (Browser)   │          │\n│            └──────────────┘ └──────────────┘ └──────────────┘          │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### Socket.io Redis Adapter\n\n```typescript\n// foundation/websocket/server.ts\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { createClient } from 'redis';\n\nconst pubClient = createClient({ url: process.env.REDIS_URL });\nconst subClient = pubClient.duplicate();\n\nawait Promise.all([pubClient.connect(), subClient.connect()]);\n\nio.adapter(createAdapter(pubClient, subClient));\n```\n\n### Event Types\n\n```typescript\n// foundation/events/types.ts\ninterface BoardEvent {\n  type:\n    | 'task:created'\n    | 'task:updated'\n    | 'task:deleted'\n    | 'task:moved'\n    | 'column:created'\n    | 'column:updated'\n    | 'column:deleted'\n    | 'column:reordered'\n    | 'member:joined'\n    | 'member:left';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n\ninterface WorkspaceEvent {\n  type:\n    | 'board:created'\n    | 'board:updated'\n    | 'board:deleted'\n    | 'member:invited'\n    | 'member:removed'\n    | 'settings:updated';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n```\n\n## Rate Limiting\n\n### Sliding Window Implementation\n\n```typescript\n// middleware/rateLimiter.ts\nasync function checkRateLimit(\n  userId: string,\n  endpoint: string,\n  limit: number,\n  windowSec: number\n): Promise<{ allowed: boolean; remaining: number }> {\n  const key = `rate:${userId}:${endpoint}`;\n  const now = Date.now();\n  const windowStart = now - windowSec * 1000;\n\n  // Remove old entries\n  await redis.zremrangebyscore(key, 0, windowStart);\n\n  // Count current window\n  const count = await redis.zcard(key);\n\n  if (count >= limit) {\n    return { allowed: false, remaining: 0 };\n  }\n\n  // Add current request\n  await redis.zadd(key, now, `${now}-${Math.random()}`);\n  await redis.expire(key, windowSec);\n\n  return { allowed: true, remaining: limit - count - 1 };\n}\n```\n\n### Default Limits\n\n| Endpoint Pattern | Limit | Window |\n|-----------------|-------|--------|\n| `POST /api/*` | 100 | 1 minute |\n| `GET /api/*` | 300 | 1 minute |\n| `POST /auth/*` | 10 | 1 minute |\n| WebSocket events | 60 | 1 minute |\n\n## Presence Tracking\n\n```typescript\n// foundation/cache/presence.ts\nconst PRESENCE_TTL = 30; // seconds\nconst HEARTBEAT_INTERVAL = 15; // seconds\n\nasync function joinBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n\n  // Publish join event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:joined',\n    payload: { userId }\n  }));\n}\n\nasync function heartbeat(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n}\n\nasync function leaveBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.srem(key, userId);\n\n  // Publish leave event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:left',\n    payload: { userId }\n  }));\n}\n\nasync function getBoardPresence(boardId: string): Promise<string[]> {\n  return redis.smembers(`board:${boardId}:presence`);\n}\n```\n\n## Configuration\n\n```typescript\n// foundation/cache/client.ts\nimport Redis from 'ioredis';\n\nconst redis = new Redis({\n  host: process.env.REDIS_HOST || 'localhost',\n  port: parseInt(process.env.REDIS_PORT || '6379'),\n  password: process.env.REDIS_PASSWORD,\n  db: parseInt(process.env.REDIS_DB || '0'),\n\n  // Connection settings\n  maxRetriesPerRequest: 3,\n  retryDelayOnFailover: 100,\n  enableReadyCheck: true,\n  connectTimeout: 10000,\n\n  // Reconnection\n  retryStrategy(times) {\n    const delay = Math.min(times * 50, 2000);\n    return delay;\n  }\n});\n\nredis.on('error', (err) => logger.error('Redis error:', err));\nredis.on('connect', () => logger.info('Redis connected'));\n\nexport { redis };\n```\n\n## Monitoring\n\nKey metrics to track:\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| Hit rate | < 80% | Review cache keys and TTLs |\n| Memory usage | > 80% | Increase instance size or reduce TTLs |\n| Connection count | > 80% of max | Scale horizontally |\n| Pub/sub lag | > 100ms | Check network, consider Redis Cluster |\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:13:58.044Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/c3-4-cache.md",
        "content": "# c3-4: Cache (Redis)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nRedis serves dual purposes in TaskFlow: high-performance caching layer for frequently accessed data, and pub/sub backbone for real-time event distribution across WebSocket server instances.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                           CACHE [c3-4]                                   │\n│                      Redis 7.x (Single Instance)                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        CACHING LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │ │\n│  │  │  Session Cache  │ │   User Cache    │ │  Board Cache    │       │ │\n│  │  │                 │ │                 │ │                 │       │ │\n│  │  │ session:{id}    │ │ user:{id}       │ │ board:{id}      │       │ │\n│  │  │ JWT blacklist   │ │ user:ws:{id}    │ │ board:tasks:{id}│       │ │\n│  │  │ TTL: 15min      │ │ TTL: 5min       │ │ TTL: 2min       │       │ │\n│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘       │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐                           │ │\n│  │  │  Rate Limiting  │ │  Feature Flags  │                           │ │\n│  │  │                 │ │                 │                           │ │\n│  │  │ rate:{user}:{ep}│ │ flags:{key}     │                           │ │\n│  │  │ TTL: 1min       │ │ TTL: 30sec      │                           │ │\n│  │  └─────────────────┘ └─────────────────┘                           │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        PUB/SUB LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────────────────────────────────────┐   │ │\n│  │  │                    CHANNELS                                  │   │ │\n│  │  │                                                              │   │ │\n│  │  │  board:{boardId}        → Task/column events per board      │   │ │\n│  │  │  workspace:{wsId}       → Workspace-wide events             │   │ │\n│  │  │  user:{userId}          → User-specific notifications       │   │ │\n│  │  │  system                 → System-wide broadcasts            │   │ │\n│  │  └─────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                      PRESENCE TRACKING                              │ │\n│  │                                                                     │ │\n│  │  board:{boardId}:presence  → SET of active user IDs               │ │\n│  │  user:{userId}:status      → online/away/offline                  │ │\n│  │  TTL: 30sec (with heartbeat refresh)                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Key Patterns\n\n### Naming Convention\n\n```\n{namespace}:{entity}:{identifier}:{subkey}\n\nExamples:\n  session:abc123                    # User session data\n  user:uuid-here                    # User profile cache\n  user:uuid-here:workspaces        # User's workspace list\n  board:uuid-here                   # Board metadata cache\n  board:uuid-here:tasks            # Board tasks cache\n  board:uuid-here:presence         # Active users on board\n  rate:user-uuid:POST:/api/tasks   # Rate limit counter\n  lock:board:uuid-here             # Distributed lock\n```\n\n### TTL Strategy\n\n| Data Type | TTL | Reason |\n|-----------|-----|--------|\n| Session data | 15 min | Match JWT access token expiry |\n| User profile | 5 min | Infrequent changes, high read rate |\n| Board data | 2 min | Moderate change rate, critical for performance |\n| Rate limits | 1 min | Sliding window implementation |\n| Presence | 30 sec | Requires heartbeat refresh |\n| Feature flags | 30 sec | Allow quick flag updates |\n\n## Caching Patterns\n\n### Cache-Aside (Lazy Loading)\n\n```typescript\n// foundation/cache/patterns.ts\nasync function getWithCache<T>(\n  key: string,\n  ttlSeconds: number,\n  fetcher: () => Promise<T>\n): Promise<T> {\n  // Try cache first\n  const cached = await redis.get(key);\n  if (cached) {\n    return JSON.parse(cached);\n  }\n\n  // Fetch from source\n  const data = await fetcher();\n\n  // Store in cache\n  await redis.setex(key, ttlSeconds, JSON.stringify(data));\n\n  return data;\n}\n\n// Usage\nconst user = await getWithCache(\n  `user:${userId}`,\n  300, // 5 minutes\n  () => prisma.user.findUnique({ where: { id: userId } })\n);\n```\n\n### Write-Through (Invalidate on Write)\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nasync function updateTask(taskId: string, data: UpdateTaskDto) {\n  // Update database\n  const task = await prisma.task.update({\n    where: { id: taskId },\n    data\n  });\n\n  // Invalidate related caches\n  const boardId = task.column.boardId;\n  await redis.del(`board:${boardId}:tasks`);\n\n  // Publish update event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'task:updated',\n    payload: task\n  }));\n\n  return task;\n}\n```\n\n## Pub/Sub Architecture\n\n### Event Flow\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                      REAL-TIME EVENT FLOW                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌──────────────┐                                                       │\n│  │   Client A   │ ──── WebSocket ────┐                                  │\n│  │  (Browser)   │                    │                                  │\n│  └──────────────┘                    │                                  │\n│                                      ▼                                  │\n│                              ┌──────────────┐                           │\n│                              │   Server 1   │                           │\n│                              │  (Socket.io) │                           │\n│                              └───────┬──────┘                           │\n│                                      │                                  │\n│                                      │ PUBLISH board:{boardId}          │\n│                                      ▼                                  │\n│                           ┌────────────────────┐                        │\n│                           │                    │                        │\n│                           │    REDIS PUB/SUB   │                        │\n│                           │                    │                        │\n│                           └─────────┬──────────┘                        │\n│                                     │                                   │\n│                    ┌────────────────┼────────────────┐                  │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Server 1   │ │   Server 2   │ │   Server N   │          │\n│            │  (receives)  │ │  (receives)  │ │  (receives)  │          │\n│            └───────┬──────┘ └───────┬──────┘ └───────┬──────┘          │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Client A   │ │   Client B   │ │   Client C   │          │\n│            │  (Browser)   │ │  (Browser)   │ │  (Browser)   │          │\n│            └──────────────┘ └──────────────┘ └──────────────┘          │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### Socket.io Redis Adapter\n\n```typescript\n// foundation/websocket/server.ts\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { createClient } from 'redis';\n\nconst pubClient = createClient({ url: process.env.REDIS_URL });\nconst subClient = pubClient.duplicate();\n\nawait Promise.all([pubClient.connect(), subClient.connect()]);\n\nio.adapter(createAdapter(pubClient, subClient));\n```\n\n### Event Types\n\n```typescript\n// foundation/events/types.ts\ninterface BoardEvent {\n  type:\n    | 'task:created'\n    | 'task:updated'\n    | 'task:deleted'\n    | 'task:moved'\n    | 'column:created'\n    | 'column:updated'\n    | 'column:deleted'\n    | 'column:reordered'\n    | 'member:joined'\n    | 'member:left';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n\ninterface WorkspaceEvent {\n  type:\n    | 'board:created'\n    | 'board:updated'\n    | 'board:deleted'\n    | 'member:invited'\n    | 'member:removed'\n    | 'settings:updated';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n```\n\n## Rate Limiting\n\n### Sliding Window Implementation\n\n```typescript\n// middleware/rateLimiter.ts\nasync function checkRateLimit(\n  userId: string,\n  endpoint: string,\n  limit: number,\n  windowSec: number\n): Promise<{ allowed: boolean; remaining: number }> {\n  const key = `rate:${userId}:${endpoint}`;\n  const now = Date.now();\n  const windowStart = now - windowSec * 1000;\n\n  // Remove old entries\n  await redis.zremrangebyscore(key, 0, windowStart);\n\n  // Count current window\n  const count = await redis.zcard(key);\n\n  if (count >= limit) {\n    return { allowed: false, remaining: 0 };\n  }\n\n  // Add current request\n  await redis.zadd(key, now, `${now}-${Math.random()}`);\n  await redis.expire(key, windowSec);\n\n  return { allowed: true, remaining: limit - count - 1 };\n}\n```\n\n### Default Limits\n\n| Endpoint Pattern | Limit | Window |\n|-----------------|-------|--------|\n| `POST /api/*` | 100 | 1 minute |\n| `GET /api/*` | 300 | 1 minute |\n| `POST /auth/*` | 10 | 1 minute |\n| WebSocket events | 60 | 1 minute |\n\n## Presence Tracking\n\n```typescript\n// foundation/cache/presence.ts\nconst PRESENCE_TTL = 30; // seconds\nconst HEARTBEAT_INTERVAL = 15; // seconds\n\nasync function joinBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n\n  // Publish join event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:joined',\n    payload: { userId }\n  }));\n}\n\nasync function heartbeat(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n}\n\nasync function leaveBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.srem(key, userId);\n\n  // Publish leave event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:left',\n    payload: { userId }\n  }));\n}\n\nasync function getBoardPresence(boardId: string): Promise<string[]> {\n  return redis.smembers(`board:${boardId}:presence`);\n}\n```\n\n## Configuration\n\n```typescript\n// foundation/cache/client.ts\nimport Redis from 'ioredis';\n\nconst redis = new Redis({\n  host: process.env.REDIS_HOST || 'localhost',\n  port: parseInt(process.env.REDIS_PORT || '6379'),\n  password: process.env.REDIS_PASSWORD,\n  db: parseInt(process.env.REDIS_DB || '0'),\n\n  // Connection settings\n  maxRetriesPerRequest: 3,\n  retryDelayOnFailover: 100,\n  enableReadyCheck: true,\n  connectTimeout: 10000,\n\n  // Reconnection\n  retryStrategy(times) {\n    const delay = Math.min(times * 50, 2000);\n    return delay;\n  }\n});\n\nredis.on('error', (err) => logger.error('Redis error:', err));\nredis.on('connect', () => logger.info('Redis connected'));\n\nexport { redis };\n```\n\n## Monitoring\n\nKey metrics to track:\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| Hit rate | < 80% | Review cache keys and TTLs |\n| Memory usage | > 80% | Increase instance size or reduce TTLs |\n| Connection count | > 80% of max | Scale horizontally |\n| Pub/sub lag | > 100ms | Check network, consider Redis Cluster |\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/c3-4-cache.md",
        "content": "# c3-4: Cache (Redis)\n\n> **Level**: Container | **Type**: Data Store | **Parent**: [c3-0](c3-0-context.md)\n\n## Overview\n\nRedis serves dual purposes in TaskFlow: high-performance caching layer for frequently accessed data, and pub/sub backbone for real-time event distribution across WebSocket server instances.\n\n## Container Diagram\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                           CACHE [c3-4]                                   │\n│                      Redis 7.x (Single Instance)                         │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        CACHING LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐       │ │\n│  │  │  Session Cache  │ │   User Cache    │ │  Board Cache    │       │ │\n│  │  │                 │ │                 │ │                 │       │ │\n│  │  │ session:{id}    │ │ user:{id}       │ │ board:{id}      │       │ │\n│  │  │ JWT blacklist   │ │ user:ws:{id}    │ │ board:tasks:{id}│       │ │\n│  │  │ TTL: 15min      │ │ TTL: 5min       │ │ TTL: 2min       │       │ │\n│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘       │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────┐ ┌─────────────────┐                           │ │\n│  │  │  Rate Limiting  │ │  Feature Flags  │                           │ │\n│  │  │                 │ │                 │                           │ │\n│  │  │ rate:{user}:{ep}│ │ flags:{key}     │                           │ │\n│  │  │ TTL: 1min       │ │ TTL: 30sec      │                           │ │\n│  │  └─────────────────┘ └─────────────────┘                           │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                        PUB/SUB LAYER                                │ │\n│  │                                                                     │ │\n│  │  ┌─────────────────────────────────────────────────────────────┐   │ │\n│  │  │                    CHANNELS                                  │   │ │\n│  │  │                                                              │   │ │\n│  │  │  board:{boardId}        → Task/column events per board      │   │ │\n│  │  │  workspace:{wsId}       → Workspace-wide events             │   │ │\n│  │  │  user:{userId}          → User-specific notifications       │   │ │\n│  │  │  system                 → System-wide broadcasts            │   │ │\n│  │  └─────────────────────────────────────────────────────────────┘   │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐ │\n│  │                      PRESENCE TRACKING                              │ │\n│  │                                                                     │ │\n│  │  board:{boardId}:presence  → SET of active user IDs               │ │\n│  │  user:{userId}:status      → online/away/offline                  │ │\n│  │  TTL: 30sec (with heartbeat refresh)                              │ │\n│  └────────────────────────────────────────────────────────────────────┘ │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n## Key Patterns\n\n### Naming Convention\n\n```\n{namespace}:{entity}:{identifier}:{subkey}\n\nExamples:\n  session:abc123                    # User session data\n  user:uuid-here                    # User profile cache\n  user:uuid-here:workspaces        # User's workspace list\n  board:uuid-here                   # Board metadata cache\n  board:uuid-here:tasks            # Board tasks cache\n  board:uuid-here:presence         # Active users on board\n  rate:user-uuid:POST:/api/tasks   # Rate limit counter\n  lock:board:uuid-here             # Distributed lock\n```\n\n### TTL Strategy\n\n| Data Type | TTL | Reason |\n|-----------|-----|--------|\n| Session data | 15 min | Match JWT access token expiry |\n| User profile | 5 min | Infrequent changes, high read rate |\n| Board data | 2 min | Moderate change rate, critical for performance |\n| Rate limits | 1 min | Sliding window implementation |\n| Presence | 30 sec | Requires heartbeat refresh |\n| Feature flags | 30 sec | Allow quick flag updates |\n\n## Caching Patterns\n\n### Cache-Aside (Lazy Loading)\n\n```typescript\n// foundation/cache/patterns.ts\nasync function getWithCache<T>(\n  key: string,\n  ttlSeconds: number,\n  fetcher: () => Promise<T>\n): Promise<T> {\n  // Try cache first\n  const cached = await redis.get(key);\n  if (cached) {\n    return JSON.parse(cached);\n  }\n\n  // Fetch from source\n  const data = await fetcher();\n\n  // Store in cache\n  await redis.setex(key, ttlSeconds, JSON.stringify(data));\n\n  return data;\n}\n\n// Usage\nconst user = await getWithCache(\n  `user:${userId}`,\n  300, // 5 minutes\n  () => prisma.user.findUnique({ where: { id: userId } })\n);\n```\n\n### Write-Through (Invalidate on Write)\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nasync function updateTask(taskId: string, data: UpdateTaskDto) {\n  // Update database\n  const task = await prisma.task.update({\n    where: { id: taskId },\n    data\n  });\n\n  // Invalidate related caches\n  const boardId = task.column.boardId;\n  await redis.del(`board:${boardId}:tasks`);\n\n  // Publish update event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'task:updated',\n    payload: task\n  }));\n\n  return task;\n}\n```\n\n## Pub/Sub Architecture\n\n### Event Flow\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                      REAL-TIME EVENT FLOW                                │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│  ┌──────────────┐                                                       │\n│  │   Client A   │ ──── WebSocket ────┐                                  │\n│  │  (Browser)   │                    │                                  │\n│  └──────────────┘                    │                                  │\n│                                      ▼                                  │\n│                              ┌──────────────┐                           │\n│                              │   Server 1   │                           │\n│                              │  (Socket.io) │                           │\n│                              └───────┬──────┘                           │\n│                                      │                                  │\n│                                      │ PUBLISH board:{boardId}          │\n│                                      ▼                                  │\n│                           ┌────────────────────┐                        │\n│                           │                    │                        │\n│                           │    REDIS PUB/SUB   │                        │\n│                           │                    │                        │\n│                           └─────────┬──────────┘                        │\n│                                     │                                   │\n│                    ┌────────────────┼────────────────┐                  │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Server 1   │ │   Server 2   │ │   Server N   │          │\n│            │  (receives)  │ │  (receives)  │ │  (receives)  │          │\n│            └───────┬──────┘ └───────┬──────┘ └───────┬──────┘          │\n│                    │                │                │                  │\n│                    ▼                ▼                ▼                  │\n│            ┌──────────────┐ ┌──────────────┐ ┌──────────────┐          │\n│            │   Client A   │ │   Client B   │ │   Client C   │          │\n│            │  (Browser)   │ │  (Browser)   │ │  (Browser)   │          │\n│            └──────────────┘ └──────────────┘ └──────────────┘          │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### Socket.io Redis Adapter\n\n```typescript\n// foundation/websocket/server.ts\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { createClient } from 'redis';\n\nconst pubClient = createClient({ url: process.env.REDIS_URL });\nconst subClient = pubClient.duplicate();\n\nawait Promise.all([pubClient.connect(), subClient.connect()]);\n\nio.adapter(createAdapter(pubClient, subClient));\n```\n\n### Event Types\n\n```typescript\n// foundation/events/types.ts\ninterface BoardEvent {\n  type:\n    | 'task:created'\n    | 'task:updated'\n    | 'task:deleted'\n    | 'task:moved'\n    | 'column:created'\n    | 'column:updated'\n    | 'column:deleted'\n    | 'column:reordered'\n    | 'member:joined'\n    | 'member:left';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n\ninterface WorkspaceEvent {\n  type:\n    | 'board:created'\n    | 'board:updated'\n    | 'board:deleted'\n    | 'member:invited'\n    | 'member:removed'\n    | 'settings:updated';\n  payload: unknown;\n  timestamp: number;\n  userId: string;\n}\n```\n\n## Rate Limiting\n\n### Sliding Window Implementation\n\n```typescript\n// middleware/rateLimiter.ts\nasync function checkRateLimit(\n  userId: string,\n  endpoint: string,\n  limit: number,\n  windowSec: number\n): Promise<{ allowed: boolean; remaining: number }> {\n  const key = `rate:${userId}:${endpoint}`;\n  const now = Date.now();\n  const windowStart = now - windowSec * 1000;\n\n  // Remove old entries\n  await redis.zremrangebyscore(key, 0, windowStart);\n\n  // Count current window\n  const count = await redis.zcard(key);\n\n  if (count >= limit) {\n    return { allowed: false, remaining: 0 };\n  }\n\n  // Add current request\n  await redis.zadd(key, now, `${now}-${Math.random()}`);\n  await redis.expire(key, windowSec);\n\n  return { allowed: true, remaining: limit - count - 1 };\n}\n```\n\n### Default Limits\n\n| Endpoint Pattern | Limit | Window |\n|-----------------|-------|--------|\n| `POST /api/*` | 100 | 1 minute |\n| `GET /api/*` | 300 | 1 minute |\n| `POST /auth/*` | 10 | 1 minute |\n| WebSocket events | 60 | 1 minute |\n\n## Presence Tracking\n\n```typescript\n// foundation/cache/presence.ts\nconst PRESENCE_TTL = 30; // seconds\nconst HEARTBEAT_INTERVAL = 15; // seconds\n\nasync function joinBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n\n  // Publish join event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:joined',\n    payload: { userId }\n  }));\n}\n\nasync function heartbeat(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.sadd(key, userId);\n  await redis.expire(key, PRESENCE_TTL);\n}\n\nasync function leaveBoard(boardId: string, userId: string): Promise<void> {\n  const key = `board:${boardId}:presence`;\n  await redis.srem(key, userId);\n\n  // Publish leave event\n  await redis.publish(`board:${boardId}`, JSON.stringify({\n    type: 'member:left',\n    payload: { userId }\n  }));\n}\n\nasync function getBoardPresence(boardId: string): Promise<string[]> {\n  return redis.smembers(`board:${boardId}:presence`);\n}\n```\n\n## Configuration\n\n```typescript\n// foundation/cache/client.ts\nimport Redis from 'ioredis';\n\nconst redis = new Redis({\n  host: process.env.REDIS_HOST || 'localhost',\n  port: parseInt(process.env.REDIS_PORT || '6379'),\n  password: process.env.REDIS_PASSWORD,\n  db: parseInt(process.env.REDIS_DB || '0'),\n\n  // Connection settings\n  maxRetriesPerRequest: 3,\n  retryDelayOnFailover: 100,\n  enableReadyCheck: true,\n  connectTimeout: 10000,\n\n  // Reconnection\n  retryStrategy(times) {\n    const delay = Math.min(times * 50, 2000);\n    return delay;\n  }\n});\n\nredis.on('error', (err) => logger.error('Redis error:', err));\nredis.on('connect', () => logger.info('Redis connected'));\n\nexport { redis };\n```\n\n## Monitoring\n\nKey metrics to track:\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| Hit rate | < 80% | Review cache keys and TTLs |\n| Memory usage | > 80% | Increase instance size or reduce TTLs |\n| Connection count | > 80% of max | Scale horizontally |\n| Pub/sub lag | > 100ms | Check network, consider Redis Cluster |\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:14:03.498Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "in_progress",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:14:03.505Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "in_progress",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "in_progress",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "pending",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "in_progress",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:14:17.570Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.7-database.md",
        "content": "# c3-2.7: Database Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nPrisma ORM client wrapper providing database connectivity, connection pooling, multi-tenant schema switching, and migration management.\n\n## Responsibilities\n\n- Manage Prisma client lifecycle\n- Handle multi-tenant schema context switching\n- Provide connection pooling and health checks\n- Execute schema migrations\n- Expose typed database queries\n\n## Interface\n\n```typescript\n// foundation/database/client.ts\n\nimport { PrismaClient } from '@prisma/client';\n\nclass DatabaseClient {\n  private prisma: PrismaClient;\n\n  constructor() {\n    this.prisma = new PrismaClient({\n      log: ['query', 'info', 'warn', 'error'],\n      datasources: {\n        db: { url: process.env.DATABASE_URL }\n      }\n    });\n  }\n\n  // Get Prisma client for public schema operations\n  get client(): PrismaClient {\n    return this.prisma;\n  }\n\n  // Execute query in workspace schema context\n  async withWorkspace<T>(\n    schemaName: string,\n    operation: (prisma: PrismaClient) => Promise<T>\n  ): Promise<T> {\n    await this.prisma.$executeRawUnsafe(`SET search_path TO \"${schemaName}\", public`);\n    try {\n      return await operation(this.prisma);\n    } finally {\n      await this.prisma.$executeRawUnsafe('SET search_path TO public');\n    }\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.prisma.$queryRaw`SELECT 1`;\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.prisma.$disconnect();\n  }\n}\n\nexport const db = new DatabaseClient();\n```\n\n## Usage Examples\n\n```typescript\n// Public schema query\nconst user = await db.client.user.findUnique({\n  where: { id: userId }\n});\n\n// Workspace-scoped query\nconst tasks = await db.withWorkspace(workspace.schemaName, async (prisma) => {\n  return prisma.$queryRaw`SELECT * FROM tasks WHERE assignee_id = ${userId}`;\n});\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| Prisma | ORM and query builder |\n| PostgreSQL | Database engine |\n\n## Configuration\n\n```typescript\n// Environment variables\nDATABASE_URL=postgresql://user:pass@localhost:5432/taskflow?schema=public\nDATABASE_POOL_SIZE=10\nDATABASE_CONNECTION_TIMEOUT=5000\n```\n\n## Location\n\n```\npackages/api/src/foundation/database/\n├── client.ts       # Prisma client wrapper\n├── tenant.ts       # Schema provisioning\n├── health.ts       # Health check utilities\n└── index.ts        # Public exports\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:14:17.587Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.7-database.md",
        "content": "# c3-2.7: Database Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nPrisma ORM client wrapper providing database connectivity, connection pooling, multi-tenant schema switching, and migration management.\n\n## Responsibilities\n\n- Manage Prisma client lifecycle\n- Handle multi-tenant schema context switching\n- Provide connection pooling and health checks\n- Execute schema migrations\n- Expose typed database queries\n\n## Interface\n\n```typescript\n// foundation/database/client.ts\n\nimport { PrismaClient } from '@prisma/client';\n\nclass DatabaseClient {\n  private prisma: PrismaClient;\n\n  constructor() {\n    this.prisma = new PrismaClient({\n      log: ['query', 'info', 'warn', 'error'],\n      datasources: {\n        db: { url: process.env.DATABASE_URL }\n      }\n    });\n  }\n\n  // Get Prisma client for public schema operations\n  get client(): PrismaClient {\n    return this.prisma;\n  }\n\n  // Execute query in workspace schema context\n  async withWorkspace<T>(\n    schemaName: string,\n    operation: (prisma: PrismaClient) => Promise<T>\n  ): Promise<T> {\n    await this.prisma.$executeRawUnsafe(`SET search_path TO \"${schemaName}\", public`);\n    try {\n      return await operation(this.prisma);\n    } finally {\n      await this.prisma.$executeRawUnsafe('SET search_path TO public');\n    }\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.prisma.$queryRaw`SELECT 1`;\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.prisma.$disconnect();\n  }\n}\n\nexport const db = new DatabaseClient();\n```\n\n## Usage Examples\n\n```typescript\n// Public schema query\nconst user = await db.client.user.findUnique({\n  where: { id: userId }\n});\n\n// Workspace-scoped query\nconst tasks = await db.withWorkspace(workspace.schemaName, async (prisma) => {\n  return prisma.$queryRaw`SELECT * FROM tasks WHERE assignee_id = ${userId}`;\n});\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| Prisma | ORM and query builder |\n| PostgreSQL | Database engine |\n\n## Configuration\n\n```typescript\n// Environment variables\nDATABASE_URL=postgresql://user:pass@localhost:5432/taskflow?schema=public\nDATABASE_POOL_SIZE=10\nDATABASE_CONNECTION_TIMEOUT=5000\n```\n\n## Location\n\n```\npackages/api/src/foundation/database/\n├── client.ts       # Prisma client wrapper\n├── tenant.ts       # Schema provisioning\n├── health.ts       # Health check utilities\n└── index.ts        # Public exports\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.7-database.md",
        "content": "# c3-2.7: Database Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nPrisma ORM client wrapper providing database connectivity, connection pooling, multi-tenant schema switching, and migration management.\n\n## Responsibilities\n\n- Manage Prisma client lifecycle\n- Handle multi-tenant schema context switching\n- Provide connection pooling and health checks\n- Execute schema migrations\n- Expose typed database queries\n\n## Interface\n\n```typescript\n// foundation/database/client.ts\n\nimport { PrismaClient } from '@prisma/client';\n\nclass DatabaseClient {\n  private prisma: PrismaClient;\n\n  constructor() {\n    this.prisma = new PrismaClient({\n      log: ['query', 'info', 'warn', 'error'],\n      datasources: {\n        db: { url: process.env.DATABASE_URL }\n      }\n    });\n  }\n\n  // Get Prisma client for public schema operations\n  get client(): PrismaClient {\n    return this.prisma;\n  }\n\n  // Execute query in workspace schema context\n  async withWorkspace<T>(\n    schemaName: string,\n    operation: (prisma: PrismaClient) => Promise<T>\n  ): Promise<T> {\n    await this.prisma.$executeRawUnsafe(`SET search_path TO \"${schemaName}\", public`);\n    try {\n      return await operation(this.prisma);\n    } finally {\n      await this.prisma.$executeRawUnsafe('SET search_path TO public');\n    }\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.prisma.$queryRaw`SELECT 1`;\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.prisma.$disconnect();\n  }\n}\n\nexport const db = new DatabaseClient();\n```\n\n## Usage Examples\n\n```typescript\n// Public schema query\nconst user = await db.client.user.findUnique({\n  where: { id: userId }\n});\n\n// Workspace-scoped query\nconst tasks = await db.withWorkspace(workspace.schemaName, async (prisma) => {\n  return prisma.$queryRaw`SELECT * FROM tasks WHERE assignee_id = ${userId}`;\n});\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| Prisma | ORM and query builder |\n| PostgreSQL | Database engine |\n\n## Configuration\n\n```typescript\n// Environment variables\nDATABASE_URL=postgresql://user:pass@localhost:5432/taskflow?schema=public\nDATABASE_POOL_SIZE=10\nDATABASE_CONNECTION_TIMEOUT=5000\n```\n\n## Location\n\n```\npackages/api/src/foundation/database/\n├── client.ts       # Prisma client wrapper\n├── tenant.ts       # Schema provisioning\n├── health.ts       # Health check utilities\n└── index.ts        # Public exports\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:14:35.513Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.8-cache.md",
        "content": "# c3-2.8: Cache Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nRedis client wrapper providing caching operations with consistent key patterns, TTL management, and type-safe access methods.\n\n## Responsibilities\n\n- Manage Redis connection lifecycle\n- Provide typed caching operations (get, set, delete)\n- Implement cache patterns (cache-aside, invalidation)\n- Define consistent key naming conventions\n- Handle serialization/deserialization\n\n## Interface\n\n```typescript\n// foundation/cache/client.ts\n\nimport Redis from 'ioredis';\n\nclass CacheClient {\n  private redis: Redis;\n\n  constructor() {\n    this.redis = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      password: process.env.REDIS_PASSWORD,\n      maxRetriesPerRequest: 3\n    });\n  }\n\n  // Get raw Redis client (for pub/sub, etc.)\n  get raw(): Redis {\n    return this.redis;\n  }\n\n  // Type-safe get with JSON parsing\n  async get<T>(key: string): Promise<T | null> {\n    const value = await this.redis.get(key);\n    return value ? JSON.parse(value) : null;\n  }\n\n  // Set with TTL\n  async set<T>(key: string, value: T, ttlSeconds: number): Promise<void> {\n    await this.redis.setex(key, ttlSeconds, JSON.stringify(value));\n  }\n\n  // Delete single key\n  async del(key: string): Promise<void> {\n    await this.redis.del(key);\n  }\n\n  // Delete by pattern\n  async delPattern(pattern: string): Promise<void> {\n    const keys = await this.redis.keys(pattern);\n    if (keys.length > 0) {\n      await this.redis.del(...keys);\n    }\n  }\n\n  // Cache-aside pattern\n  async getOrSet<T>(\n    key: string,\n    ttlSeconds: number,\n    fetcher: () => Promise<T>\n  ): Promise<T> {\n    const cached = await this.get<T>(key);\n    if (cached !== null) {\n      return cached;\n    }\n\n    const fresh = await fetcher();\n    await this.set(key, fresh, ttlSeconds);\n    return fresh;\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.redis.ping();\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.redis.quit();\n  }\n}\n\nexport const cache = new CacheClient();\n```\n\n## Key Patterns\n\n```typescript\n// foundation/cache/keys.ts\n\nexport const CacheKeys = {\n  // User data\n  user: (id: string) => `user:${id}`,\n  userWorkspaces: (id: string) => `user:${id}:workspaces`,\n\n  // Session\n  session: (id: string) => `session:${id}`,\n  refreshToken: (token: string) => `refresh:${token}`,\n\n  // Board data\n  board: (id: string) => `board:${id}`,\n  boardTasks: (id: string) => `board:${id}:tasks`,\n  boardPresence: (id: string) => `board:${id}:presence`,\n\n  // Rate limiting\n  rateLimit: (userId: string, endpoint: string) =>\n    `rate:${userId}:${endpoint}`,\n\n  // Feature flags\n  featureFlag: (key: string) => `flag:${key}`\n} as const;\n\nexport const CacheTTL = {\n  session: 900,      // 15 minutes\n  user: 300,         // 5 minutes\n  board: 120,        // 2 minutes\n  rateLimit: 60,     // 1 minute\n  presence: 30,      // 30 seconds\n  featureFlag: 30    // 30 seconds\n} as const;\n```\n\n## Usage Examples\n\n```typescript\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\n\n// Cache user profile\nconst user = await cache.getOrSet(\n  CacheKeys.user(userId),\n  CacheTTL.user,\n  () => db.client.user.findUnique({ where: { id: userId } })\n);\n\n// Invalidate on update\nawait db.client.user.update({ where: { id: userId }, data });\nawait cache.del(CacheKeys.user(userId));\n\n// Invalidate all board caches\nawait cache.delPattern(`board:${boardId}:*`);\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| ioredis | Redis client |\n| Redis | Cache server |\n\n## Location\n\n```\npackages/api/src/foundation/cache/\n├── client.ts       # Redis client wrapper\n├── keys.ts         # Key patterns and TTL constants\n└── index.ts        # Public exports\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:14:35.527Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.8-cache.md",
        "content": "# c3-2.8: Cache Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nRedis client wrapper providing caching operations with consistent key patterns, TTL management, and type-safe access methods.\n\n## Responsibilities\n\n- Manage Redis connection lifecycle\n- Provide typed caching operations (get, set, delete)\n- Implement cache patterns (cache-aside, invalidation)\n- Define consistent key naming conventions\n- Handle serialization/deserialization\n\n## Interface\n\n```typescript\n// foundation/cache/client.ts\n\nimport Redis from 'ioredis';\n\nclass CacheClient {\n  private redis: Redis;\n\n  constructor() {\n    this.redis = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      password: process.env.REDIS_PASSWORD,\n      maxRetriesPerRequest: 3\n    });\n  }\n\n  // Get raw Redis client (for pub/sub, etc.)\n  get raw(): Redis {\n    return this.redis;\n  }\n\n  // Type-safe get with JSON parsing\n  async get<T>(key: string): Promise<T | null> {\n    const value = await this.redis.get(key);\n    return value ? JSON.parse(value) : null;\n  }\n\n  // Set with TTL\n  async set<T>(key: string, value: T, ttlSeconds: number): Promise<void> {\n    await this.redis.setex(key, ttlSeconds, JSON.stringify(value));\n  }\n\n  // Delete single key\n  async del(key: string): Promise<void> {\n    await this.redis.del(key);\n  }\n\n  // Delete by pattern\n  async delPattern(pattern: string): Promise<void> {\n    const keys = await this.redis.keys(pattern);\n    if (keys.length > 0) {\n      await this.redis.del(...keys);\n    }\n  }\n\n  // Cache-aside pattern\n  async getOrSet<T>(\n    key: string,\n    ttlSeconds: number,\n    fetcher: () => Promise<T>\n  ): Promise<T> {\n    const cached = await this.get<T>(key);\n    if (cached !== null) {\n      return cached;\n    }\n\n    const fresh = await fetcher();\n    await this.set(key, fresh, ttlSeconds);\n    return fresh;\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.redis.ping();\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.redis.quit();\n  }\n}\n\nexport const cache = new CacheClient();\n```\n\n## Key Patterns\n\n```typescript\n// foundation/cache/keys.ts\n\nexport const CacheKeys = {\n  // User data\n  user: (id: string) => `user:${id}`,\n  userWorkspaces: (id: string) => `user:${id}:workspaces`,\n\n  // Session\n  session: (id: string) => `session:${id}`,\n  refreshToken: (token: string) => `refresh:${token}`,\n\n  // Board data\n  board: (id: string) => `board:${id}`,\n  boardTasks: (id: string) => `board:${id}:tasks`,\n  boardPresence: (id: string) => `board:${id}:presence`,\n\n  // Rate limiting\n  rateLimit: (userId: string, endpoint: string) =>\n    `rate:${userId}:${endpoint}`,\n\n  // Feature flags\n  featureFlag: (key: string) => `flag:${key}`\n} as const;\n\nexport const CacheTTL = {\n  session: 900,      // 15 minutes\n  user: 300,         // 5 minutes\n  board: 120,        // 2 minutes\n  rateLimit: 60,     // 1 minute\n  presence: 30,      // 30 seconds\n  featureFlag: 30    // 30 seconds\n} as const;\n```\n\n## Usage Examples\n\n```typescript\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\n\n// Cache user profile\nconst user = await cache.getOrSet(\n  CacheKeys.user(userId),\n  CacheTTL.user,\n  () => db.client.user.findUnique({ where: { id: userId } })\n);\n\n// Invalidate on update\nawait db.client.user.update({ where: { id: userId }, data });\nawait cache.del(CacheKeys.user(userId));\n\n// Invalidate all board caches\nawait cache.delPattern(`board:${boardId}:*`);\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| ioredis | Redis client |\n| Redis | Cache server |\n\n## Location\n\n```\npackages/api/src/foundation/cache/\n├── client.ts       # Redis client wrapper\n├── keys.ts         # Key patterns and TTL constants\n└── index.ts        # Public exports\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.8-cache.md",
        "content": "# c3-2.8: Cache Client\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nRedis client wrapper providing caching operations with consistent key patterns, TTL management, and type-safe access methods.\n\n## Responsibilities\n\n- Manage Redis connection lifecycle\n- Provide typed caching operations (get, set, delete)\n- Implement cache patterns (cache-aside, invalidation)\n- Define consistent key naming conventions\n- Handle serialization/deserialization\n\n## Interface\n\n```typescript\n// foundation/cache/client.ts\n\nimport Redis from 'ioredis';\n\nclass CacheClient {\n  private redis: Redis;\n\n  constructor() {\n    this.redis = new Redis({\n      host: process.env.REDIS_HOST || 'localhost',\n      port: parseInt(process.env.REDIS_PORT || '6379'),\n      password: process.env.REDIS_PASSWORD,\n      maxRetriesPerRequest: 3\n    });\n  }\n\n  // Get raw Redis client (for pub/sub, etc.)\n  get raw(): Redis {\n    return this.redis;\n  }\n\n  // Type-safe get with JSON parsing\n  async get<T>(key: string): Promise<T | null> {\n    const value = await this.redis.get(key);\n    return value ? JSON.parse(value) : null;\n  }\n\n  // Set with TTL\n  async set<T>(key: string, value: T, ttlSeconds: number): Promise<void> {\n    await this.redis.setex(key, ttlSeconds, JSON.stringify(value));\n  }\n\n  // Delete single key\n  async del(key: string): Promise<void> {\n    await this.redis.del(key);\n  }\n\n  // Delete by pattern\n  async delPattern(pattern: string): Promise<void> {\n    const keys = await this.redis.keys(pattern);\n    if (keys.length > 0) {\n      await this.redis.del(...keys);\n    }\n  }\n\n  // Cache-aside pattern\n  async getOrSet<T>(\n    key: string,\n    ttlSeconds: number,\n    fetcher: () => Promise<T>\n  ): Promise<T> {\n    const cached = await this.get<T>(key);\n    if (cached !== null) {\n      return cached;\n    }\n\n    const fresh = await fetcher();\n    await this.set(key, fresh, ttlSeconds);\n    return fresh;\n  }\n\n  // Health check\n  async isHealthy(): Promise<boolean> {\n    try {\n      await this.redis.ping();\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  // Graceful shutdown\n  async disconnect(): Promise<void> {\n    await this.redis.quit();\n  }\n}\n\nexport const cache = new CacheClient();\n```\n\n## Key Patterns\n\n```typescript\n// foundation/cache/keys.ts\n\nexport const CacheKeys = {\n  // User data\n  user: (id: string) => `user:${id}`,\n  userWorkspaces: (id: string) => `user:${id}:workspaces`,\n\n  // Session\n  session: (id: string) => `session:${id}`,\n  refreshToken: (token: string) => `refresh:${token}`,\n\n  // Board data\n  board: (id: string) => `board:${id}`,\n  boardTasks: (id: string) => `board:${id}:tasks`,\n  boardPresence: (id: string) => `board:${id}:presence`,\n\n  // Rate limiting\n  rateLimit: (userId: string, endpoint: string) =>\n    `rate:${userId}:${endpoint}`,\n\n  // Feature flags\n  featureFlag: (key: string) => `flag:${key}`\n} as const;\n\nexport const CacheTTL = {\n  session: 900,      // 15 minutes\n  user: 300,         // 5 minutes\n  board: 120,        // 2 minutes\n  rateLimit: 60,     // 1 minute\n  presence: 30,      // 30 seconds\n  featureFlag: 30    // 30 seconds\n} as const;\n```\n\n## Usage Examples\n\n```typescript\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\n\n// Cache user profile\nconst user = await cache.getOrSet(\n  CacheKeys.user(userId),\n  CacheTTL.user,\n  () => db.client.user.findUnique({ where: { id: userId } })\n);\n\n// Invalidate on update\nawait db.client.user.update({ where: { id: userId }, data });\nawait cache.del(CacheKeys.user(userId));\n\n// Invalidate all board caches\nawait cache.delPattern(`board:${boardId}:*`);\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| ioredis | Redis client |\n| Redis | Cache server |\n\n## Location\n\n```\npackages/api/src/foundation/cache/\n├── client.ts       # Redis client wrapper\n├── keys.ts         # Key patterns and TTL constants\n└── index.ts        # Public exports\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:14:59.240Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.9-websocket.md",
        "content": "# c3-2.9: WebSocket Server\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nSocket.io server configuration with Redis adapter for horizontal scaling, room management for board subscriptions, and authentication middleware.\n\n## Responsibilities\n\n- Initialize Socket.io server with Express\n- Configure Redis adapter for multi-instance pub/sub\n- Authenticate WebSocket connections via JWT\n- Manage board subscription rooms\n- Handle presence tracking\n- Route events to appropriate handlers\n\n## Interface\n\n```typescript\n// foundation/websocket/server.ts\n\nimport { Server as HttpServer } from 'http';\nimport { Server, Socket } from 'socket.io';\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { verifyToken } from '@/modules/auth';\nimport { cache } from '@/foundation/cache';\n\ninterface AuthenticatedSocket extends Socket {\n  userId: string;\n  workspaceId?: string;\n}\n\nclass WebSocketServer {\n  private io: Server;\n\n  async initialize(httpServer: HttpServer): Promise<void> {\n    this.io = new Server(httpServer, {\n      cors: {\n        origin: process.env.CORS_ORIGIN,\n        credentials: true\n      },\n      transports: ['websocket', 'polling']\n    });\n\n    // Configure Redis adapter for horizontal scaling\n    const pubClient = cache.raw.duplicate();\n    const subClient = cache.raw.duplicate();\n    this.io.adapter(createAdapter(pubClient, subClient));\n\n    // Authentication middleware\n    this.io.use(async (socket: AuthenticatedSocket, next) => {\n      try {\n        const token = socket.handshake.auth.token;\n        const payload = await verifyToken(token);\n        socket.userId = payload.userId;\n        next();\n      } catch (error) {\n        next(new Error('Authentication failed'));\n      }\n    });\n\n    // Connection handler\n    this.io.on('connection', (socket: AuthenticatedSocket) => {\n      this.handleConnection(socket);\n    });\n  }\n\n  private handleConnection(socket: AuthenticatedSocket): void {\n    logger.info(`User ${socket.userId} connected`);\n\n    // Board subscription\n    socket.on('board:join', async ({ boardId }) => {\n      await this.joinBoard(socket, boardId);\n    });\n\n    socket.on('board:leave', async ({ boardId }) => {\n      await this.leaveBoard(socket, boardId);\n    });\n\n    // Disconnect handler\n    socket.on('disconnect', async () => {\n      await this.handleDisconnect(socket);\n    });\n  }\n\n  private async joinBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    // TODO: Verify user has access to board\n    socket.join(`board:${boardId}`);\n\n    // Track presence\n    await cache.raw.sadd(`board:${boardId}:presence`, socket.userId);\n    await cache.raw.expire(`board:${boardId}:presence`, 30);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:joined', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  private async leaveBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    socket.leave(`board:${boardId}`);\n\n    // Remove from presence\n    await cache.raw.srem(`board:${boardId}:presence`, socket.userId);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:left', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  // Emit to all clients in a board room\n  emitToBoard(boardId: string, event: string, data: unknown): void {\n    this.io.to(`board:${boardId}`).emit(event, data);\n  }\n\n  // Emit to specific user across all their connections\n  emitToUser(userId: string, event: string, data: unknown): void {\n    this.io.to(`user:${userId}`).emit(event, data);\n  }\n\n  get server(): Server {\n    return this.io;\n  }\n}\n\nexport const ws = new WebSocketServer();\n```\n\n## Event Handlers\n\n```typescript\n// foundation/websocket/handlers/board.handler.ts\n\nimport { AuthenticatedSocket } from '../types';\nimport { eventBus } from '@/foundation/events';\n\nexport function registerBoardHandlers(socket: AuthenticatedSocket): void {\n  // Real-time task updates (optimistic sync)\n  socket.on('task:update', async (data) => {\n    const { boardId, taskId, changes } = data;\n\n    // Broadcast to other clients immediately\n    socket.to(`board:${boardId}`).emit('task:updated', {\n      taskId,\n      changes,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    // Persist via event bus (handled by TaskBoard module)\n    eventBus.emit('task:update:requested', {\n      taskId,\n      changes,\n      userId: socket.userId\n    });\n  });\n\n  socket.on('task:move', async (data) => {\n    const { boardId, taskId, targetColumnId, position } = data;\n\n    socket.to(`board:${boardId}`).emit('task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    eventBus.emit('task:move:requested', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId\n    });\n  });\n}\n```\n\n## Client Events\n\n### Client → Server\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `board:join` | `{ boardId }` | Subscribe to board updates |\n| `board:leave` | `{ boardId }` | Unsubscribe from board |\n| `task:update` | `{ boardId, taskId, changes }` | Request task update |\n| `task:move` | `{ boardId, taskId, targetColumnId, position }` | Request task move |\n| `heartbeat` | `{ boardId }` | Presence keepalive |\n\n### Server → Client\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `task:created` | `{ task }` | New task added |\n| `task:updated` | `{ taskId, changes, userId }` | Task modified |\n| `task:moved` | `{ taskId, targetColumnId, position }` | Task moved |\n| `task:deleted` | `{ taskId }` | Task removed |\n| `member:joined` | `{ userId }` | User joined board |\n| `member:left` | `{ userId }` | User left board |\n| `presence:update` | `{ userIds }` | Active users list |\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| socket.io | WebSocket server |\n| @socket.io/redis-adapter | Multi-instance pub/sub |\n| ioredis | Redis client |\n\n## Location\n\n```\npackages/api/src/foundation/websocket/\n├── server.ts           # Socket.io server setup\n├── types.ts            # Socket types\n├── handlers/\n│   ├── board.handler.ts\n│   └── notification.handler.ts\n└── index.ts            # Public exports\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:14:59.252Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.9-websocket.md",
        "content": "# c3-2.9: WebSocket Server\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nSocket.io server configuration with Redis adapter for horizontal scaling, room management for board subscriptions, and authentication middleware.\n\n## Responsibilities\n\n- Initialize Socket.io server with Express\n- Configure Redis adapter for multi-instance pub/sub\n- Authenticate WebSocket connections via JWT\n- Manage board subscription rooms\n- Handle presence tracking\n- Route events to appropriate handlers\n\n## Interface\n\n```typescript\n// foundation/websocket/server.ts\n\nimport { Server as HttpServer } from 'http';\nimport { Server, Socket } from 'socket.io';\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { verifyToken } from '@/modules/auth';\nimport { cache } from '@/foundation/cache';\n\ninterface AuthenticatedSocket extends Socket {\n  userId: string;\n  workspaceId?: string;\n}\n\nclass WebSocketServer {\n  private io: Server;\n\n  async initialize(httpServer: HttpServer): Promise<void> {\n    this.io = new Server(httpServer, {\n      cors: {\n        origin: process.env.CORS_ORIGIN,\n        credentials: true\n      },\n      transports: ['websocket', 'polling']\n    });\n\n    // Configure Redis adapter for horizontal scaling\n    const pubClient = cache.raw.duplicate();\n    const subClient = cache.raw.duplicate();\n    this.io.adapter(createAdapter(pubClient, subClient));\n\n    // Authentication middleware\n    this.io.use(async (socket: AuthenticatedSocket, next) => {\n      try {\n        const token = socket.handshake.auth.token;\n        const payload = await verifyToken(token);\n        socket.userId = payload.userId;\n        next();\n      } catch (error) {\n        next(new Error('Authentication failed'));\n      }\n    });\n\n    // Connection handler\n    this.io.on('connection', (socket: AuthenticatedSocket) => {\n      this.handleConnection(socket);\n    });\n  }\n\n  private handleConnection(socket: AuthenticatedSocket): void {\n    logger.info(`User ${socket.userId} connected`);\n\n    // Board subscription\n    socket.on('board:join', async ({ boardId }) => {\n      await this.joinBoard(socket, boardId);\n    });\n\n    socket.on('board:leave', async ({ boardId }) => {\n      await this.leaveBoard(socket, boardId);\n    });\n\n    // Disconnect handler\n    socket.on('disconnect', async () => {\n      await this.handleDisconnect(socket);\n    });\n  }\n\n  private async joinBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    // TODO: Verify user has access to board\n    socket.join(`board:${boardId}`);\n\n    // Track presence\n    await cache.raw.sadd(`board:${boardId}:presence`, socket.userId);\n    await cache.raw.expire(`board:${boardId}:presence`, 30);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:joined', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  private async leaveBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    socket.leave(`board:${boardId}`);\n\n    // Remove from presence\n    await cache.raw.srem(`board:${boardId}:presence`, socket.userId);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:left', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  // Emit to all clients in a board room\n  emitToBoard(boardId: string, event: string, data: unknown): void {\n    this.io.to(`board:${boardId}`).emit(event, data);\n  }\n\n  // Emit to specific user across all their connections\n  emitToUser(userId: string, event: string, data: unknown): void {\n    this.io.to(`user:${userId}`).emit(event, data);\n  }\n\n  get server(): Server {\n    return this.io;\n  }\n}\n\nexport const ws = new WebSocketServer();\n```\n\n## Event Handlers\n\n```typescript\n// foundation/websocket/handlers/board.handler.ts\n\nimport { AuthenticatedSocket } from '../types';\nimport { eventBus } from '@/foundation/events';\n\nexport function registerBoardHandlers(socket: AuthenticatedSocket): void {\n  // Real-time task updates (optimistic sync)\n  socket.on('task:update', async (data) => {\n    const { boardId, taskId, changes } = data;\n\n    // Broadcast to other clients immediately\n    socket.to(`board:${boardId}`).emit('task:updated', {\n      taskId,\n      changes,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    // Persist via event bus (handled by TaskBoard module)\n    eventBus.emit('task:update:requested', {\n      taskId,\n      changes,\n      userId: socket.userId\n    });\n  });\n\n  socket.on('task:move', async (data) => {\n    const { boardId, taskId, targetColumnId, position } = data;\n\n    socket.to(`board:${boardId}`).emit('task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    eventBus.emit('task:move:requested', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId\n    });\n  });\n}\n```\n\n## Client Events\n\n### Client → Server\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `board:join` | `{ boardId }` | Subscribe to board updates |\n| `board:leave` | `{ boardId }` | Unsubscribe from board |\n| `task:update` | `{ boardId, taskId, changes }` | Request task update |\n| `task:move` | `{ boardId, taskId, targetColumnId, position }` | Request task move |\n| `heartbeat` | `{ boardId }` | Presence keepalive |\n\n### Server → Client\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `task:created` | `{ task }` | New task added |\n| `task:updated` | `{ taskId, changes, userId }` | Task modified |\n| `task:moved` | `{ taskId, targetColumnId, position }` | Task moved |\n| `task:deleted` | `{ taskId }` | Task removed |\n| `member:joined` | `{ userId }` | User joined board |\n| `member:left` | `{ userId }` | User left board |\n| `presence:update` | `{ userIds }` | Active users list |\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| socket.io | WebSocket server |\n| @socket.io/redis-adapter | Multi-instance pub/sub |\n| ioredis | Redis client |\n\n## Location\n\n```\npackages/api/src/foundation/websocket/\n├── server.ts           # Socket.io server setup\n├── types.ts            # Socket types\n├── handlers/\n│   ├── board.handler.ts\n│   └── notification.handler.ts\n└── index.ts            # Public exports\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.9-websocket.md",
        "content": "# c3-2.9: WebSocket Server\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nSocket.io server configuration with Redis adapter for horizontal scaling, room management for board subscriptions, and authentication middleware.\n\n## Responsibilities\n\n- Initialize Socket.io server with Express\n- Configure Redis adapter for multi-instance pub/sub\n- Authenticate WebSocket connections via JWT\n- Manage board subscription rooms\n- Handle presence tracking\n- Route events to appropriate handlers\n\n## Interface\n\n```typescript\n// foundation/websocket/server.ts\n\nimport { Server as HttpServer } from 'http';\nimport { Server, Socket } from 'socket.io';\nimport { createAdapter } from '@socket.io/redis-adapter';\nimport { verifyToken } from '@/modules/auth';\nimport { cache } from '@/foundation/cache';\n\ninterface AuthenticatedSocket extends Socket {\n  userId: string;\n  workspaceId?: string;\n}\n\nclass WebSocketServer {\n  private io: Server;\n\n  async initialize(httpServer: HttpServer): Promise<void> {\n    this.io = new Server(httpServer, {\n      cors: {\n        origin: process.env.CORS_ORIGIN,\n        credentials: true\n      },\n      transports: ['websocket', 'polling']\n    });\n\n    // Configure Redis adapter for horizontal scaling\n    const pubClient = cache.raw.duplicate();\n    const subClient = cache.raw.duplicate();\n    this.io.adapter(createAdapter(pubClient, subClient));\n\n    // Authentication middleware\n    this.io.use(async (socket: AuthenticatedSocket, next) => {\n      try {\n        const token = socket.handshake.auth.token;\n        const payload = await verifyToken(token);\n        socket.userId = payload.userId;\n        next();\n      } catch (error) {\n        next(new Error('Authentication failed'));\n      }\n    });\n\n    // Connection handler\n    this.io.on('connection', (socket: AuthenticatedSocket) => {\n      this.handleConnection(socket);\n    });\n  }\n\n  private handleConnection(socket: AuthenticatedSocket): void {\n    logger.info(`User ${socket.userId} connected`);\n\n    // Board subscription\n    socket.on('board:join', async ({ boardId }) => {\n      await this.joinBoard(socket, boardId);\n    });\n\n    socket.on('board:leave', async ({ boardId }) => {\n      await this.leaveBoard(socket, boardId);\n    });\n\n    // Disconnect handler\n    socket.on('disconnect', async () => {\n      await this.handleDisconnect(socket);\n    });\n  }\n\n  private async joinBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    // TODO: Verify user has access to board\n    socket.join(`board:${boardId}`);\n\n    // Track presence\n    await cache.raw.sadd(`board:${boardId}:presence`, socket.userId);\n    await cache.raw.expire(`board:${boardId}:presence`, 30);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:joined', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  private async leaveBoard(socket: AuthenticatedSocket, boardId: string): Promise<void> {\n    socket.leave(`board:${boardId}`);\n\n    // Remove from presence\n    await cache.raw.srem(`board:${boardId}:presence`, socket.userId);\n\n    // Notify others\n    socket.to(`board:${boardId}`).emit('member:left', {\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n  }\n\n  // Emit to all clients in a board room\n  emitToBoard(boardId: string, event: string, data: unknown): void {\n    this.io.to(`board:${boardId}`).emit(event, data);\n  }\n\n  // Emit to specific user across all their connections\n  emitToUser(userId: string, event: string, data: unknown): void {\n    this.io.to(`user:${userId}`).emit(event, data);\n  }\n\n  get server(): Server {\n    return this.io;\n  }\n}\n\nexport const ws = new WebSocketServer();\n```\n\n## Event Handlers\n\n```typescript\n// foundation/websocket/handlers/board.handler.ts\n\nimport { AuthenticatedSocket } from '../types';\nimport { eventBus } from '@/foundation/events';\n\nexport function registerBoardHandlers(socket: AuthenticatedSocket): void {\n  // Real-time task updates (optimistic sync)\n  socket.on('task:update', async (data) => {\n    const { boardId, taskId, changes } = data;\n\n    // Broadcast to other clients immediately\n    socket.to(`board:${boardId}`).emit('task:updated', {\n      taskId,\n      changes,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    // Persist via event bus (handled by TaskBoard module)\n    eventBus.emit('task:update:requested', {\n      taskId,\n      changes,\n      userId: socket.userId\n    });\n  });\n\n  socket.on('task:move', async (data) => {\n    const { boardId, taskId, targetColumnId, position } = data;\n\n    socket.to(`board:${boardId}`).emit('task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId,\n      timestamp: Date.now()\n    });\n\n    eventBus.emit('task:move:requested', {\n      taskId,\n      targetColumnId,\n      position,\n      userId: socket.userId\n    });\n  });\n}\n```\n\n## Client Events\n\n### Client → Server\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `board:join` | `{ boardId }` | Subscribe to board updates |\n| `board:leave` | `{ boardId }` | Unsubscribe from board |\n| `task:update` | `{ boardId, taskId, changes }` | Request task update |\n| `task:move` | `{ boardId, taskId, targetColumnId, position }` | Request task move |\n| `heartbeat` | `{ boardId }` | Presence keepalive |\n\n### Server → Client\n\n| Event | Payload | Description |\n|-------|---------|-------------|\n| `task:created` | `{ task }` | New task added |\n| `task:updated` | `{ taskId, changes, userId }` | Task modified |\n| `task:moved` | `{ taskId, targetColumnId, position }` | Task moved |\n| `task:deleted` | `{ taskId }` | Task removed |\n| `member:joined` | `{ userId }` | User joined board |\n| `member:left` | `{ userId }` | User left board |\n| `presence:update` | `{ userIds }` | Active users list |\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| socket.io | WebSocket server |\n| @socket.io/redis-adapter | Multi-instance pub/sub |\n| ioredis | Redis client |\n\n## Location\n\n```\npackages/api/src/foundation/websocket/\n├── server.ts           # Socket.io server setup\n├── types.ts            # Socket types\n├── handlers/\n│   ├── board.handler.ts\n│   └── notification.handler.ts\n└── index.ts            # Public exports\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:15:28.870Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.10-events.md",
        "content": "# c3-2.10: Events Bus\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nInternal event bus for decoupled communication between modules. Bridges local events to Redis pub/sub for cross-instance distribution.\n\n## Responsibilities\n\n- Provide typed event emission and subscription\n- Decouple module communication\n- Bridge events to Redis for multi-instance scenarios\n- Enable async processing of side effects\n- Support event replay for debugging\n\n## Interface\n\n```typescript\n// foundation/events/bus.ts\n\nimport { EventEmitter } from 'events';\nimport { cache } from '@/foundation/cache';\nimport { DomainEvent, EventHandler, EventType } from './types';\n\nclass EventBus {\n  private emitter: EventEmitter;\n  private handlers: Map<EventType, EventHandler[]>;\n\n  constructor() {\n    this.emitter = new EventEmitter();\n    this.handlers = new Map();\n    this.setupRedisSubscription();\n  }\n\n  // Emit event locally and to Redis\n  async emit<T extends EventType>(\n    type: T,\n    payload: DomainEvent[T],\n    options?: { distributed?: boolean }\n  ): Promise<void> {\n    const event = {\n      type,\n      payload,\n      timestamp: Date.now(),\n      id: crypto.randomUUID()\n    };\n\n    // Local emission\n    this.emitter.emit(type, event);\n\n    // Distributed emission (for multi-instance)\n    if (options?.distributed !== false) {\n      await cache.raw.publish('events', JSON.stringify(event));\n    }\n  }\n\n  // Subscribe to event type\n  on<T extends EventType>(\n    type: T,\n    handler: (event: { type: T; payload: DomainEvent[T]; timestamp: number }) => void | Promise<void>\n  ): void {\n    this.emitter.on(type, handler);\n\n    // Track for debugging\n    const handlers = this.handlers.get(type) || [];\n    handlers.push(handler as EventHandler);\n    this.handlers.set(type, handlers);\n  }\n\n  // Unsubscribe\n  off<T extends EventType>(type: T, handler: EventHandler): void {\n    this.emitter.off(type, handler);\n  }\n\n  // Setup Redis subscription for distributed events\n  private setupRedisSubscription(): void {\n    const subscriber = cache.raw.duplicate();\n\n    subscriber.subscribe('events', (err) => {\n      if (err) {\n        logger.error('Failed to subscribe to events channel', err);\n      }\n    });\n\n    subscriber.on('message', (channel, message) => {\n      if (channel === 'events') {\n        const event = JSON.parse(message);\n        // Emit locally (but don't re-publish to Redis)\n        this.emitter.emit(event.type, event);\n      }\n    });\n  }\n}\n\nexport const eventBus = new EventBus();\n```\n\n## Event Types\n\n```typescript\n// foundation/events/types.ts\n\nexport interface DomainEvent {\n  // Auth events\n  'user:registered': { userId: string; email: string };\n  'user:logged_in': { userId: string };\n  'user:logged_out': { userId: string };\n\n  // Workspace events\n  'workspace:created': { workspaceId: string; ownerId: string };\n  'workspace:deleted': { workspaceId: string };\n  'workspace:member_invited': { workspaceId: string; email: string; invitedBy: string };\n  'workspace:member_joined': { workspaceId: string; userId: string };\n  'workspace:member_removed': { workspaceId: string; userId: string };\n\n  // Board events\n  'board:created': { boardId: string; workspaceId: string; createdBy: string };\n  'board:updated': { boardId: string; changes: Record<string, unknown> };\n  'board:deleted': { boardId: string };\n\n  // Task events\n  'task:created': { taskId: string; boardId: string; createdBy: string };\n  'task:updated': { taskId: string; changes: Record<string, unknown>; updatedBy: string };\n  'task:moved': { taskId: string; fromColumnId: string; toColumnId: string; position: number };\n  'task:deleted': { taskId: string; deletedBy: string };\n  'task:assigned': { taskId: string; assigneeId: string; assignedBy: string };\n  'task:commented': { taskId: string; commentId: string; authorId: string };\n\n  // WebSocket request events (from clients)\n  'task:update:requested': { taskId: string; changes: Record<string, unknown>; userId: string };\n  'task:move:requested': { taskId: string; targetColumnId: string; position: number; userId: string };\n}\n\nexport type EventType = keyof DomainEvent;\nexport type EventHandler = (event: unknown) => void | Promise<void>;\n```\n\n## Usage Examples\n\n```typescript\n// Emitting events\nimport { eventBus } from '@/foundation/events';\n\n// In TaskBoard module after creating a task\nawait taskRepository.create(taskData);\nawait eventBus.emit('task:created', {\n  taskId: task.id,\n  boardId: task.boardId,\n  createdBy: userId\n});\n\n// Subscribing to events\nimport { eventBus } from '@/foundation/events';\n\n// In Notification module\neventBus.on('task:assigned', async ({ payload }) => {\n  const { taskId, assigneeId, assignedBy } = payload;\n\n  // Send notification to assignee\n  await notificationService.send(assigneeId, {\n    type: 'task_assigned',\n    taskId,\n    assignedBy\n  });\n});\n\n// In WebSocket handler\neventBus.on('task:created', async ({ payload }) => {\n  const { taskId, boardId } = payload;\n  const task = await taskRepository.findById(taskId);\n\n  ws.emitToBoard(boardId, 'task:created', { task });\n});\n```\n\n## Event Flow\n\n```\n┌────────────────────────────────────────────────────────────────────┐\n│                        EVENT FLOW                                   │\n├────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐  │\n│  │  TaskBoard  │ emit    │  EventBus   │ publish │    Redis    │  │\n│  │   Module    │────────▶│   (local)   │────────▶│   pub/sub   │  │\n│  └─────────────┘         └──────┬──────┘         └──────┬──────┘  │\n│                                 │                       │          │\n│                    ┌────────────┴────────────┐         │          │\n│                    │                         │         │          │\n│                    ▼                         ▼         │          │\n│            ┌─────────────┐           ┌─────────────┐  │          │\n│            │ Notification│           │  WebSocket  │  │          │\n│            │   Module    │           │   Handler   │  │          │\n│            └─────────────┘           └─────────────┘  │          │\n│                                                        │          │\n│                                                        │          │\n│                                              subscribe │          │\n│                                              ┌─────────┘          │\n│                                              │                    │\n│                                              ▼                    │\n│  ┌─────────────┐         ┌─────────────┐                         │\n│  │   Other     │◀────────│  EventBus   │                         │\n│  │  Instance   │   emit  │ (instance 2)│                         │\n│  └─────────────┘ locally └─────────────┘                         │\n│                                                                    │\n└────────────────────────────────────────────────────────────────────┘\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| events (Node.js) | Local event emitter |\n| ioredis | Redis pub/sub |\n\n## Location\n\n```\npackages/api/src/foundation/events/\n├── bus.ts          # Event bus implementation\n├── types.ts        # Event type definitions\n└── index.ts        # Public exports\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:15:28.881Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.10-events.md",
        "content": "# c3-2.10: Events Bus\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nInternal event bus for decoupled communication between modules. Bridges local events to Redis pub/sub for cross-instance distribution.\n\n## Responsibilities\n\n- Provide typed event emission and subscription\n- Decouple module communication\n- Bridge events to Redis for multi-instance scenarios\n- Enable async processing of side effects\n- Support event replay for debugging\n\n## Interface\n\n```typescript\n// foundation/events/bus.ts\n\nimport { EventEmitter } from 'events';\nimport { cache } from '@/foundation/cache';\nimport { DomainEvent, EventHandler, EventType } from './types';\n\nclass EventBus {\n  private emitter: EventEmitter;\n  private handlers: Map<EventType, EventHandler[]>;\n\n  constructor() {\n    this.emitter = new EventEmitter();\n    this.handlers = new Map();\n    this.setupRedisSubscription();\n  }\n\n  // Emit event locally and to Redis\n  async emit<T extends EventType>(\n    type: T,\n    payload: DomainEvent[T],\n    options?: { distributed?: boolean }\n  ): Promise<void> {\n    const event = {\n      type,\n      payload,\n      timestamp: Date.now(),\n      id: crypto.randomUUID()\n    };\n\n    // Local emission\n    this.emitter.emit(type, event);\n\n    // Distributed emission (for multi-instance)\n    if (options?.distributed !== false) {\n      await cache.raw.publish('events', JSON.stringify(event));\n    }\n  }\n\n  // Subscribe to event type\n  on<T extends EventType>(\n    type: T,\n    handler: (event: { type: T; payload: DomainEvent[T]; timestamp: number }) => void | Promise<void>\n  ): void {\n    this.emitter.on(type, handler);\n\n    // Track for debugging\n    const handlers = this.handlers.get(type) || [];\n    handlers.push(handler as EventHandler);\n    this.handlers.set(type, handlers);\n  }\n\n  // Unsubscribe\n  off<T extends EventType>(type: T, handler: EventHandler): void {\n    this.emitter.off(type, handler);\n  }\n\n  // Setup Redis subscription for distributed events\n  private setupRedisSubscription(): void {\n    const subscriber = cache.raw.duplicate();\n\n    subscriber.subscribe('events', (err) => {\n      if (err) {\n        logger.error('Failed to subscribe to events channel', err);\n      }\n    });\n\n    subscriber.on('message', (channel, message) => {\n      if (channel === 'events') {\n        const event = JSON.parse(message);\n        // Emit locally (but don't re-publish to Redis)\n        this.emitter.emit(event.type, event);\n      }\n    });\n  }\n}\n\nexport const eventBus = new EventBus();\n```\n\n## Event Types\n\n```typescript\n// foundation/events/types.ts\n\nexport interface DomainEvent {\n  // Auth events\n  'user:registered': { userId: string; email: string };\n  'user:logged_in': { userId: string };\n  'user:logged_out': { userId: string };\n\n  // Workspace events\n  'workspace:created': { workspaceId: string; ownerId: string };\n  'workspace:deleted': { workspaceId: string };\n  'workspace:member_invited': { workspaceId: string; email: string; invitedBy: string };\n  'workspace:member_joined': { workspaceId: string; userId: string };\n  'workspace:member_removed': { workspaceId: string; userId: string };\n\n  // Board events\n  'board:created': { boardId: string; workspaceId: string; createdBy: string };\n  'board:updated': { boardId: string; changes: Record<string, unknown> };\n  'board:deleted': { boardId: string };\n\n  // Task events\n  'task:created': { taskId: string; boardId: string; createdBy: string };\n  'task:updated': { taskId: string; changes: Record<string, unknown>; updatedBy: string };\n  'task:moved': { taskId: string; fromColumnId: string; toColumnId: string; position: number };\n  'task:deleted': { taskId: string; deletedBy: string };\n  'task:assigned': { taskId: string; assigneeId: string; assignedBy: string };\n  'task:commented': { taskId: string; commentId: string; authorId: string };\n\n  // WebSocket request events (from clients)\n  'task:update:requested': { taskId: string; changes: Record<string, unknown>; userId: string };\n  'task:move:requested': { taskId: string; targetColumnId: string; position: number; userId: string };\n}\n\nexport type EventType = keyof DomainEvent;\nexport type EventHandler = (event: unknown) => void | Promise<void>;\n```\n\n## Usage Examples\n\n```typescript\n// Emitting events\nimport { eventBus } from '@/foundation/events';\n\n// In TaskBoard module after creating a task\nawait taskRepository.create(taskData);\nawait eventBus.emit('task:created', {\n  taskId: task.id,\n  boardId: task.boardId,\n  createdBy: userId\n});\n\n// Subscribing to events\nimport { eventBus } from '@/foundation/events';\n\n// In Notification module\neventBus.on('task:assigned', async ({ payload }) => {\n  const { taskId, assigneeId, assignedBy } = payload;\n\n  // Send notification to assignee\n  await notificationService.send(assigneeId, {\n    type: 'task_assigned',\n    taskId,\n    assignedBy\n  });\n});\n\n// In WebSocket handler\neventBus.on('task:created', async ({ payload }) => {\n  const { taskId, boardId } = payload;\n  const task = await taskRepository.findById(taskId);\n\n  ws.emitToBoard(boardId, 'task:created', { task });\n});\n```\n\n## Event Flow\n\n```\n┌────────────────────────────────────────────────────────────────────┐\n│                        EVENT FLOW                                   │\n├────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐  │\n│  │  TaskBoard  │ emit    │  EventBus   │ publish │    Redis    │  │\n│  │   Module    │────────▶│   (local)   │────────▶│   pub/sub   │  │\n│  └─────────────┘         └──────┬──────┘         └──────┬──────┘  │\n│                                 │                       │          │\n│                    ┌────────────┴────────────┐         │          │\n│                    │                         │         │          │\n│                    ▼                         ▼         │          │\n│            ┌─────────────┐           ┌─────────────┐  │          │\n│            │ Notification│           │  WebSocket  │  │          │\n│            │   Module    │           │   Handler   │  │          │\n│            └─────────────┘           └─────────────┘  │          │\n│                                                        │          │\n│                                                        │          │\n│                                              subscribe │          │\n│                                              ┌─────────┘          │\n│                                              │                    │\n│                                              ▼                    │\n│  ┌─────────────┐         ┌─────────────┐                         │\n│  │   Other     │◀────────│  EventBus   │                         │\n│  │  Instance   │   emit  │ (instance 2)│                         │\n│  └─────────────┘ locally └─────────────┘                         │\n│                                                                    │\n└────────────────────────────────────────────────────────────────────┘\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| events (Node.js) | Local event emitter |\n| ioredis | Redis pub/sub |\n\n## Location\n\n```\npackages/api/src/foundation/events/\n├── bus.ts          # Event bus implementation\n├── types.ts        # Event type definitions\n└── index.ts        # Public exports\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.10-events.md",
        "content": "# c3-2.10: Events Bus\n\n> **Level**: Component | **Type**: Foundation | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nInternal event bus for decoupled communication between modules. Bridges local events to Redis pub/sub for cross-instance distribution.\n\n## Responsibilities\n\n- Provide typed event emission and subscription\n- Decouple module communication\n- Bridge events to Redis for multi-instance scenarios\n- Enable async processing of side effects\n- Support event replay for debugging\n\n## Interface\n\n```typescript\n// foundation/events/bus.ts\n\nimport { EventEmitter } from 'events';\nimport { cache } from '@/foundation/cache';\nimport { DomainEvent, EventHandler, EventType } from './types';\n\nclass EventBus {\n  private emitter: EventEmitter;\n  private handlers: Map<EventType, EventHandler[]>;\n\n  constructor() {\n    this.emitter = new EventEmitter();\n    this.handlers = new Map();\n    this.setupRedisSubscription();\n  }\n\n  // Emit event locally and to Redis\n  async emit<T extends EventType>(\n    type: T,\n    payload: DomainEvent[T],\n    options?: { distributed?: boolean }\n  ): Promise<void> {\n    const event = {\n      type,\n      payload,\n      timestamp: Date.now(),\n      id: crypto.randomUUID()\n    };\n\n    // Local emission\n    this.emitter.emit(type, event);\n\n    // Distributed emission (for multi-instance)\n    if (options?.distributed !== false) {\n      await cache.raw.publish('events', JSON.stringify(event));\n    }\n  }\n\n  // Subscribe to event type\n  on<T extends EventType>(\n    type: T,\n    handler: (event: { type: T; payload: DomainEvent[T]; timestamp: number }) => void | Promise<void>\n  ): void {\n    this.emitter.on(type, handler);\n\n    // Track for debugging\n    const handlers = this.handlers.get(type) || [];\n    handlers.push(handler as EventHandler);\n    this.handlers.set(type, handlers);\n  }\n\n  // Unsubscribe\n  off<T extends EventType>(type: T, handler: EventHandler): void {\n    this.emitter.off(type, handler);\n  }\n\n  // Setup Redis subscription for distributed events\n  private setupRedisSubscription(): void {\n    const subscriber = cache.raw.duplicate();\n\n    subscriber.subscribe('events', (err) => {\n      if (err) {\n        logger.error('Failed to subscribe to events channel', err);\n      }\n    });\n\n    subscriber.on('message', (channel, message) => {\n      if (channel === 'events') {\n        const event = JSON.parse(message);\n        // Emit locally (but don't re-publish to Redis)\n        this.emitter.emit(event.type, event);\n      }\n    });\n  }\n}\n\nexport const eventBus = new EventBus();\n```\n\n## Event Types\n\n```typescript\n// foundation/events/types.ts\n\nexport interface DomainEvent {\n  // Auth events\n  'user:registered': { userId: string; email: string };\n  'user:logged_in': { userId: string };\n  'user:logged_out': { userId: string };\n\n  // Workspace events\n  'workspace:created': { workspaceId: string; ownerId: string };\n  'workspace:deleted': { workspaceId: string };\n  'workspace:member_invited': { workspaceId: string; email: string; invitedBy: string };\n  'workspace:member_joined': { workspaceId: string; userId: string };\n  'workspace:member_removed': { workspaceId: string; userId: string };\n\n  // Board events\n  'board:created': { boardId: string; workspaceId: string; createdBy: string };\n  'board:updated': { boardId: string; changes: Record<string, unknown> };\n  'board:deleted': { boardId: string };\n\n  // Task events\n  'task:created': { taskId: string; boardId: string; createdBy: string };\n  'task:updated': { taskId: string; changes: Record<string, unknown>; updatedBy: string };\n  'task:moved': { taskId: string; fromColumnId: string; toColumnId: string; position: number };\n  'task:deleted': { taskId: string; deletedBy: string };\n  'task:assigned': { taskId: string; assigneeId: string; assignedBy: string };\n  'task:commented': { taskId: string; commentId: string; authorId: string };\n\n  // WebSocket request events (from clients)\n  'task:update:requested': { taskId: string; changes: Record<string, unknown>; userId: string };\n  'task:move:requested': { taskId: string; targetColumnId: string; position: number; userId: string };\n}\n\nexport type EventType = keyof DomainEvent;\nexport type EventHandler = (event: unknown) => void | Promise<void>;\n```\n\n## Usage Examples\n\n```typescript\n// Emitting events\nimport { eventBus } from '@/foundation/events';\n\n// In TaskBoard module after creating a task\nawait taskRepository.create(taskData);\nawait eventBus.emit('task:created', {\n  taskId: task.id,\n  boardId: task.boardId,\n  createdBy: userId\n});\n\n// Subscribing to events\nimport { eventBus } from '@/foundation/events';\n\n// In Notification module\neventBus.on('task:assigned', async ({ payload }) => {\n  const { taskId, assigneeId, assignedBy } = payload;\n\n  // Send notification to assignee\n  await notificationService.send(assigneeId, {\n    type: 'task_assigned',\n    taskId,\n    assignedBy\n  });\n});\n\n// In WebSocket handler\neventBus.on('task:created', async ({ payload }) => {\n  const { taskId, boardId } = payload;\n  const task = await taskRepository.findById(taskId);\n\n  ws.emitToBoard(boardId, 'task:created', { task });\n});\n```\n\n## Event Flow\n\n```\n┌────────────────────────────────────────────────────────────────────┐\n│                        EVENT FLOW                                   │\n├────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐  │\n│  │  TaskBoard  │ emit    │  EventBus   │ publish │    Redis    │  │\n│  │   Module    │────────▶│   (local)   │────────▶│   pub/sub   │  │\n│  └─────────────┘         └──────┬──────┘         └──────┬──────┘  │\n│                                 │                       │          │\n│                    ┌────────────┴────────────┐         │          │\n│                    │                         │         │          │\n│                    ▼                         ▼         │          │\n│            ┌─────────────┐           ┌─────────────┐  │          │\n│            │ Notification│           │  WebSocket  │  │          │\n│            │   Module    │           │   Handler   │  │          │\n│            └─────────────┘           └─────────────┘  │          │\n│                                                        │          │\n│                                                        │          │\n│                                              subscribe │          │\n│                                              ┌─────────┘          │\n│                                              │                    │\n│                                              ▼                    │\n│  ┌─────────────┐         ┌─────────────┐                         │\n│  │   Other     │◀────────│  EventBus   │                         │\n│  │  Instance   │   emit  │ (instance 2)│                         │\n│  └─────────────┘ locally └─────────────┘                         │\n│                                                                    │\n└────────────────────────────────────────────────────────────────────┘\n```\n\n## Dependencies\n\n| Dependency | Purpose |\n|------------|---------|\n| events (Node.js) | Local event emitter |\n| ioredis | Redis pub/sub |\n\n## Location\n\n```\npackages/api/src/foundation/events/\n├── bus.ts          # Event bus implementation\n├── types.ts        # Event type definitions\n└── index.ts        # Public exports\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:15:57.737Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.1-auth-module.md",
        "content": "# c3-2.1: Auth Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nHandles Google OAuth 2.0 authentication flow, JWT token management (access + refresh tokens), and session lifecycle.\n\n## Responsibilities\n\n- Initiate and complete Google OAuth flow\n- Issue and validate JWT access tokens (15 min expiry)\n- Manage refresh tokens (7 day expiry, stored in Redis)\n- Provide authentication middleware\n- Handle logout and token revocation\n\n## Public Interface\n\n```typescript\n// modules/auth/index.ts\n\nexport { authRoutes } from './auth.routes';\nexport { authenticate, authorize } from './auth.middleware';\nexport { verifyToken, generateTokens } from './auth.service';\nexport type { AuthPayload, TokenPair } from './auth.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/auth/google` | Initiate OAuth redirect | No |\n| GET | `/auth/google/callback` | Handle OAuth callback | No |\n| POST | `/auth/refresh` | Refresh access token | No (uses refresh token) |\n| POST | `/auth/logout` | Revoke refresh token | Yes |\n\n## Implementation\n\n```typescript\n// modules/auth/auth.controller.ts\n\nimport { Request, Response } from 'express';\nimport { OAuth2Client } from 'google-auth-library';\nimport { authService } from './auth.service';\n\nconst oauth2Client = new OAuth2Client(\n  process.env.GOOGLE_CLIENT_ID,\n  process.env.GOOGLE_CLIENT_SECRET,\n  process.env.GOOGLE_REDIRECT_URI\n);\n\nexport const authController = {\n  // Redirect to Google\n  initiateOAuth(req: Request, res: Response): void {\n    const url = oauth2Client.generateAuthUrl({\n      access_type: 'offline',\n      scope: [\n        'https://www.googleapis.com/auth/userinfo.email',\n        'https://www.googleapis.com/auth/userinfo.profile'\n      ],\n      prompt: 'consent'\n    });\n    res.redirect(url);\n  },\n\n  // Handle callback\n  async handleCallback(req: Request, res: Response): Promise<void> {\n    const { code } = req.query;\n\n    // Exchange code for tokens\n    const { tokens } = await oauth2Client.getToken(code as string);\n    oauth2Client.setCredentials(tokens);\n\n    // Get user info\n    const userInfo = await oauth2Client.request({\n      url: 'https://www.googleapis.com/oauth2/v2/userinfo'\n    });\n\n    // Create or update user, generate our tokens\n    const { user, tokenPair } = await authService.authenticateWithGoogle(\n      userInfo.data as GoogleUserInfo\n    );\n\n    // Redirect to frontend with tokens\n    const redirectUrl = new URL(`${process.env.FRONTEND_URL}/auth/callback`);\n    redirectUrl.searchParams.set('accessToken', tokenPair.accessToken);\n    redirectUrl.searchParams.set('refreshToken', tokenPair.refreshToken);\n\n    res.redirect(redirectUrl.toString());\n  },\n\n  // Refresh token\n  async refresh(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    const tokenPair = await authService.refreshTokens(refreshToken);\n\n    res.json(tokenPair);\n  },\n\n  // Logout\n  async logout(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    await authService.revokeRefreshToken(refreshToken);\n\n    res.status(204).send();\n  }\n};\n```\n\n```typescript\n// modules/auth/auth.service.ts\n\nimport jwt from 'jsonwebtoken';\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\n\nconst ACCESS_TOKEN_EXPIRY = '15m';\nconst REFRESH_TOKEN_EXPIRY = 7 * 24 * 60 * 60; // 7 days in seconds\n\nexport const authService = {\n  async authenticateWithGoogle(googleUser: GoogleUserInfo) {\n    // Find or create user\n    let user = await db.client.user.findUnique({\n      where: { googleId: googleUser.id }\n    });\n\n    if (!user) {\n      user = await db.client.user.create({\n        data: {\n          googleId: googleUser.id,\n          email: googleUser.email,\n          name: googleUser.name,\n          avatarUrl: googleUser.picture\n        }\n      });\n\n      await eventBus.emit('user:registered', {\n        userId: user.id,\n        email: user.email\n      });\n    }\n\n    const tokenPair = await this.generateTokens(user.id);\n\n    await eventBus.emit('user:logged_in', { userId: user.id });\n\n    return { user, tokenPair };\n  },\n\n  async generateTokens(userId: string): Promise<TokenPair> {\n    const accessToken = jwt.sign(\n      { userId },\n      process.env.JWT_SECRET!,\n      { expiresIn: ACCESS_TOKEN_EXPIRY }\n    );\n\n    const refreshToken = crypto.randomUUID();\n\n    // Store refresh token in Redis\n    await cache.set(\n      CacheKeys.refreshToken(refreshToken),\n      { userId, createdAt: Date.now() },\n      REFRESH_TOKEN_EXPIRY\n    );\n\n    return { accessToken, refreshToken };\n  },\n\n  async verifyToken(token: string): Promise<{ userId: string }> {\n    return jwt.verify(token, process.env.JWT_SECRET!) as { userId: string };\n  },\n\n  async refreshTokens(refreshToken: string): Promise<TokenPair> {\n    const stored = await cache.get<{ userId: string }>(\n      CacheKeys.refreshToken(refreshToken)\n    );\n\n    if (!stored) {\n      throw new Error('Invalid refresh token');\n    }\n\n    // Revoke old token\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n\n    // Issue new tokens\n    return this.generateTokens(stored.userId);\n  },\n\n  async revokeRefreshToken(refreshToken: string): Promise<void> {\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n  }\n};\n```\n\n## Middleware\n\n```typescript\n// modules/auth/auth.middleware.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { authService } from './auth.service';\n\nexport async function authenticate(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader?.startsWith('Bearer ')) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Missing token' } });\n    return;\n  }\n\n  const token = authHeader.slice(7);\n\n  try {\n    const payload = await authService.verifyToken(token);\n    req.userId = payload.userId;\n    next();\n  } catch (error) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Invalid token' } });\n  }\n}\n\nexport function authorize(...roles: string[]) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    // Get user's role in current workspace\n    const membership = await db.client.teamMembership.findUnique({\n      where: {\n        userId_workspaceId: {\n          userId: req.userId!,\n          workspaceId: req.workspaceId!\n        }\n      }\n    });\n\n    if (!membership || !roles.includes(membership.role)) {\n      res.status(403).json({ error: { code: 'FORBIDDEN', message: 'Insufficient permissions' } });\n      return;\n    }\n\n    req.userRole = membership.role;\n    next();\n  };\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | google-auth-library |\n| [Cache](c3-2.8-cache.md) | jsonwebtoken |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/auth/\n├── auth.controller.ts\n├── auth.service.ts\n├── auth.middleware.ts\n├── auth.routes.ts\n├── auth.schema.ts      # Zod validation\n├── auth.types.ts\n└── index.ts\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:15:57.751Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.1-auth-module.md",
        "content": "# c3-2.1: Auth Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nHandles Google OAuth 2.0 authentication flow, JWT token management (access + refresh tokens), and session lifecycle.\n\n## Responsibilities\n\n- Initiate and complete Google OAuth flow\n- Issue and validate JWT access tokens (15 min expiry)\n- Manage refresh tokens (7 day expiry, stored in Redis)\n- Provide authentication middleware\n- Handle logout and token revocation\n\n## Public Interface\n\n```typescript\n// modules/auth/index.ts\n\nexport { authRoutes } from './auth.routes';\nexport { authenticate, authorize } from './auth.middleware';\nexport { verifyToken, generateTokens } from './auth.service';\nexport type { AuthPayload, TokenPair } from './auth.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/auth/google` | Initiate OAuth redirect | No |\n| GET | `/auth/google/callback` | Handle OAuth callback | No |\n| POST | `/auth/refresh` | Refresh access token | No (uses refresh token) |\n| POST | `/auth/logout` | Revoke refresh token | Yes |\n\n## Implementation\n\n```typescript\n// modules/auth/auth.controller.ts\n\nimport { Request, Response } from 'express';\nimport { OAuth2Client } from 'google-auth-library';\nimport { authService } from './auth.service';\n\nconst oauth2Client = new OAuth2Client(\n  process.env.GOOGLE_CLIENT_ID,\n  process.env.GOOGLE_CLIENT_SECRET,\n  process.env.GOOGLE_REDIRECT_URI\n);\n\nexport const authController = {\n  // Redirect to Google\n  initiateOAuth(req: Request, res: Response): void {\n    const url = oauth2Client.generateAuthUrl({\n      access_type: 'offline',\n      scope: [\n        'https://www.googleapis.com/auth/userinfo.email',\n        'https://www.googleapis.com/auth/userinfo.profile'\n      ],\n      prompt: 'consent'\n    });\n    res.redirect(url);\n  },\n\n  // Handle callback\n  async handleCallback(req: Request, res: Response): Promise<void> {\n    const { code } = req.query;\n\n    // Exchange code for tokens\n    const { tokens } = await oauth2Client.getToken(code as string);\n    oauth2Client.setCredentials(tokens);\n\n    // Get user info\n    const userInfo = await oauth2Client.request({\n      url: 'https://www.googleapis.com/oauth2/v2/userinfo'\n    });\n\n    // Create or update user, generate our tokens\n    const { user, tokenPair } = await authService.authenticateWithGoogle(\n      userInfo.data as GoogleUserInfo\n    );\n\n    // Redirect to frontend with tokens\n    const redirectUrl = new URL(`${process.env.FRONTEND_URL}/auth/callback`);\n    redirectUrl.searchParams.set('accessToken', tokenPair.accessToken);\n    redirectUrl.searchParams.set('refreshToken', tokenPair.refreshToken);\n\n    res.redirect(redirectUrl.toString());\n  },\n\n  // Refresh token\n  async refresh(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    const tokenPair = await authService.refreshTokens(refreshToken);\n\n    res.json(tokenPair);\n  },\n\n  // Logout\n  async logout(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    await authService.revokeRefreshToken(refreshToken);\n\n    res.status(204).send();\n  }\n};\n```\n\n```typescript\n// modules/auth/auth.service.ts\n\nimport jwt from 'jsonwebtoken';\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\n\nconst ACCESS_TOKEN_EXPIRY = '15m';\nconst REFRESH_TOKEN_EXPIRY = 7 * 24 * 60 * 60; // 7 days in seconds\n\nexport const authService = {\n  async authenticateWithGoogle(googleUser: GoogleUserInfo) {\n    // Find or create user\n    let user = await db.client.user.findUnique({\n      where: { googleId: googleUser.id }\n    });\n\n    if (!user) {\n      user = await db.client.user.create({\n        data: {\n          googleId: googleUser.id,\n          email: googleUser.email,\n          name: googleUser.name,\n          avatarUrl: googleUser.picture\n        }\n      });\n\n      await eventBus.emit('user:registered', {\n        userId: user.id,\n        email: user.email\n      });\n    }\n\n    const tokenPair = await this.generateTokens(user.id);\n\n    await eventBus.emit('user:logged_in', { userId: user.id });\n\n    return { user, tokenPair };\n  },\n\n  async generateTokens(userId: string): Promise<TokenPair> {\n    const accessToken = jwt.sign(\n      { userId },\n      process.env.JWT_SECRET!,\n      { expiresIn: ACCESS_TOKEN_EXPIRY }\n    );\n\n    const refreshToken = crypto.randomUUID();\n\n    // Store refresh token in Redis\n    await cache.set(\n      CacheKeys.refreshToken(refreshToken),\n      { userId, createdAt: Date.now() },\n      REFRESH_TOKEN_EXPIRY\n    );\n\n    return { accessToken, refreshToken };\n  },\n\n  async verifyToken(token: string): Promise<{ userId: string }> {\n    return jwt.verify(token, process.env.JWT_SECRET!) as { userId: string };\n  },\n\n  async refreshTokens(refreshToken: string): Promise<TokenPair> {\n    const stored = await cache.get<{ userId: string }>(\n      CacheKeys.refreshToken(refreshToken)\n    );\n\n    if (!stored) {\n      throw new Error('Invalid refresh token');\n    }\n\n    // Revoke old token\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n\n    // Issue new tokens\n    return this.generateTokens(stored.userId);\n  },\n\n  async revokeRefreshToken(refreshToken: string): Promise<void> {\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n  }\n};\n```\n\n## Middleware\n\n```typescript\n// modules/auth/auth.middleware.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { authService } from './auth.service';\n\nexport async function authenticate(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader?.startsWith('Bearer ')) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Missing token' } });\n    return;\n  }\n\n  const token = authHeader.slice(7);\n\n  try {\n    const payload = await authService.verifyToken(token);\n    req.userId = payload.userId;\n    next();\n  } catch (error) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Invalid token' } });\n  }\n}\n\nexport function authorize(...roles: string[]) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    // Get user's role in current workspace\n    const membership = await db.client.teamMembership.findUnique({\n      where: {\n        userId_workspaceId: {\n          userId: req.userId!,\n          workspaceId: req.workspaceId!\n        }\n      }\n    });\n\n    if (!membership || !roles.includes(membership.role)) {\n      res.status(403).json({ error: { code: 'FORBIDDEN', message: 'Insufficient permissions' } });\n      return;\n    }\n\n    req.userRole = membership.role;\n    next();\n  };\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | google-auth-library |\n| [Cache](c3-2.8-cache.md) | jsonwebtoken |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/auth/\n├── auth.controller.ts\n├── auth.service.ts\n├── auth.middleware.ts\n├── auth.routes.ts\n├── auth.schema.ts      # Zod validation\n├── auth.types.ts\n└── index.ts\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.1-auth-module.md",
        "content": "# c3-2.1: Auth Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nHandles Google OAuth 2.0 authentication flow, JWT token management (access + refresh tokens), and session lifecycle.\n\n## Responsibilities\n\n- Initiate and complete Google OAuth flow\n- Issue and validate JWT access tokens (15 min expiry)\n- Manage refresh tokens (7 day expiry, stored in Redis)\n- Provide authentication middleware\n- Handle logout and token revocation\n\n## Public Interface\n\n```typescript\n// modules/auth/index.ts\n\nexport { authRoutes } from './auth.routes';\nexport { authenticate, authorize } from './auth.middleware';\nexport { verifyToken, generateTokens } from './auth.service';\nexport type { AuthPayload, TokenPair } from './auth.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/auth/google` | Initiate OAuth redirect | No |\n| GET | `/auth/google/callback` | Handle OAuth callback | No |\n| POST | `/auth/refresh` | Refresh access token | No (uses refresh token) |\n| POST | `/auth/logout` | Revoke refresh token | Yes |\n\n## Implementation\n\n```typescript\n// modules/auth/auth.controller.ts\n\nimport { Request, Response } from 'express';\nimport { OAuth2Client } from 'google-auth-library';\nimport { authService } from './auth.service';\n\nconst oauth2Client = new OAuth2Client(\n  process.env.GOOGLE_CLIENT_ID,\n  process.env.GOOGLE_CLIENT_SECRET,\n  process.env.GOOGLE_REDIRECT_URI\n);\n\nexport const authController = {\n  // Redirect to Google\n  initiateOAuth(req: Request, res: Response): void {\n    const url = oauth2Client.generateAuthUrl({\n      access_type: 'offline',\n      scope: [\n        'https://www.googleapis.com/auth/userinfo.email',\n        'https://www.googleapis.com/auth/userinfo.profile'\n      ],\n      prompt: 'consent'\n    });\n    res.redirect(url);\n  },\n\n  // Handle callback\n  async handleCallback(req: Request, res: Response): Promise<void> {\n    const { code } = req.query;\n\n    // Exchange code for tokens\n    const { tokens } = await oauth2Client.getToken(code as string);\n    oauth2Client.setCredentials(tokens);\n\n    // Get user info\n    const userInfo = await oauth2Client.request({\n      url: 'https://www.googleapis.com/oauth2/v2/userinfo'\n    });\n\n    // Create or update user, generate our tokens\n    const { user, tokenPair } = await authService.authenticateWithGoogle(\n      userInfo.data as GoogleUserInfo\n    );\n\n    // Redirect to frontend with tokens\n    const redirectUrl = new URL(`${process.env.FRONTEND_URL}/auth/callback`);\n    redirectUrl.searchParams.set('accessToken', tokenPair.accessToken);\n    redirectUrl.searchParams.set('refreshToken', tokenPair.refreshToken);\n\n    res.redirect(redirectUrl.toString());\n  },\n\n  // Refresh token\n  async refresh(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    const tokenPair = await authService.refreshTokens(refreshToken);\n\n    res.json(tokenPair);\n  },\n\n  // Logout\n  async logout(req: Request, res: Response): Promise<void> {\n    const { refreshToken } = req.body;\n\n    await authService.revokeRefreshToken(refreshToken);\n\n    res.status(204).send();\n  }\n};\n```\n\n```typescript\n// modules/auth/auth.service.ts\n\nimport jwt from 'jsonwebtoken';\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\n\nconst ACCESS_TOKEN_EXPIRY = '15m';\nconst REFRESH_TOKEN_EXPIRY = 7 * 24 * 60 * 60; // 7 days in seconds\n\nexport const authService = {\n  async authenticateWithGoogle(googleUser: GoogleUserInfo) {\n    // Find or create user\n    let user = await db.client.user.findUnique({\n      where: { googleId: googleUser.id }\n    });\n\n    if (!user) {\n      user = await db.client.user.create({\n        data: {\n          googleId: googleUser.id,\n          email: googleUser.email,\n          name: googleUser.name,\n          avatarUrl: googleUser.picture\n        }\n      });\n\n      await eventBus.emit('user:registered', {\n        userId: user.id,\n        email: user.email\n      });\n    }\n\n    const tokenPair = await this.generateTokens(user.id);\n\n    await eventBus.emit('user:logged_in', { userId: user.id });\n\n    return { user, tokenPair };\n  },\n\n  async generateTokens(userId: string): Promise<TokenPair> {\n    const accessToken = jwt.sign(\n      { userId },\n      process.env.JWT_SECRET!,\n      { expiresIn: ACCESS_TOKEN_EXPIRY }\n    );\n\n    const refreshToken = crypto.randomUUID();\n\n    // Store refresh token in Redis\n    await cache.set(\n      CacheKeys.refreshToken(refreshToken),\n      { userId, createdAt: Date.now() },\n      REFRESH_TOKEN_EXPIRY\n    );\n\n    return { accessToken, refreshToken };\n  },\n\n  async verifyToken(token: string): Promise<{ userId: string }> {\n    return jwt.verify(token, process.env.JWT_SECRET!) as { userId: string };\n  },\n\n  async refreshTokens(refreshToken: string): Promise<TokenPair> {\n    const stored = await cache.get<{ userId: string }>(\n      CacheKeys.refreshToken(refreshToken)\n    );\n\n    if (!stored) {\n      throw new Error('Invalid refresh token');\n    }\n\n    // Revoke old token\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n\n    // Issue new tokens\n    return this.generateTokens(stored.userId);\n  },\n\n  async revokeRefreshToken(refreshToken: string): Promise<void> {\n    await cache.del(CacheKeys.refreshToken(refreshToken));\n  }\n};\n```\n\n## Middleware\n\n```typescript\n// modules/auth/auth.middleware.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { authService } from './auth.service';\n\nexport async function authenticate(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  const authHeader = req.headers.authorization;\n\n  if (!authHeader?.startsWith('Bearer ')) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Missing token' } });\n    return;\n  }\n\n  const token = authHeader.slice(7);\n\n  try {\n    const payload = await authService.verifyToken(token);\n    req.userId = payload.userId;\n    next();\n  } catch (error) {\n    res.status(401).json({ error: { code: 'UNAUTHORIZED', message: 'Invalid token' } });\n  }\n}\n\nexport function authorize(...roles: string[]) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    // Get user's role in current workspace\n    const membership = await db.client.teamMembership.findUnique({\n      where: {\n        userId_workspaceId: {\n          userId: req.userId!,\n          workspaceId: req.workspaceId!\n        }\n      }\n    });\n\n    if (!membership || !roles.includes(membership.role)) {\n      res.status(403).json({ error: { code: 'FORBIDDEN', message: 'Insufficient permissions' } });\n      return;\n    }\n\n    req.userRole = membership.role;\n    next();\n  };\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | google-auth-library |\n| [Cache](c3-2.8-cache.md) | jsonwebtoken |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/auth/\n├── auth.controller.ts\n├── auth.service.ts\n├── auth.middleware.ts\n├── auth.routes.ts\n├── auth.schema.ts      # Zod validation\n├── auth.types.ts\n└── index.ts\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:16:41.824Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.5-taskboard-module.md",
        "content": "# c3-2.5: TaskBoard Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nCore feature module managing task boards, columns, and tasks. Handles CRUD operations, real-time synchronization, and task movement with position tracking.\n\n## Responsibilities\n\n- Board CRUD (create, read, update, archive)\n- Column management with ordering\n- Task lifecycle (create, update, delete, move)\n- Position management for drag-and-drop\n- Real-time event emission for board changes\n- Comment management on tasks\n\n## Public Interface\n\n```typescript\n// modules/taskboard/index.ts\n\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type {\n  Board,\n  Column,\n  Task,\n  Comment,\n  CreateBoardDto,\n  UpdateTaskDto,\n  MoveTaskDto\n} from './taskboard.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/api/v1/boards` | List boards in workspace | Yes |\n| POST | `/api/v1/boards` | Create new board | Yes (Admin+) |\n| GET | `/api/v1/boards/:id` | Get board with columns/tasks | Yes |\n| PUT | `/api/v1/boards/:id` | Update board | Yes (Admin+) |\n| DELETE | `/api/v1/boards/:id` | Archive board | Yes (Admin+) |\n| POST | `/api/v1/boards/:id/columns` | Add column | Yes (Admin+) |\n| PUT | `/api/v1/boards/:id/columns/reorder` | Reorder columns | Yes |\n| POST | `/api/v1/boards/:boardId/tasks` | Create task | Yes |\n| PUT | `/api/v1/tasks/:id` | Update task | Yes |\n| DELETE | `/api/v1/tasks/:id` | Delete task | Yes |\n| POST | `/api/v1/tasks/:id/move` | Move task | Yes |\n| POST | `/api/v1/tasks/:id/comments` | Add comment | Yes |\n\n## Implementation\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\nimport { ws } from '@/foundation/websocket';\n\nexport class TaskboardService {\n  constructor(private schemaName: string) {}\n\n  // ============ BOARDS ============\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards\n        WHERE is_archived = false\n        ORDER BY position ASC\n      `;\n    });\n  }\n\n  async getBoard(boardId: string): Promise<BoardWithDetails> {\n    // Try cache first\n    const cached = await cache.get<BoardWithDetails>(CacheKeys.board(boardId));\n    if (cached) return cached;\n\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [board] = await prisma.$queryRaw<Board[]>`\n        SELECT * FROM boards WHERE id = ${boardId}\n      `;\n\n      if (!board) throw new NotFoundError('Board not found');\n\n      const columns = await prisma.$queryRaw<Column[]>`\n        SELECT * FROM columns\n        WHERE board_id = ${boardId}\n        ORDER BY position ASC\n      `;\n\n      const tasks = await prisma.$queryRaw<Task[]>`\n        SELECT t.*, array_agg(tl.label_id) as label_ids\n        FROM tasks t\n        LEFT JOIN task_labels tl ON t.id = tl.task_id\n        WHERE t.column_id IN (SELECT id FROM columns WHERE board_id = ${boardId})\n        GROUP BY t.id\n        ORDER BY t.position ASC\n      `;\n\n      // Group tasks by column\n      const tasksByColumn = tasks.reduce((acc, task) => {\n        acc[task.columnId] = acc[task.columnId] || [];\n        acc[task.columnId].push(task);\n        return acc;\n      }, {} as Record<string, Task[]>);\n\n      return {\n        ...board,\n        columns: columns.map(col => ({\n          ...col,\n          tasks: tasksByColumn[col.id] || []\n        }))\n      };\n    });\n\n    // Cache result\n    await cache.set(CacheKeys.board(boardId), board, CacheTTL.board);\n\n    return board;\n  }\n\n  async createBoard(data: CreateBoardDto, userId: string): Promise<Board> {\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM boards\n      `;\n\n      const [board] = await prisma.$queryRaw<Board[]>`\n        INSERT INTO boards (name, description, position, created_by)\n        VALUES (${data.name}, ${data.description}, ${maxPosition.max + 1}, ${userId})\n        RETURNING *\n      `;\n\n      // Create default columns\n      await prisma.$queryRaw`\n        INSERT INTO columns (board_id, name, position, color)\n        VALUES\n          (${board.id}, 'To Do', 0, '#6B7280'),\n          (${board.id}, 'In Progress', 1, '#3B82F6'),\n          (${board.id}, 'Done', 2, '#10B981')\n      `;\n\n      return board;\n    });\n\n    await eventBus.emit('board:created', {\n      boardId: board.id,\n      workspaceId: this.schemaName,\n      createdBy: userId\n    });\n\n    return board;\n  }\n\n  // ============ TASKS ============\n\n  async createTask(boardId: string, data: CreateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get first column if not specified\n      const columnId = data.columnId || await this.getFirstColumn(boardId);\n\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM tasks WHERE column_id = ${columnId}\n      `;\n\n      const [task] = await prisma.$queryRaw<Task[]>`\n        INSERT INTO tasks (column_id, title, description, position, priority, due_date, assignee_id, created_by)\n        VALUES (${columnId}, ${data.title}, ${data.description}, ${maxPosition.max + 1},\n                ${data.priority || 'medium'}, ${data.dueDate}, ${data.assigneeId}, ${userId})\n        RETURNING *\n      `;\n\n      return task;\n    });\n\n    // Invalidate cache\n    await cache.del(CacheKeys.board(boardId));\n\n    // Emit events\n    await eventBus.emit('task:created', {\n      taskId: task.id,\n      boardId,\n      createdBy: userId\n    });\n\n    // Real-time broadcast\n    ws.emitToBoard(boardId, 'task:created', { task });\n\n    return task;\n  }\n\n  async updateTask(taskId: string, data: UpdateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Build dynamic update\n      const updates: string[] = [];\n      const values: unknown[] = [];\n\n      if (data.title !== undefined) {\n        updates.push('title = $' + (values.length + 1));\n        values.push(data.title);\n      }\n      if (data.description !== undefined) {\n        updates.push('description = $' + (values.length + 1));\n        values.push(data.description);\n      }\n      if (data.priority !== undefined) {\n        updates.push('priority = $' + (values.length + 1));\n        values.push(data.priority);\n      }\n      if (data.dueDate !== undefined) {\n        updates.push('due_date = $' + (values.length + 1));\n        values.push(data.dueDate);\n      }\n      if (data.assigneeId !== undefined) {\n        updates.push('assignee_id = $' + (values.length + 1));\n        values.push(data.assigneeId);\n      }\n\n      updates.push('updated_at = NOW()');\n\n      const [task] = await prisma.$queryRawUnsafe<Task[]>(`\n        UPDATE tasks SET ${updates.join(', ')}\n        WHERE id = $${values.length + 1}\n        RETURNING *\n      `, ...values, taskId);\n\n      return task;\n    });\n\n    // Get board ID for cache invalidation\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:updated', {\n      taskId,\n      changes: data,\n      updatedBy: userId\n    });\n\n    ws.emitToBoard(boardId, 'task:updated', { taskId, changes: data, userId });\n\n    return task;\n  }\n\n  async moveTask(taskId: string, data: MoveTaskDto, userId: string): Promise<Task> {\n    const { targetColumnId, position } = data;\n\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get current task state\n      const [currentTask] = await prisma.$queryRaw<Task[]>`\n        SELECT * FROM tasks WHERE id = ${taskId}\n      `;\n\n      const fromColumnId = currentTask.columnId;\n\n      // Reorder: shift tasks in target column\n      await prisma.$queryRaw`\n        UPDATE tasks\n        SET position = position + 1\n        WHERE column_id = ${targetColumnId}\n          AND position >= ${position}\n      `;\n\n      // Move task\n      const [task] = await prisma.$queryRaw<Task[]>`\n        UPDATE tasks\n        SET column_id = ${targetColumnId}, position = ${position}, updated_at = NOW()\n        WHERE id = ${taskId}\n        RETURNING *\n      `;\n\n      // Compact positions in source column if moving between columns\n      if (fromColumnId !== targetColumnId) {\n        await prisma.$queryRaw`\n          WITH ordered AS (\n            SELECT id, ROW_NUMBER() OVER (ORDER BY position) - 1 as new_pos\n            FROM tasks WHERE column_id = ${fromColumnId}\n          )\n          UPDATE tasks SET position = ordered.new_pos\n          FROM ordered WHERE tasks.id = ordered.id\n        `;\n      }\n\n      return task;\n    });\n\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:moved', {\n      taskId,\n      fromColumnId: task.columnId,\n      toColumnId: targetColumnId,\n      position\n    });\n\n    ws.emitToBoard(boardId, 'task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId\n    });\n\n    return task;\n  }\n\n  // ============ HELPERS ============\n\n  private async getFirstColumn(boardId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [column] = await prisma.$queryRaw<Column[]>`\n        SELECT id FROM columns WHERE board_id = ${boardId} ORDER BY position LIMIT 1\n      `;\n      return column.id;\n    });\n  }\n\n  private async getBoardIdForTask(taskId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [result] = await prisma.$queryRaw<[{ boardId: string }]>`\n        SELECT c.board_id as \"boardId\"\n        FROM tasks t\n        JOIN columns c ON t.column_id = c.id\n        WHERE t.id = ${taskId}\n      `;\n      return result.boardId;\n    });\n  }\n}\n```\n\n## Types\n\n```typescript\n// modules/taskboard/taskboard.types.ts\n\nexport interface Board {\n  id: string;\n  name: string;\n  description: string | null;\n  isArchived: boolean;\n  position: number;\n  createdBy: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface Column {\n  id: string;\n  boardId: string;\n  name: string;\n  color: string | null;\n  position: number;\n  wipLimit: number | null;\n}\n\nexport interface Task {\n  id: string;\n  columnId: string;\n  title: string;\n  description: string | null;\n  position: number;\n  priority: 'low' | 'medium' | 'high' | 'urgent';\n  dueDate: Date | null;\n  assigneeId: string | null;\n  createdBy: string;\n  completedAt: Date | null;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateTaskDto {\n  title: string;\n  description?: string;\n  columnId?: string;\n  priority?: Task['priority'];\n  dueDate?: Date;\n  assigneeId?: string;\n}\n\nexport interface MoveTaskDto {\n  targetColumnId: string;\n  position: number;\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | zod (validation) |\n| [Cache](c3-2.8-cache.md) | |\n| [WebSocket](c3-2.9-websocket.md) | |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/taskboard/\n├── taskboard.controller.ts\n├── taskboard.service.ts\n├── taskboard.repository.ts   # Raw queries\n├── taskboard.routes.ts\n├── taskboard.schema.ts       # Zod validation\n├── taskboard.types.ts\n└── index.ts\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:16:41.845Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.5-taskboard-module.md",
        "content": "# c3-2.5: TaskBoard Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nCore feature module managing task boards, columns, and tasks. Handles CRUD operations, real-time synchronization, and task movement with position tracking.\n\n## Responsibilities\n\n- Board CRUD (create, read, update, archive)\n- Column management with ordering\n- Task lifecycle (create, update, delete, move)\n- Position management for drag-and-drop\n- Real-time event emission for board changes\n- Comment management on tasks\n\n## Public Interface\n\n```typescript\n// modules/taskboard/index.ts\n\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type {\n  Board,\n  Column,\n  Task,\n  Comment,\n  CreateBoardDto,\n  UpdateTaskDto,\n  MoveTaskDto\n} from './taskboard.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/api/v1/boards` | List boards in workspace | Yes |\n| POST | `/api/v1/boards` | Create new board | Yes (Admin+) |\n| GET | `/api/v1/boards/:id` | Get board with columns/tasks | Yes |\n| PUT | `/api/v1/boards/:id` | Update board | Yes (Admin+) |\n| DELETE | `/api/v1/boards/:id` | Archive board | Yes (Admin+) |\n| POST | `/api/v1/boards/:id/columns` | Add column | Yes (Admin+) |\n| PUT | `/api/v1/boards/:id/columns/reorder` | Reorder columns | Yes |\n| POST | `/api/v1/boards/:boardId/tasks` | Create task | Yes |\n| PUT | `/api/v1/tasks/:id` | Update task | Yes |\n| DELETE | `/api/v1/tasks/:id` | Delete task | Yes |\n| POST | `/api/v1/tasks/:id/move` | Move task | Yes |\n| POST | `/api/v1/tasks/:id/comments` | Add comment | Yes |\n\n## Implementation\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\nimport { ws } from '@/foundation/websocket';\n\nexport class TaskboardService {\n  constructor(private schemaName: string) {}\n\n  // ============ BOARDS ============\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards\n        WHERE is_archived = false\n        ORDER BY position ASC\n      `;\n    });\n  }\n\n  async getBoard(boardId: string): Promise<BoardWithDetails> {\n    // Try cache first\n    const cached = await cache.get<BoardWithDetails>(CacheKeys.board(boardId));\n    if (cached) return cached;\n\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [board] = await prisma.$queryRaw<Board[]>`\n        SELECT * FROM boards WHERE id = ${boardId}\n      `;\n\n      if (!board) throw new NotFoundError('Board not found');\n\n      const columns = await prisma.$queryRaw<Column[]>`\n        SELECT * FROM columns\n        WHERE board_id = ${boardId}\n        ORDER BY position ASC\n      `;\n\n      const tasks = await prisma.$queryRaw<Task[]>`\n        SELECT t.*, array_agg(tl.label_id) as label_ids\n        FROM tasks t\n        LEFT JOIN task_labels tl ON t.id = tl.task_id\n        WHERE t.column_id IN (SELECT id FROM columns WHERE board_id = ${boardId})\n        GROUP BY t.id\n        ORDER BY t.position ASC\n      `;\n\n      // Group tasks by column\n      const tasksByColumn = tasks.reduce((acc, task) => {\n        acc[task.columnId] = acc[task.columnId] || [];\n        acc[task.columnId].push(task);\n        return acc;\n      }, {} as Record<string, Task[]>);\n\n      return {\n        ...board,\n        columns: columns.map(col => ({\n          ...col,\n          tasks: tasksByColumn[col.id] || []\n        }))\n      };\n    });\n\n    // Cache result\n    await cache.set(CacheKeys.board(boardId), board, CacheTTL.board);\n\n    return board;\n  }\n\n  async createBoard(data: CreateBoardDto, userId: string): Promise<Board> {\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM boards\n      `;\n\n      const [board] = await prisma.$queryRaw<Board[]>`\n        INSERT INTO boards (name, description, position, created_by)\n        VALUES (${data.name}, ${data.description}, ${maxPosition.max + 1}, ${userId})\n        RETURNING *\n      `;\n\n      // Create default columns\n      await prisma.$queryRaw`\n        INSERT INTO columns (board_id, name, position, color)\n        VALUES\n          (${board.id}, 'To Do', 0, '#6B7280'),\n          (${board.id}, 'In Progress', 1, '#3B82F6'),\n          (${board.id}, 'Done', 2, '#10B981')\n      `;\n\n      return board;\n    });\n\n    await eventBus.emit('board:created', {\n      boardId: board.id,\n      workspaceId: this.schemaName,\n      createdBy: userId\n    });\n\n    return board;\n  }\n\n  // ============ TASKS ============\n\n  async createTask(boardId: string, data: CreateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get first column if not specified\n      const columnId = data.columnId || await this.getFirstColumn(boardId);\n\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM tasks WHERE column_id = ${columnId}\n      `;\n\n      const [task] = await prisma.$queryRaw<Task[]>`\n        INSERT INTO tasks (column_id, title, description, position, priority, due_date, assignee_id, created_by)\n        VALUES (${columnId}, ${data.title}, ${data.description}, ${maxPosition.max + 1},\n                ${data.priority || 'medium'}, ${data.dueDate}, ${data.assigneeId}, ${userId})\n        RETURNING *\n      `;\n\n      return task;\n    });\n\n    // Invalidate cache\n    await cache.del(CacheKeys.board(boardId));\n\n    // Emit events\n    await eventBus.emit('task:created', {\n      taskId: task.id,\n      boardId,\n      createdBy: userId\n    });\n\n    // Real-time broadcast\n    ws.emitToBoard(boardId, 'task:created', { task });\n\n    return task;\n  }\n\n  async updateTask(taskId: string, data: UpdateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Build dynamic update\n      const updates: string[] = [];\n      const values: unknown[] = [];\n\n      if (data.title !== undefined) {\n        updates.push('title = $' + (values.length + 1));\n        values.push(data.title);\n      }\n      if (data.description !== undefined) {\n        updates.push('description = $' + (values.length + 1));\n        values.push(data.description);\n      }\n      if (data.priority !== undefined) {\n        updates.push('priority = $' + (values.length + 1));\n        values.push(data.priority);\n      }\n      if (data.dueDate !== undefined) {\n        updates.push('due_date = $' + (values.length + 1));\n        values.push(data.dueDate);\n      }\n      if (data.assigneeId !== undefined) {\n        updates.push('assignee_id = $' + (values.length + 1));\n        values.push(data.assigneeId);\n      }\n\n      updates.push('updated_at = NOW()');\n\n      const [task] = await prisma.$queryRawUnsafe<Task[]>(`\n        UPDATE tasks SET ${updates.join(', ')}\n        WHERE id = $${values.length + 1}\n        RETURNING *\n      `, ...values, taskId);\n\n      return task;\n    });\n\n    // Get board ID for cache invalidation\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:updated', {\n      taskId,\n      changes: data,\n      updatedBy: userId\n    });\n\n    ws.emitToBoard(boardId, 'task:updated', { taskId, changes: data, userId });\n\n    return task;\n  }\n\n  async moveTask(taskId: string, data: MoveTaskDto, userId: string): Promise<Task> {\n    const { targetColumnId, position } = data;\n\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get current task state\n      const [currentTask] = await prisma.$queryRaw<Task[]>`\n        SELECT * FROM tasks WHERE id = ${taskId}\n      `;\n\n      const fromColumnId = currentTask.columnId;\n\n      // Reorder: shift tasks in target column\n      await prisma.$queryRaw`\n        UPDATE tasks\n        SET position = position + 1\n        WHERE column_id = ${targetColumnId}\n          AND position >= ${position}\n      `;\n\n      // Move task\n      const [task] = await prisma.$queryRaw<Task[]>`\n        UPDATE tasks\n        SET column_id = ${targetColumnId}, position = ${position}, updated_at = NOW()\n        WHERE id = ${taskId}\n        RETURNING *\n      `;\n\n      // Compact positions in source column if moving between columns\n      if (fromColumnId !== targetColumnId) {\n        await prisma.$queryRaw`\n          WITH ordered AS (\n            SELECT id, ROW_NUMBER() OVER (ORDER BY position) - 1 as new_pos\n            FROM tasks WHERE column_id = ${fromColumnId}\n          )\n          UPDATE tasks SET position = ordered.new_pos\n          FROM ordered WHERE tasks.id = ordered.id\n        `;\n      }\n\n      return task;\n    });\n\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:moved', {\n      taskId,\n      fromColumnId: task.columnId,\n      toColumnId: targetColumnId,\n      position\n    });\n\n    ws.emitToBoard(boardId, 'task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId\n    });\n\n    return task;\n  }\n\n  // ============ HELPERS ============\n\n  private async getFirstColumn(boardId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [column] = await prisma.$queryRaw<Column[]>`\n        SELECT id FROM columns WHERE board_id = ${boardId} ORDER BY position LIMIT 1\n      `;\n      return column.id;\n    });\n  }\n\n  private async getBoardIdForTask(taskId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [result] = await prisma.$queryRaw<[{ boardId: string }]>`\n        SELECT c.board_id as \"boardId\"\n        FROM tasks t\n        JOIN columns c ON t.column_id = c.id\n        WHERE t.id = ${taskId}\n      `;\n      return result.boardId;\n    });\n  }\n}\n```\n\n## Types\n\n```typescript\n// modules/taskboard/taskboard.types.ts\n\nexport interface Board {\n  id: string;\n  name: string;\n  description: string | null;\n  isArchived: boolean;\n  position: number;\n  createdBy: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface Column {\n  id: string;\n  boardId: string;\n  name: string;\n  color: string | null;\n  position: number;\n  wipLimit: number | null;\n}\n\nexport interface Task {\n  id: string;\n  columnId: string;\n  title: string;\n  description: string | null;\n  position: number;\n  priority: 'low' | 'medium' | 'high' | 'urgent';\n  dueDate: Date | null;\n  assigneeId: string | null;\n  createdBy: string;\n  completedAt: Date | null;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateTaskDto {\n  title: string;\n  description?: string;\n  columnId?: string;\n  priority?: Task['priority'];\n  dueDate?: Date;\n  assigneeId?: string;\n}\n\nexport interface MoveTaskDto {\n  targetColumnId: string;\n  position: number;\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | zod (validation) |\n| [Cache](c3-2.8-cache.md) | |\n| [WebSocket](c3-2.9-websocket.md) | |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/taskboard/\n├── taskboard.controller.ts\n├── taskboard.service.ts\n├── taskboard.repository.ts   # Raw queries\n├── taskboard.routes.ts\n├── taskboard.schema.ts       # Zod validation\n├── taskboard.types.ts\n└── index.ts\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.5-taskboard-module.md",
        "content": "# c3-2.5: TaskBoard Module\n\n> **Level**: Component | **Type**: Feature Module | **Parent**: [c3-2](../c3-2-api.md)\n\n## Overview\n\nCore feature module managing task boards, columns, and tasks. Handles CRUD operations, real-time synchronization, and task movement with position tracking.\n\n## Responsibilities\n\n- Board CRUD (create, read, update, archive)\n- Column management with ordering\n- Task lifecycle (create, update, delete, move)\n- Position management for drag-and-drop\n- Real-time event emission for board changes\n- Comment management on tasks\n\n## Public Interface\n\n```typescript\n// modules/taskboard/index.ts\n\nexport { taskboardRoutes } from './taskboard.routes';\nexport { TaskboardService } from './taskboard.service';\nexport type {\n  Board,\n  Column,\n  Task,\n  Comment,\n  CreateBoardDto,\n  UpdateTaskDto,\n  MoveTaskDto\n} from './taskboard.types';\n```\n\n## Routes\n\n| Method | Path | Description | Auth |\n|--------|------|-------------|------|\n| GET | `/api/v1/boards` | List boards in workspace | Yes |\n| POST | `/api/v1/boards` | Create new board | Yes (Admin+) |\n| GET | `/api/v1/boards/:id` | Get board with columns/tasks | Yes |\n| PUT | `/api/v1/boards/:id` | Update board | Yes (Admin+) |\n| DELETE | `/api/v1/boards/:id` | Archive board | Yes (Admin+) |\n| POST | `/api/v1/boards/:id/columns` | Add column | Yes (Admin+) |\n| PUT | `/api/v1/boards/:id/columns/reorder` | Reorder columns | Yes |\n| POST | `/api/v1/boards/:boardId/tasks` | Create task | Yes |\n| PUT | `/api/v1/tasks/:id` | Update task | Yes |\n| DELETE | `/api/v1/tasks/:id` | Delete task | Yes |\n| POST | `/api/v1/tasks/:id/move` | Move task | Yes |\n| POST | `/api/v1/tasks/:id/comments` | Add comment | Yes |\n\n## Implementation\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nimport { db } from '@/foundation/database';\nimport { cache, CacheKeys, CacheTTL } from '@/foundation/cache';\nimport { eventBus } from '@/foundation/events';\nimport { ws } from '@/foundation/websocket';\n\nexport class TaskboardService {\n  constructor(private schemaName: string) {}\n\n  // ============ BOARDS ============\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards\n        WHERE is_archived = false\n        ORDER BY position ASC\n      `;\n    });\n  }\n\n  async getBoard(boardId: string): Promise<BoardWithDetails> {\n    // Try cache first\n    const cached = await cache.get<BoardWithDetails>(CacheKeys.board(boardId));\n    if (cached) return cached;\n\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [board] = await prisma.$queryRaw<Board[]>`\n        SELECT * FROM boards WHERE id = ${boardId}\n      `;\n\n      if (!board) throw new NotFoundError('Board not found');\n\n      const columns = await prisma.$queryRaw<Column[]>`\n        SELECT * FROM columns\n        WHERE board_id = ${boardId}\n        ORDER BY position ASC\n      `;\n\n      const tasks = await prisma.$queryRaw<Task[]>`\n        SELECT t.*, array_agg(tl.label_id) as label_ids\n        FROM tasks t\n        LEFT JOIN task_labels tl ON t.id = tl.task_id\n        WHERE t.column_id IN (SELECT id FROM columns WHERE board_id = ${boardId})\n        GROUP BY t.id\n        ORDER BY t.position ASC\n      `;\n\n      // Group tasks by column\n      const tasksByColumn = tasks.reduce((acc, task) => {\n        acc[task.columnId] = acc[task.columnId] || [];\n        acc[task.columnId].push(task);\n        return acc;\n      }, {} as Record<string, Task[]>);\n\n      return {\n        ...board,\n        columns: columns.map(col => ({\n          ...col,\n          tasks: tasksByColumn[col.id] || []\n        }))\n      };\n    });\n\n    // Cache result\n    await cache.set(CacheKeys.board(boardId), board, CacheTTL.board);\n\n    return board;\n  }\n\n  async createBoard(data: CreateBoardDto, userId: string): Promise<Board> {\n    const board = await db.withWorkspace(this.schemaName, async (prisma) => {\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM boards\n      `;\n\n      const [board] = await prisma.$queryRaw<Board[]>`\n        INSERT INTO boards (name, description, position, created_by)\n        VALUES (${data.name}, ${data.description}, ${maxPosition.max + 1}, ${userId})\n        RETURNING *\n      `;\n\n      // Create default columns\n      await prisma.$queryRaw`\n        INSERT INTO columns (board_id, name, position, color)\n        VALUES\n          (${board.id}, 'To Do', 0, '#6B7280'),\n          (${board.id}, 'In Progress', 1, '#3B82F6'),\n          (${board.id}, 'Done', 2, '#10B981')\n      `;\n\n      return board;\n    });\n\n    await eventBus.emit('board:created', {\n      boardId: board.id,\n      workspaceId: this.schemaName,\n      createdBy: userId\n    });\n\n    return board;\n  }\n\n  // ============ TASKS ============\n\n  async createTask(boardId: string, data: CreateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get first column if not specified\n      const columnId = data.columnId || await this.getFirstColumn(boardId);\n\n      const [maxPosition] = await prisma.$queryRaw<[{ max: number }]>`\n        SELECT COALESCE(MAX(position), -1) as max FROM tasks WHERE column_id = ${columnId}\n      `;\n\n      const [task] = await prisma.$queryRaw<Task[]>`\n        INSERT INTO tasks (column_id, title, description, position, priority, due_date, assignee_id, created_by)\n        VALUES (${columnId}, ${data.title}, ${data.description}, ${maxPosition.max + 1},\n                ${data.priority || 'medium'}, ${data.dueDate}, ${data.assigneeId}, ${userId})\n        RETURNING *\n      `;\n\n      return task;\n    });\n\n    // Invalidate cache\n    await cache.del(CacheKeys.board(boardId));\n\n    // Emit events\n    await eventBus.emit('task:created', {\n      taskId: task.id,\n      boardId,\n      createdBy: userId\n    });\n\n    // Real-time broadcast\n    ws.emitToBoard(boardId, 'task:created', { task });\n\n    return task;\n  }\n\n  async updateTask(taskId: string, data: UpdateTaskDto, userId: string): Promise<Task> {\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Build dynamic update\n      const updates: string[] = [];\n      const values: unknown[] = [];\n\n      if (data.title !== undefined) {\n        updates.push('title = $' + (values.length + 1));\n        values.push(data.title);\n      }\n      if (data.description !== undefined) {\n        updates.push('description = $' + (values.length + 1));\n        values.push(data.description);\n      }\n      if (data.priority !== undefined) {\n        updates.push('priority = $' + (values.length + 1));\n        values.push(data.priority);\n      }\n      if (data.dueDate !== undefined) {\n        updates.push('due_date = $' + (values.length + 1));\n        values.push(data.dueDate);\n      }\n      if (data.assigneeId !== undefined) {\n        updates.push('assignee_id = $' + (values.length + 1));\n        values.push(data.assigneeId);\n      }\n\n      updates.push('updated_at = NOW()');\n\n      const [task] = await prisma.$queryRawUnsafe<Task[]>(`\n        UPDATE tasks SET ${updates.join(', ')}\n        WHERE id = $${values.length + 1}\n        RETURNING *\n      `, ...values, taskId);\n\n      return task;\n    });\n\n    // Get board ID for cache invalidation\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:updated', {\n      taskId,\n      changes: data,\n      updatedBy: userId\n    });\n\n    ws.emitToBoard(boardId, 'task:updated', { taskId, changes: data, userId });\n\n    return task;\n  }\n\n  async moveTask(taskId: string, data: MoveTaskDto, userId: string): Promise<Task> {\n    const { targetColumnId, position } = data;\n\n    const task = await db.withWorkspace(this.schemaName, async (prisma) => {\n      // Get current task state\n      const [currentTask] = await prisma.$queryRaw<Task[]>`\n        SELECT * FROM tasks WHERE id = ${taskId}\n      `;\n\n      const fromColumnId = currentTask.columnId;\n\n      // Reorder: shift tasks in target column\n      await prisma.$queryRaw`\n        UPDATE tasks\n        SET position = position + 1\n        WHERE column_id = ${targetColumnId}\n          AND position >= ${position}\n      `;\n\n      // Move task\n      const [task] = await prisma.$queryRaw<Task[]>`\n        UPDATE tasks\n        SET column_id = ${targetColumnId}, position = ${position}, updated_at = NOW()\n        WHERE id = ${taskId}\n        RETURNING *\n      `;\n\n      // Compact positions in source column if moving between columns\n      if (fromColumnId !== targetColumnId) {\n        await prisma.$queryRaw`\n          WITH ordered AS (\n            SELECT id, ROW_NUMBER() OVER (ORDER BY position) - 1 as new_pos\n            FROM tasks WHERE column_id = ${fromColumnId}\n          )\n          UPDATE tasks SET position = ordered.new_pos\n          FROM ordered WHERE tasks.id = ordered.id\n        `;\n      }\n\n      return task;\n    });\n\n    const boardId = await this.getBoardIdForTask(taskId);\n    await cache.del(CacheKeys.board(boardId));\n\n    await eventBus.emit('task:moved', {\n      taskId,\n      fromColumnId: task.columnId,\n      toColumnId: targetColumnId,\n      position\n    });\n\n    ws.emitToBoard(boardId, 'task:moved', {\n      taskId,\n      targetColumnId,\n      position,\n      userId\n    });\n\n    return task;\n  }\n\n  // ============ HELPERS ============\n\n  private async getFirstColumn(boardId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [column] = await prisma.$queryRaw<Column[]>`\n        SELECT id FROM columns WHERE board_id = ${boardId} ORDER BY position LIMIT 1\n      `;\n      return column.id;\n    });\n  }\n\n  private async getBoardIdForTask(taskId: string): Promise<string> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      const [result] = await prisma.$queryRaw<[{ boardId: string }]>`\n        SELECT c.board_id as \"boardId\"\n        FROM tasks t\n        JOIN columns c ON t.column_id = c.id\n        WHERE t.id = ${taskId}\n      `;\n      return result.boardId;\n    });\n  }\n}\n```\n\n## Types\n\n```typescript\n// modules/taskboard/taskboard.types.ts\n\nexport interface Board {\n  id: string;\n  name: string;\n  description: string | null;\n  isArchived: boolean;\n  position: number;\n  createdBy: string;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface Column {\n  id: string;\n  boardId: string;\n  name: string;\n  color: string | null;\n  position: number;\n  wipLimit: number | null;\n}\n\nexport interface Task {\n  id: string;\n  columnId: string;\n  title: string;\n  description: string | null;\n  position: number;\n  priority: 'low' | 'medium' | 'high' | 'urgent';\n  dueDate: Date | null;\n  assigneeId: string | null;\n  createdBy: string;\n  completedAt: Date | null;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateTaskDto {\n  title: string;\n  description?: string;\n  columnId?: string;\n  priority?: Task['priority'];\n  dueDate?: Date;\n  assigneeId?: string;\n}\n\nexport interface MoveTaskDto {\n  targetColumnId: string;\n  position: number;\n}\n```\n\n## Dependencies\n\n| Internal | External |\n|----------|----------|\n| [Database](c3-2.7-database.md) | zod (validation) |\n| [Cache](c3-2.8-cache.md) | |\n| [WebSocket](c3-2.9-websocket.md) | |\n| [Events](c3-2.10-events.md) | |\n\n## Location\n\n```\npackages/api/src/modules/taskboard/\n├── taskboard.controller.ts\n├── taskboard.service.ts\n├── taskboard.repository.ts   # Raw queries\n├── taskboard.routes.ts\n├── taskboard.schema.ts       # Zod validation\n├── taskboard.types.ts\n└── index.ts\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:16:47.458Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "in_progress",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:16:47.464Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "in_progress",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "in_progress",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "pending",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "pending",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "in_progress",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:17:16.766Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/module-structure.md",
        "content": "# Module Structure Pattern\n\n> **Type**: Reference | **Applies to**: All feature modules in [c3-2](../c3-2-api.md)\n\n## Overview\n\nStandard structure for feature modules in the modular monolith. Ensures consistent organization and clear boundaries.\n\n## Directory Structure\n\n```\nmodules/{module-name}/\n├── {module}.controller.ts   # Route handlers (thin layer)\n├── {module}.service.ts      # Business logic\n├── {module}.repository.ts   # Database queries (optional)\n├── {module}.routes.ts       # Express route definitions\n├── {module}.schema.ts       # Zod validation schemas\n├── {module}.types.ts        # TypeScript types\n├── {module}.middleware.ts   # Module-specific middleware (optional)\n└── index.ts                 # Public exports\n```\n\n## File Responsibilities\n\n### `index.ts` - Public Interface\n\nOnly export what other modules need. Keep internal implementation private.\n\n```typescript\n// modules/workspace/index.ts\n\n// Routes for Express app\nexport { workspaceRoutes } from './workspace.routes';\n\n// Service for other modules that need workspace data\nexport { WorkspaceService } from './workspace.service';\n\n// Types for other modules\nexport type { Workspace, CreateWorkspaceDto } from './workspace.types';\n\n// DO NOT export: controller, repository, schema internals\n```\n\n### `*.routes.ts` - Route Definitions\n\nDefine Express routes and attach middleware.\n\n```typescript\n// modules/workspace/workspace.routes.ts\n\nimport { Router } from 'express';\nimport { authenticate, authorize } from '@/modules/auth';\nimport { workspaceController } from './workspace.controller';\n\nexport const workspaceRoutes = Router();\n\nworkspaceRoutes.get(\n  '/',\n  authenticate,\n  workspaceController.list\n);\n\nworkspaceRoutes.post(\n  '/',\n  authenticate,\n  validate(createWorkspaceSchema),\n  workspaceController.create\n);\n\nworkspaceRoutes.put(\n  '/:id',\n  authenticate,\n  authorize('owner', 'admin'),\n  validate(updateWorkspaceSchema),\n  workspaceController.update\n);\n```\n\n### `*.controller.ts` - Route Handlers\n\nThin layer: parse request, call service, format response.\n\n```typescript\n// modules/workspace/workspace.controller.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { workspaceService } from './workspace.service';\n\nexport const workspaceController = {\n  async list(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspaces = await workspaceService.listForUser(req.userId!);\n      res.json({ data: workspaces });\n    } catch (error) {\n      next(error);\n    }\n  },\n\n  async create(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspace = await workspaceService.create(req.body, req.userId!);\n      res.status(201).json({ data: workspace });\n    } catch (error) {\n      next(error);\n    }\n  }\n};\n```\n\n### `*.service.ts` - Business Logic\n\nCore logic, orchestration, event emission.\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { db } from '@/foundation/database';\nimport { eventBus } from '@/foundation/events';\nimport { WorkspaceRepository } from './workspace.repository';\n\nexport const workspaceService = {\n  async create(data: CreateWorkspaceDto, userId: string): Promise<Workspace> {\n    // Business validation\n    const existingSlug = await workspaceRepository.findBySlug(data.slug);\n    if (existingSlug) {\n      throw new ConflictError('Slug already taken');\n    }\n\n    // Create workspace\n    const workspace = await workspaceRepository.create({\n      ...data,\n      ownerId: userId\n    });\n\n    // Provision tenant schema\n    await provisionWorkspaceSchema(workspace.id);\n\n    // Add owner as member\n    await teamService.addMember(workspace.id, userId, 'owner');\n\n    // Emit event\n    await eventBus.emit('workspace:created', {\n      workspaceId: workspace.id,\n      ownerId: userId\n    });\n\n    return workspace;\n  }\n};\n```\n\n### `*.schema.ts` - Validation\n\nZod schemas for request validation.\n\n```typescript\n// modules/workspace/workspace.schema.ts\n\nimport { z } from 'zod';\n\nexport const createWorkspaceSchema = z.object({\n  body: z.object({\n    name: z.string().min(1).max(100),\n    slug: z.string()\n      .min(3).max(50)\n      .regex(/^[a-z0-9-]+$/, 'Slug must be lowercase alphanumeric with hyphens'),\n    description: z.string().max(500).optional()\n  })\n});\n\nexport const updateWorkspaceSchema = z.object({\n  params: z.object({\n    id: z.string().uuid()\n  }),\n  body: z.object({\n    name: z.string().min(1).max(100).optional(),\n    description: z.string().max(500).optional(),\n    settings: z.record(z.unknown()).optional()\n  })\n});\n```\n\n### `*.types.ts` - Type Definitions\n\n```typescript\n// modules/workspace/workspace.types.ts\n\nexport interface Workspace {\n  id: string;\n  name: string;\n  slug: string;\n  ownerId: string;\n  schemaName: string;\n  settings: WorkspaceSettings;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateWorkspaceDto {\n  name: string;\n  slug: string;\n  description?: string;\n}\n\nexport interface WorkspaceSettings {\n  allowGuestAccess: boolean;\n  defaultBoardView: 'kanban' | 'list';\n}\n```\n\n## Cross-Module Communication\n\n### Direct Import (Synchronous)\n\nFor simple data retrieval:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nimport { TeamService } from '@/modules/team';\n\n// Check if user is member before creating task\nconst isMember = await teamService.isMember(workspaceId, userId);\n```\n\n### Event Bus (Asynchronous)\n\nFor side effects and decoupling:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nawait eventBus.emit('task:assigned', { taskId, assigneeId, assignedBy });\n\n// modules/notification/notification.listener.ts\neventBus.on('task:assigned', async ({ payload }) => {\n  await notificationService.notifyUser(payload.assigneeId, {\n    type: 'task_assigned',\n    taskId: payload.taskId\n  });\n});\n```\n\n## Validation Middleware\n\n```typescript\n// middleware/validate.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { AnyZodObject, ZodError } from 'zod';\n\nexport function validate(schema: AnyZodObject) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      await schema.parseAsync({\n        body: req.body,\n        query: req.query,\n        params: req.params\n      });\n      next();\n    } catch (error) {\n      if (error instanceof ZodError) {\n        res.status(400).json({\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: error.errors\n          }\n        });\n        return;\n      }\n      next(error);\n    }\n  };\n}\n```\n\n## Enforcement\n\nModule boundaries are enforced via ESLint rules:\n\n```javascript\n// .eslintrc.js\nmodule.exports = {\n  rules: {\n    'no-restricted-imports': ['error', {\n      patterns: [\n        {\n          group: ['@/modules/*/!(index)'],\n          message: 'Import from module index only'\n        }\n      ]\n    }]\n  }\n};\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:17:16.785Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/module-structure.md",
        "content": "# Module Structure Pattern\n\n> **Type**: Reference | **Applies to**: All feature modules in [c3-2](../c3-2-api.md)\n\n## Overview\n\nStandard structure for feature modules in the modular monolith. Ensures consistent organization and clear boundaries.\n\n## Directory Structure\n\n```\nmodules/{module-name}/\n├── {module}.controller.ts   # Route handlers (thin layer)\n├── {module}.service.ts      # Business logic\n├── {module}.repository.ts   # Database queries (optional)\n├── {module}.routes.ts       # Express route definitions\n├── {module}.schema.ts       # Zod validation schemas\n├── {module}.types.ts        # TypeScript types\n├── {module}.middleware.ts   # Module-specific middleware (optional)\n└── index.ts                 # Public exports\n```\n\n## File Responsibilities\n\n### `index.ts` - Public Interface\n\nOnly export what other modules need. Keep internal implementation private.\n\n```typescript\n// modules/workspace/index.ts\n\n// Routes for Express app\nexport { workspaceRoutes } from './workspace.routes';\n\n// Service for other modules that need workspace data\nexport { WorkspaceService } from './workspace.service';\n\n// Types for other modules\nexport type { Workspace, CreateWorkspaceDto } from './workspace.types';\n\n// DO NOT export: controller, repository, schema internals\n```\n\n### `*.routes.ts` - Route Definitions\n\nDefine Express routes and attach middleware.\n\n```typescript\n// modules/workspace/workspace.routes.ts\n\nimport { Router } from 'express';\nimport { authenticate, authorize } from '@/modules/auth';\nimport { workspaceController } from './workspace.controller';\n\nexport const workspaceRoutes = Router();\n\nworkspaceRoutes.get(\n  '/',\n  authenticate,\n  workspaceController.list\n);\n\nworkspaceRoutes.post(\n  '/',\n  authenticate,\n  validate(createWorkspaceSchema),\n  workspaceController.create\n);\n\nworkspaceRoutes.put(\n  '/:id',\n  authenticate,\n  authorize('owner', 'admin'),\n  validate(updateWorkspaceSchema),\n  workspaceController.update\n);\n```\n\n### `*.controller.ts` - Route Handlers\n\nThin layer: parse request, call service, format response.\n\n```typescript\n// modules/workspace/workspace.controller.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { workspaceService } from './workspace.service';\n\nexport const workspaceController = {\n  async list(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspaces = await workspaceService.listForUser(req.userId!);\n      res.json({ data: workspaces });\n    } catch (error) {\n      next(error);\n    }\n  },\n\n  async create(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspace = await workspaceService.create(req.body, req.userId!);\n      res.status(201).json({ data: workspace });\n    } catch (error) {\n      next(error);\n    }\n  }\n};\n```\n\n### `*.service.ts` - Business Logic\n\nCore logic, orchestration, event emission.\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { db } from '@/foundation/database';\nimport { eventBus } from '@/foundation/events';\nimport { WorkspaceRepository } from './workspace.repository';\n\nexport const workspaceService = {\n  async create(data: CreateWorkspaceDto, userId: string): Promise<Workspace> {\n    // Business validation\n    const existingSlug = await workspaceRepository.findBySlug(data.slug);\n    if (existingSlug) {\n      throw new ConflictError('Slug already taken');\n    }\n\n    // Create workspace\n    const workspace = await workspaceRepository.create({\n      ...data,\n      ownerId: userId\n    });\n\n    // Provision tenant schema\n    await provisionWorkspaceSchema(workspace.id);\n\n    // Add owner as member\n    await teamService.addMember(workspace.id, userId, 'owner');\n\n    // Emit event\n    await eventBus.emit('workspace:created', {\n      workspaceId: workspace.id,\n      ownerId: userId\n    });\n\n    return workspace;\n  }\n};\n```\n\n### `*.schema.ts` - Validation\n\nZod schemas for request validation.\n\n```typescript\n// modules/workspace/workspace.schema.ts\n\nimport { z } from 'zod';\n\nexport const createWorkspaceSchema = z.object({\n  body: z.object({\n    name: z.string().min(1).max(100),\n    slug: z.string()\n      .min(3).max(50)\n      .regex(/^[a-z0-9-]+$/, 'Slug must be lowercase alphanumeric with hyphens'),\n    description: z.string().max(500).optional()\n  })\n});\n\nexport const updateWorkspaceSchema = z.object({\n  params: z.object({\n    id: z.string().uuid()\n  }),\n  body: z.object({\n    name: z.string().min(1).max(100).optional(),\n    description: z.string().max(500).optional(),\n    settings: z.record(z.unknown()).optional()\n  })\n});\n```\n\n### `*.types.ts` - Type Definitions\n\n```typescript\n// modules/workspace/workspace.types.ts\n\nexport interface Workspace {\n  id: string;\n  name: string;\n  slug: string;\n  ownerId: string;\n  schemaName: string;\n  settings: WorkspaceSettings;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateWorkspaceDto {\n  name: string;\n  slug: string;\n  description?: string;\n}\n\nexport interface WorkspaceSettings {\n  allowGuestAccess: boolean;\n  defaultBoardView: 'kanban' | 'list';\n}\n```\n\n## Cross-Module Communication\n\n### Direct Import (Synchronous)\n\nFor simple data retrieval:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nimport { TeamService } from '@/modules/team';\n\n// Check if user is member before creating task\nconst isMember = await teamService.isMember(workspaceId, userId);\n```\n\n### Event Bus (Asynchronous)\n\nFor side effects and decoupling:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nawait eventBus.emit('task:assigned', { taskId, assigneeId, assignedBy });\n\n// modules/notification/notification.listener.ts\neventBus.on('task:assigned', async ({ payload }) => {\n  await notificationService.notifyUser(payload.assigneeId, {\n    type: 'task_assigned',\n    taskId: payload.taskId\n  });\n});\n```\n\n## Validation Middleware\n\n```typescript\n// middleware/validate.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { AnyZodObject, ZodError } from 'zod';\n\nexport function validate(schema: AnyZodObject) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      await schema.parseAsync({\n        body: req.body,\n        query: req.query,\n        params: req.params\n      });\n      next();\n    } catch (error) {\n      if (error instanceof ZodError) {\n        res.status(400).json({\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: error.errors\n          }\n        });\n        return;\n      }\n      next(error);\n    }\n  };\n}\n```\n\n## Enforcement\n\nModule boundaries are enforced via ESLint rules:\n\n```javascript\n// .eslintrc.js\nmodule.exports = {\n  rules: {\n    'no-restricted-imports': ['error', {\n      patterns: [\n        {\n          group: ['@/modules/*/!(index)'],\n          message: 'Import from module index only'\n        }\n      ]\n    }]\n  }\n};\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/refs/module-structure.md",
        "content": "# Module Structure Pattern\n\n> **Type**: Reference | **Applies to**: All feature modules in [c3-2](../c3-2-api.md)\n\n## Overview\n\nStandard structure for feature modules in the modular monolith. Ensures consistent organization and clear boundaries.\n\n## Directory Structure\n\n```\nmodules/{module-name}/\n├── {module}.controller.ts   # Route handlers (thin layer)\n├── {module}.service.ts      # Business logic\n├── {module}.repository.ts   # Database queries (optional)\n├── {module}.routes.ts       # Express route definitions\n├── {module}.schema.ts       # Zod validation schemas\n├── {module}.types.ts        # TypeScript types\n├── {module}.middleware.ts   # Module-specific middleware (optional)\n└── index.ts                 # Public exports\n```\n\n## File Responsibilities\n\n### `index.ts` - Public Interface\n\nOnly export what other modules need. Keep internal implementation private.\n\n```typescript\n// modules/workspace/index.ts\n\n// Routes for Express app\nexport { workspaceRoutes } from './workspace.routes';\n\n// Service for other modules that need workspace data\nexport { WorkspaceService } from './workspace.service';\n\n// Types for other modules\nexport type { Workspace, CreateWorkspaceDto } from './workspace.types';\n\n// DO NOT export: controller, repository, schema internals\n```\n\n### `*.routes.ts` - Route Definitions\n\nDefine Express routes and attach middleware.\n\n```typescript\n// modules/workspace/workspace.routes.ts\n\nimport { Router } from 'express';\nimport { authenticate, authorize } from '@/modules/auth';\nimport { workspaceController } from './workspace.controller';\n\nexport const workspaceRoutes = Router();\n\nworkspaceRoutes.get(\n  '/',\n  authenticate,\n  workspaceController.list\n);\n\nworkspaceRoutes.post(\n  '/',\n  authenticate,\n  validate(createWorkspaceSchema),\n  workspaceController.create\n);\n\nworkspaceRoutes.put(\n  '/:id',\n  authenticate,\n  authorize('owner', 'admin'),\n  validate(updateWorkspaceSchema),\n  workspaceController.update\n);\n```\n\n### `*.controller.ts` - Route Handlers\n\nThin layer: parse request, call service, format response.\n\n```typescript\n// modules/workspace/workspace.controller.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { workspaceService } from './workspace.service';\n\nexport const workspaceController = {\n  async list(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspaces = await workspaceService.listForUser(req.userId!);\n      res.json({ data: workspaces });\n    } catch (error) {\n      next(error);\n    }\n  },\n\n  async create(req: Request, res: Response, next: NextFunction) {\n    try {\n      const workspace = await workspaceService.create(req.body, req.userId!);\n      res.status(201).json({ data: workspace });\n    } catch (error) {\n      next(error);\n    }\n  }\n};\n```\n\n### `*.service.ts` - Business Logic\n\nCore logic, orchestration, event emission.\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { db } from '@/foundation/database';\nimport { eventBus } from '@/foundation/events';\nimport { WorkspaceRepository } from './workspace.repository';\n\nexport const workspaceService = {\n  async create(data: CreateWorkspaceDto, userId: string): Promise<Workspace> {\n    // Business validation\n    const existingSlug = await workspaceRepository.findBySlug(data.slug);\n    if (existingSlug) {\n      throw new ConflictError('Slug already taken');\n    }\n\n    // Create workspace\n    const workspace = await workspaceRepository.create({\n      ...data,\n      ownerId: userId\n    });\n\n    // Provision tenant schema\n    await provisionWorkspaceSchema(workspace.id);\n\n    // Add owner as member\n    await teamService.addMember(workspace.id, userId, 'owner');\n\n    // Emit event\n    await eventBus.emit('workspace:created', {\n      workspaceId: workspace.id,\n      ownerId: userId\n    });\n\n    return workspace;\n  }\n};\n```\n\n### `*.schema.ts` - Validation\n\nZod schemas for request validation.\n\n```typescript\n// modules/workspace/workspace.schema.ts\n\nimport { z } from 'zod';\n\nexport const createWorkspaceSchema = z.object({\n  body: z.object({\n    name: z.string().min(1).max(100),\n    slug: z.string()\n      .min(3).max(50)\n      .regex(/^[a-z0-9-]+$/, 'Slug must be lowercase alphanumeric with hyphens'),\n    description: z.string().max(500).optional()\n  })\n});\n\nexport const updateWorkspaceSchema = z.object({\n  params: z.object({\n    id: z.string().uuid()\n  }),\n  body: z.object({\n    name: z.string().min(1).max(100).optional(),\n    description: z.string().max(500).optional(),\n    settings: z.record(z.unknown()).optional()\n  })\n});\n```\n\n### `*.types.ts` - Type Definitions\n\n```typescript\n// modules/workspace/workspace.types.ts\n\nexport interface Workspace {\n  id: string;\n  name: string;\n  slug: string;\n  ownerId: string;\n  schemaName: string;\n  settings: WorkspaceSettings;\n  createdAt: Date;\n  updatedAt: Date;\n}\n\nexport interface CreateWorkspaceDto {\n  name: string;\n  slug: string;\n  description?: string;\n}\n\nexport interface WorkspaceSettings {\n  allowGuestAccess: boolean;\n  defaultBoardView: 'kanban' | 'list';\n}\n```\n\n## Cross-Module Communication\n\n### Direct Import (Synchronous)\n\nFor simple data retrieval:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nimport { TeamService } from '@/modules/team';\n\n// Check if user is member before creating task\nconst isMember = await teamService.isMember(workspaceId, userId);\n```\n\n### Event Bus (Asynchronous)\n\nFor side effects and decoupling:\n\n```typescript\n// modules/taskboard/taskboard.service.ts\nawait eventBus.emit('task:assigned', { taskId, assigneeId, assignedBy });\n\n// modules/notification/notification.listener.ts\neventBus.on('task:assigned', async ({ payload }) => {\n  await notificationService.notifyUser(payload.assigneeId, {\n    type: 'task_assigned',\n    taskId: payload.taskId\n  });\n});\n```\n\n## Validation Middleware\n\n```typescript\n// middleware/validate.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { AnyZodObject, ZodError } from 'zod';\n\nexport function validate(schema: AnyZodObject) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      await schema.parseAsync({\n        body: req.body,\n        query: req.query,\n        params: req.params\n      });\n      next();\n    } catch (error) {\n      if (error instanceof ZodError) {\n        res.status(400).json({\n          error: {\n            code: 'VALIDATION_ERROR',\n            message: 'Invalid request data',\n            details: error.errors\n          }\n        });\n        return;\n      }\n      next(error);\n    }\n  };\n}\n```\n\n## Enforcement\n\nModule boundaries are enforced via ESLint rules:\n\n```javascript\n// .eslintrc.js\nmodule.exports = {\n  rules: {\n    'no-restricted-imports': ['error', {\n      patterns: [\n        {\n          group: ['@/modules/*/!(index)'],\n          message: 'Import from module index only'\n        }\n      ]\n    }]\n  }\n};\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:17:42.027Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/error-handling.md",
        "content": "# Error Handling Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) API Server\n\n## Overview\n\nConsistent error handling across the API with typed errors, proper HTTP status codes, and structured error responses.\n\n## Error Response Format\n\n```typescript\ninterface ApiErrorResponse {\n  error: {\n    code: string;        // Machine-readable error code (SCREAMING_SNAKE_CASE)\n    message: string;     // Human-readable message\n    details?: unknown;   // Additional context (validation errors, etc.)\n    requestId: string;   // Unique request ID for debugging\n  };\n}\n```\n\n## Error Classes\n\n```typescript\n// shared/errors.ts\n\nexport abstract class AppError extends Error {\n  abstract readonly statusCode: number;\n  abstract readonly code: string;\n  readonly isOperational = true;\n\n  constructor(message: string, public readonly details?: unknown) {\n    super(message);\n    Object.setPrototypeOf(this, new.target.prototype);\n  }\n}\n\n// 400 Bad Request\nexport class ValidationError extends AppError {\n  readonly statusCode = 400;\n  readonly code = 'VALIDATION_ERROR';\n}\n\n// 401 Unauthorized\nexport class UnauthorizedError extends AppError {\n  readonly statusCode = 401;\n  readonly code = 'UNAUTHORIZED';\n\n  constructor(message = 'Authentication required') {\n    super(message);\n  }\n}\n\n// 403 Forbidden\nexport class ForbiddenError extends AppError {\n  readonly statusCode = 403;\n  readonly code = 'FORBIDDEN';\n\n  constructor(message = 'Insufficient permissions') {\n    super(message);\n  }\n}\n\n// 404 Not Found\nexport class NotFoundError extends AppError {\n  readonly statusCode = 404;\n  readonly code = 'NOT_FOUND';\n\n  constructor(resource: string) {\n    super(`${resource} not found`);\n  }\n}\n\n// 409 Conflict\nexport class ConflictError extends AppError {\n  readonly statusCode = 409;\n  readonly code = 'CONFLICT';\n}\n\n// 429 Too Many Requests\nexport class RateLimitError extends AppError {\n  readonly statusCode = 429;\n  readonly code = 'RATE_LIMIT_EXCEEDED';\n\n  constructor(retryAfter: number) {\n    super('Rate limit exceeded');\n    this.details = { retryAfter };\n  }\n}\n\n// 500 Internal Server Error\nexport class InternalError extends AppError {\n  readonly statusCode = 500;\n  readonly code = 'INTERNAL_ERROR';\n  readonly isOperational = false;\n\n  constructor(message = 'An unexpected error occurred') {\n    super(message);\n  }\n}\n```\n\n## Error Handler Middleware\n\n```typescript\n// middleware/errorHandler.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { AppError } from '@/shared/errors';\nimport { logger } from '@/foundation/logger';\n\nexport function errorHandler(\n  err: Error,\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void {\n  const requestId = req.headers['x-request-id'] as string || crypto.randomUUID();\n\n  // Handle known operational errors\n  if (err instanceof AppError) {\n    logger.warn('Operational error', {\n      code: err.code,\n      message: err.message,\n      requestId,\n      path: req.path\n    });\n\n    res.status(err.statusCode).json({\n      error: {\n        code: err.code,\n        message: err.message,\n        details: err.details,\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Zod validation errors\n  if (err instanceof ZodError) {\n    res.status(400).json({\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: 'Invalid request data',\n        details: err.errors.map(e => ({\n          path: e.path.join('.'),\n          message: e.message\n        })),\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Prisma errors\n  if (err.name === 'PrismaClientKnownRequestError') {\n    const prismaError = err as { code: string };\n\n    if (prismaError.code === 'P2002') {\n      res.status(409).json({\n        error: {\n          code: 'CONFLICT',\n          message: 'Resource already exists',\n          requestId\n        }\n      });\n      return;\n    }\n\n    if (prismaError.code === 'P2025') {\n      res.status(404).json({\n        error: {\n          code: 'NOT_FOUND',\n          message: 'Resource not found',\n          requestId\n        }\n      });\n      return;\n    }\n  }\n\n  // Log unexpected errors\n  logger.error('Unexpected error', {\n    error: err.message,\n    stack: err.stack,\n    requestId,\n    path: req.path,\n    method: req.method\n  });\n\n  // Don't leak error details in production\n  const message = process.env.NODE_ENV === 'production'\n    ? 'An unexpected error occurred'\n    : err.message;\n\n  res.status(500).json({\n    error: {\n      code: 'INTERNAL_ERROR',\n      message,\n      requestId\n    }\n  });\n}\n```\n\n## Usage in Modules\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { NotFoundError, ForbiddenError, ConflictError } from '@/shared/errors';\n\nexport const workspaceService = {\n  async getById(workspaceId: string, userId: string): Promise<Workspace> {\n    const workspace = await workspaceRepository.findById(workspaceId);\n\n    if (!workspace) {\n      throw new NotFoundError('Workspace');\n    }\n\n    const membership = await teamRepository.getMembership(workspaceId, userId);\n\n    if (!membership) {\n      throw new ForbiddenError('You are not a member of this workspace');\n    }\n\n    return workspace;\n  },\n\n  async create(data: CreateWorkspaceDto): Promise<Workspace> {\n    const existing = await workspaceRepository.findBySlug(data.slug);\n\n    if (existing) {\n      throw new ConflictError('A workspace with this slug already exists');\n    }\n\n    return workspaceRepository.create(data);\n  }\n};\n```\n\n## Error Codes Reference\n\n| Code | HTTP Status | Usage |\n|------|-------------|-------|\n| `VALIDATION_ERROR` | 400 | Invalid request body, query params, or path params |\n| `UNAUTHORIZED` | 401 | Missing or invalid authentication token |\n| `FORBIDDEN` | 403 | User lacks permission for the action |\n| `NOT_FOUND` | 404 | Resource doesn't exist |\n| `CONFLICT` | 409 | Resource already exists or state conflict |\n| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests |\n| `INTERNAL_ERROR` | 500 | Unexpected server error |\n\n## Client Handling\n\n```typescript\n// packages/web/src/lib/api/client.ts\n\nasync function handleResponse<T>(response: Response): Promise<T> {\n  if (!response.ok) {\n    const error = await response.json() as ApiErrorResponse;\n\n    switch (error.error.code) {\n      case 'UNAUTHORIZED':\n        // Trigger token refresh or redirect to login\n        authStore.handleUnauthorized();\n        break;\n\n      case 'RATE_LIMIT_EXCEEDED':\n        // Show rate limit message\n        const retryAfter = error.error.details?.retryAfter;\n        toast.error(`Too many requests. Try again in ${retryAfter} seconds.`);\n        break;\n\n      case 'VALIDATION_ERROR':\n        // Show validation errors in form\n        throw new ValidationError(error.error.details);\n\n      default:\n        toast.error(error.error.message);\n    }\n\n    throw error;\n  }\n\n  return response.json();\n}\n```\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:17:42.046Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/error-handling.md",
        "content": "# Error Handling Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) API Server\n\n## Overview\n\nConsistent error handling across the API with typed errors, proper HTTP status codes, and structured error responses.\n\n## Error Response Format\n\n```typescript\ninterface ApiErrorResponse {\n  error: {\n    code: string;        // Machine-readable error code (SCREAMING_SNAKE_CASE)\n    message: string;     // Human-readable message\n    details?: unknown;   // Additional context (validation errors, etc.)\n    requestId: string;   // Unique request ID for debugging\n  };\n}\n```\n\n## Error Classes\n\n```typescript\n// shared/errors.ts\n\nexport abstract class AppError extends Error {\n  abstract readonly statusCode: number;\n  abstract readonly code: string;\n  readonly isOperational = true;\n\n  constructor(message: string, public readonly details?: unknown) {\n    super(message);\n    Object.setPrototypeOf(this, new.target.prototype);\n  }\n}\n\n// 400 Bad Request\nexport class ValidationError extends AppError {\n  readonly statusCode = 400;\n  readonly code = 'VALIDATION_ERROR';\n}\n\n// 401 Unauthorized\nexport class UnauthorizedError extends AppError {\n  readonly statusCode = 401;\n  readonly code = 'UNAUTHORIZED';\n\n  constructor(message = 'Authentication required') {\n    super(message);\n  }\n}\n\n// 403 Forbidden\nexport class ForbiddenError extends AppError {\n  readonly statusCode = 403;\n  readonly code = 'FORBIDDEN';\n\n  constructor(message = 'Insufficient permissions') {\n    super(message);\n  }\n}\n\n// 404 Not Found\nexport class NotFoundError extends AppError {\n  readonly statusCode = 404;\n  readonly code = 'NOT_FOUND';\n\n  constructor(resource: string) {\n    super(`${resource} not found`);\n  }\n}\n\n// 409 Conflict\nexport class ConflictError extends AppError {\n  readonly statusCode = 409;\n  readonly code = 'CONFLICT';\n}\n\n// 429 Too Many Requests\nexport class RateLimitError extends AppError {\n  readonly statusCode = 429;\n  readonly code = 'RATE_LIMIT_EXCEEDED';\n\n  constructor(retryAfter: number) {\n    super('Rate limit exceeded');\n    this.details = { retryAfter };\n  }\n}\n\n// 500 Internal Server Error\nexport class InternalError extends AppError {\n  readonly statusCode = 500;\n  readonly code = 'INTERNAL_ERROR';\n  readonly isOperational = false;\n\n  constructor(message = 'An unexpected error occurred') {\n    super(message);\n  }\n}\n```\n\n## Error Handler Middleware\n\n```typescript\n// middleware/errorHandler.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { AppError } from '@/shared/errors';\nimport { logger } from '@/foundation/logger';\n\nexport function errorHandler(\n  err: Error,\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void {\n  const requestId = req.headers['x-request-id'] as string || crypto.randomUUID();\n\n  // Handle known operational errors\n  if (err instanceof AppError) {\n    logger.warn('Operational error', {\n      code: err.code,\n      message: err.message,\n      requestId,\n      path: req.path\n    });\n\n    res.status(err.statusCode).json({\n      error: {\n        code: err.code,\n        message: err.message,\n        details: err.details,\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Zod validation errors\n  if (err instanceof ZodError) {\n    res.status(400).json({\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: 'Invalid request data',\n        details: err.errors.map(e => ({\n          path: e.path.join('.'),\n          message: e.message\n        })),\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Prisma errors\n  if (err.name === 'PrismaClientKnownRequestError') {\n    const prismaError = err as { code: string };\n\n    if (prismaError.code === 'P2002') {\n      res.status(409).json({\n        error: {\n          code: 'CONFLICT',\n          message: 'Resource already exists',\n          requestId\n        }\n      });\n      return;\n    }\n\n    if (prismaError.code === 'P2025') {\n      res.status(404).json({\n        error: {\n          code: 'NOT_FOUND',\n          message: 'Resource not found',\n          requestId\n        }\n      });\n      return;\n    }\n  }\n\n  // Log unexpected errors\n  logger.error('Unexpected error', {\n    error: err.message,\n    stack: err.stack,\n    requestId,\n    path: req.path,\n    method: req.method\n  });\n\n  // Don't leak error details in production\n  const message = process.env.NODE_ENV === 'production'\n    ? 'An unexpected error occurred'\n    : err.message;\n\n  res.status(500).json({\n    error: {\n      code: 'INTERNAL_ERROR',\n      message,\n      requestId\n    }\n  });\n}\n```\n\n## Usage in Modules\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { NotFoundError, ForbiddenError, ConflictError } from '@/shared/errors';\n\nexport const workspaceService = {\n  async getById(workspaceId: string, userId: string): Promise<Workspace> {\n    const workspace = await workspaceRepository.findById(workspaceId);\n\n    if (!workspace) {\n      throw new NotFoundError('Workspace');\n    }\n\n    const membership = await teamRepository.getMembership(workspaceId, userId);\n\n    if (!membership) {\n      throw new ForbiddenError('You are not a member of this workspace');\n    }\n\n    return workspace;\n  },\n\n  async create(data: CreateWorkspaceDto): Promise<Workspace> {\n    const existing = await workspaceRepository.findBySlug(data.slug);\n\n    if (existing) {\n      throw new ConflictError('A workspace with this slug already exists');\n    }\n\n    return workspaceRepository.create(data);\n  }\n};\n```\n\n## Error Codes Reference\n\n| Code | HTTP Status | Usage |\n|------|-------------|-------|\n| `VALIDATION_ERROR` | 400 | Invalid request body, query params, or path params |\n| `UNAUTHORIZED` | 401 | Missing or invalid authentication token |\n| `FORBIDDEN` | 403 | User lacks permission for the action |\n| `NOT_FOUND` | 404 | Resource doesn't exist |\n| `CONFLICT` | 409 | Resource already exists or state conflict |\n| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests |\n| `INTERNAL_ERROR` | 500 | Unexpected server error |\n\n## Client Handling\n\n```typescript\n// packages/web/src/lib/api/client.ts\n\nasync function handleResponse<T>(response: Response): Promise<T> {\n  if (!response.ok) {\n    const error = await response.json() as ApiErrorResponse;\n\n    switch (error.error.code) {\n      case 'UNAUTHORIZED':\n        // Trigger token refresh or redirect to login\n        authStore.handleUnauthorized();\n        break;\n\n      case 'RATE_LIMIT_EXCEEDED':\n        // Show rate limit message\n        const retryAfter = error.error.details?.retryAfter;\n        toast.error(`Too many requests. Try again in ${retryAfter} seconds.`);\n        break;\n\n      case 'VALIDATION_ERROR':\n        // Show validation errors in form\n        throw new ValidationError(error.error.details);\n\n      default:\n        toast.error(error.error.message);\n    }\n\n    throw error;\n  }\n\n  return response.json();\n}\n```\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/refs/error-handling.md",
        "content": "# Error Handling Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) API Server\n\n## Overview\n\nConsistent error handling across the API with typed errors, proper HTTP status codes, and structured error responses.\n\n## Error Response Format\n\n```typescript\ninterface ApiErrorResponse {\n  error: {\n    code: string;        // Machine-readable error code (SCREAMING_SNAKE_CASE)\n    message: string;     // Human-readable message\n    details?: unknown;   // Additional context (validation errors, etc.)\n    requestId: string;   // Unique request ID for debugging\n  };\n}\n```\n\n## Error Classes\n\n```typescript\n// shared/errors.ts\n\nexport abstract class AppError extends Error {\n  abstract readonly statusCode: number;\n  abstract readonly code: string;\n  readonly isOperational = true;\n\n  constructor(message: string, public readonly details?: unknown) {\n    super(message);\n    Object.setPrototypeOf(this, new.target.prototype);\n  }\n}\n\n// 400 Bad Request\nexport class ValidationError extends AppError {\n  readonly statusCode = 400;\n  readonly code = 'VALIDATION_ERROR';\n}\n\n// 401 Unauthorized\nexport class UnauthorizedError extends AppError {\n  readonly statusCode = 401;\n  readonly code = 'UNAUTHORIZED';\n\n  constructor(message = 'Authentication required') {\n    super(message);\n  }\n}\n\n// 403 Forbidden\nexport class ForbiddenError extends AppError {\n  readonly statusCode = 403;\n  readonly code = 'FORBIDDEN';\n\n  constructor(message = 'Insufficient permissions') {\n    super(message);\n  }\n}\n\n// 404 Not Found\nexport class NotFoundError extends AppError {\n  readonly statusCode = 404;\n  readonly code = 'NOT_FOUND';\n\n  constructor(resource: string) {\n    super(`${resource} not found`);\n  }\n}\n\n// 409 Conflict\nexport class ConflictError extends AppError {\n  readonly statusCode = 409;\n  readonly code = 'CONFLICT';\n}\n\n// 429 Too Many Requests\nexport class RateLimitError extends AppError {\n  readonly statusCode = 429;\n  readonly code = 'RATE_LIMIT_EXCEEDED';\n\n  constructor(retryAfter: number) {\n    super('Rate limit exceeded');\n    this.details = { retryAfter };\n  }\n}\n\n// 500 Internal Server Error\nexport class InternalError extends AppError {\n  readonly statusCode = 500;\n  readonly code = 'INTERNAL_ERROR';\n  readonly isOperational = false;\n\n  constructor(message = 'An unexpected error occurred') {\n    super(message);\n  }\n}\n```\n\n## Error Handler Middleware\n\n```typescript\n// middleware/errorHandler.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { ZodError } from 'zod';\nimport { AppError } from '@/shared/errors';\nimport { logger } from '@/foundation/logger';\n\nexport function errorHandler(\n  err: Error,\n  req: Request,\n  res: Response,\n  next: NextFunction\n): void {\n  const requestId = req.headers['x-request-id'] as string || crypto.randomUUID();\n\n  // Handle known operational errors\n  if (err instanceof AppError) {\n    logger.warn('Operational error', {\n      code: err.code,\n      message: err.message,\n      requestId,\n      path: req.path\n    });\n\n    res.status(err.statusCode).json({\n      error: {\n        code: err.code,\n        message: err.message,\n        details: err.details,\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Zod validation errors\n  if (err instanceof ZodError) {\n    res.status(400).json({\n      error: {\n        code: 'VALIDATION_ERROR',\n        message: 'Invalid request data',\n        details: err.errors.map(e => ({\n          path: e.path.join('.'),\n          message: e.message\n        })),\n        requestId\n      }\n    });\n    return;\n  }\n\n  // Handle Prisma errors\n  if (err.name === 'PrismaClientKnownRequestError') {\n    const prismaError = err as { code: string };\n\n    if (prismaError.code === 'P2002') {\n      res.status(409).json({\n        error: {\n          code: 'CONFLICT',\n          message: 'Resource already exists',\n          requestId\n        }\n      });\n      return;\n    }\n\n    if (prismaError.code === 'P2025') {\n      res.status(404).json({\n        error: {\n          code: 'NOT_FOUND',\n          message: 'Resource not found',\n          requestId\n        }\n      });\n      return;\n    }\n  }\n\n  // Log unexpected errors\n  logger.error('Unexpected error', {\n    error: err.message,\n    stack: err.stack,\n    requestId,\n    path: req.path,\n    method: req.method\n  });\n\n  // Don't leak error details in production\n  const message = process.env.NODE_ENV === 'production'\n    ? 'An unexpected error occurred'\n    : err.message;\n\n  res.status(500).json({\n    error: {\n      code: 'INTERNAL_ERROR',\n      message,\n      requestId\n    }\n  });\n}\n```\n\n## Usage in Modules\n\n```typescript\n// modules/workspace/workspace.service.ts\n\nimport { NotFoundError, ForbiddenError, ConflictError } from '@/shared/errors';\n\nexport const workspaceService = {\n  async getById(workspaceId: string, userId: string): Promise<Workspace> {\n    const workspace = await workspaceRepository.findById(workspaceId);\n\n    if (!workspace) {\n      throw new NotFoundError('Workspace');\n    }\n\n    const membership = await teamRepository.getMembership(workspaceId, userId);\n\n    if (!membership) {\n      throw new ForbiddenError('You are not a member of this workspace');\n    }\n\n    return workspace;\n  },\n\n  async create(data: CreateWorkspaceDto): Promise<Workspace> {\n    const existing = await workspaceRepository.findBySlug(data.slug);\n\n    if (existing) {\n      throw new ConflictError('A workspace with this slug already exists');\n    }\n\n    return workspaceRepository.create(data);\n  }\n};\n```\n\n## Error Codes Reference\n\n| Code | HTTP Status | Usage |\n|------|-------------|-------|\n| `VALIDATION_ERROR` | 400 | Invalid request body, query params, or path params |\n| `UNAUTHORIZED` | 401 | Missing or invalid authentication token |\n| `FORBIDDEN` | 403 | User lacks permission for the action |\n| `NOT_FOUND` | 404 | Resource doesn't exist |\n| `CONFLICT` | 409 | Resource already exists or state conflict |\n| `RATE_LIMIT_EXCEEDED` | 429 | Too many requests |\n| `INTERNAL_ERROR` | 500 | Unexpected server error |\n\n## Client Handling\n\n```typescript\n// packages/web/src/lib/api/client.ts\n\nasync function handleResponse<T>(response: Response): Promise<T> {\n  if (!response.ok) {\n    const error = await response.json() as ApiErrorResponse;\n\n    switch (error.error.code) {\n      case 'UNAUTHORIZED':\n        // Trigger token refresh or redirect to login\n        authStore.handleUnauthorized();\n        break;\n\n      case 'RATE_LIMIT_EXCEEDED':\n        // Show rate limit message\n        const retryAfter = error.error.details?.retryAfter;\n        toast.error(`Too many requests. Try again in ${retryAfter} seconds.`);\n        break;\n\n      case 'VALIDATION_ERROR':\n        // Show validation errors in form\n        throw new ValidationError(error.error.details);\n\n      default:\n        toast.error(error.error.message);\n    }\n\n    throw error;\n  }\n\n  return response.json();\n}\n```\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:18:24.345Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/multi-tenancy.md",
        "content": "# Multi-Tenancy Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) and [c3-3](../c3-3-database.md)\n\n## Overview\n\nTaskFlow uses schema-based multi-tenancy where each workspace has an isolated PostgreSQL schema for its data, while global entities (users, workspaces) live in the public schema.\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                      PostgreSQL Database                         │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│  ┌────────────────────────────────────────────────────────────┐ │\n│  │                     PUBLIC SCHEMA                           │ │\n│  │  Global entities shared across all tenants                  │ │\n│  │  ─────────────────────────────────────────────────────────  │ │\n│  │  • users              • team_memberships                    │ │\n│  │  • workspaces         • invites                             │ │\n│  │  • refresh_tokens     • audit_log                           │ │\n│  └────────────────────────────────────────────────────────────┘ │\n│                                                                  │\n│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ │\n│  │  ws_abc123...    │ │  ws_def456...    │ │  ws_ghi789...    │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  Workspace A     │ │  Workspace B     │ │  Workspace C     │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  boards          │ │  boards          │ │  boards          │ │\n│  │  columns         │ │  columns         │ │  columns         │ │\n│  │  tasks           │ │  tasks           │ │  tasks           │ │\n│  │  comments        │ │  comments        │ │  comments        │ │\n│  │  labels          │ │  labels          │ │  labels          │ │\n│  │  attachments     │ │  attachments     │ │  attachments     │ │\n│  └──────────────────┘ └──────────────────┘ └──────────────────┘ │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Benefits\n\n| Benefit | Description |\n|---------|-------------|\n| **Data Isolation** | Complete separation between workspaces |\n| **Regulatory Compliance** | Can implement per-tenant data residency |\n| **Performance** | Smaller indexes per schema, better query perf |\n| **Backup/Restore** | Can backup individual workspace schemas |\n| **Future Migration** | Easy to move a workspace to dedicated DB |\n\n## Implementation\n\n### Schema Provisioning\n\n```typescript\n// foundation/database/tenant.ts\n\nimport { db } from './client';\n\n// SQL template for workspace schema\nconst WORKSPACE_SCHEMA_SQL = `\n-- Boards\nCREATE TABLE boards (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  is_archived BOOLEAN DEFAULT FALSE,\n  position INTEGER NOT NULL DEFAULT 0,\n  created_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Columns\nCREATE TABLE columns (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  board_id UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n  name VARCHAR(255) NOT NULL,\n  color VARCHAR(7),\n  position INTEGER NOT NULL,\n  wip_limit INTEGER,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Tasks\nCREATE TABLE tasks (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  column_id UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n  title VARCHAR(500) NOT NULL,\n  description TEXT,\n  position INTEGER NOT NULL,\n  priority VARCHAR(20) DEFAULT 'medium',\n  due_date DATE,\n  assignee_id UUID,\n  created_by UUID NOT NULL,\n  completed_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n  CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- Comments\nCREATE TABLE comments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  user_id UUID NOT NULL,\n  content TEXT NOT NULL,\n  edited_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Labels\nCREATE TABLE labels (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(100) NOT NULL UNIQUE,\n  color VARCHAR(7) NOT NULL\n);\n\n-- Task Labels (M2M)\nCREATE TABLE task_labels (\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  label_id UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n  PRIMARY KEY (task_id, label_id)\n);\n\n-- Attachments\nCREATE TABLE attachments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  filename VARCHAR(255) NOT NULL,\n  file_url VARCHAR(1000) NOT NULL,\n  file_size BIGINT NOT NULL,\n  mime_type VARCHAR(100) NOT NULL,\n  uploaded_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Indexes\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n`;\n\nexport async function provisionWorkspaceSchema(workspaceId: string): Promise<string> {\n  // Generate safe schema name\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await db.client.$transaction(async (tx) => {\n    // Create schema\n    await tx.$executeRawUnsafe(`CREATE SCHEMA IF NOT EXISTS \"${schemaName}\"`);\n\n    // Set search path to new schema\n    await tx.$executeRawUnsafe(`SET search_path TO \"${schemaName}\"`);\n\n    // Create tables\n    await tx.$executeRawUnsafe(WORKSPACE_SCHEMA_SQL);\n\n    // Reset search path\n    await tx.$executeRawUnsafe('SET search_path TO public');\n\n    // Update workspace record\n    await tx.workspace.update({\n      where: { id: workspaceId },\n      data: { schemaName }\n    });\n  });\n\n  return schemaName;\n}\n\nexport async function deprovisionWorkspaceSchema(schemaName: string): Promise<void> {\n  // Drop schema and all its objects\n  await db.client.$executeRawUnsafe(`DROP SCHEMA IF EXISTS \"${schemaName}\" CASCADE`);\n}\n```\n\n### Request Context Middleware\n\n```typescript\n// middleware/workspace.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { db } from '@/foundation/database';\nimport { ForbiddenError, NotFoundError } from '@/shared/errors';\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      workspaceId?: string;\n      workspaceSchema?: string;\n      userRole?: string;\n    }\n  }\n}\n\nexport async function workspaceContext(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  // Get workspace ID from header or path parameter\n  const workspaceId = req.headers['x-workspace-id'] as string\n    || req.params.workspaceId;\n\n  if (!workspaceId) {\n    next();\n    return;\n  }\n\n  // Fetch workspace\n  const workspace = await db.client.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    throw new NotFoundError('Workspace');\n  }\n\n  // Verify user is a member\n  const membership = await db.client.teamMembership.findUnique({\n    where: {\n      userId_workspaceId: {\n        userId: req.userId!,\n        workspaceId\n      }\n    }\n  });\n\n  if (!membership) {\n    throw new ForbiddenError('Not a member of this workspace');\n  }\n\n  // Attach to request\n  req.workspaceId = workspaceId;\n  req.workspaceSchema = workspace.schemaName;\n  req.userRole = membership.role;\n\n  next();\n}\n```\n\n### Service Usage\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nexport class TaskboardService {\n  private schemaName: string;\n\n  constructor(schemaName: string) {\n    this.schemaName = schemaName;\n  }\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards WHERE is_archived = false ORDER BY position\n      `;\n    });\n  }\n}\n\n// In controller\nexport const taskboardController = {\n  async listBoards(req: Request, res: Response) {\n    const service = new TaskboardService(req.workspaceSchema!);\n    const boards = await service.listBoards();\n    res.json({ data: boards });\n  }\n};\n```\n\n## Cross-Reference Pattern\n\nWorkspace tables reference users by UUID but don't have FK constraints to public schema:\n\n```sql\n-- In workspace schema\nCREATE TABLE tasks (\n  ...\n  assignee_id UUID,        -- References public.users(id)\n  created_by UUID NOT NULL -- References public.users(id)\n  -- No FK constraint: cross-schema FKs are not recommended\n);\n```\n\nTo resolve user data:\n\n```typescript\nasync function getTaskWithAssignee(taskId: string, schemaName: string) {\n  const task = await db.withWorkspace(schemaName, async (prisma) => {\n    return prisma.$queryRaw`SELECT * FROM tasks WHERE id = ${taskId}`;\n  });\n\n  // Fetch user from public schema\n  if (task.assigneeId) {\n    task.assignee = await db.client.user.findUnique({\n      where: { id: task.assigneeId },\n      select: { id: true, name: true, avatarUrl: true }\n    });\n  }\n\n  return task;\n}\n```\n\n## Migration Strategy\n\nWhen applying schema changes:\n\n```typescript\n// migrations/apply-to-all-workspaces.ts\n\nasync function applyMigration(migrationSql: string): Promise<void> {\n  const workspaces = await db.client.workspace.findMany({\n    select: { schemaName: true }\n  });\n\n  for (const workspace of workspaces) {\n    await db.client.$executeRawUnsafe(\n      `SET search_path TO \"${workspace.schemaName}\"`\n    );\n    await db.client.$executeRawUnsafe(migrationSql);\n  }\n\n  await db.client.$executeRawUnsafe('SET search_path TO public');\n}\n```\n\n## Security Considerations\n\n1. **Schema name validation**: Always use parameterized names, never user input\n2. **Search path injection**: Reset search path after operations\n3. **Workspace verification**: Always verify membership before schema access\n4. **Audit logging**: Log all cross-workspace access attempts\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:18:24.365Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/refs/multi-tenancy.md",
        "content": "# Multi-Tenancy Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) and [c3-3](../c3-3-database.md)\n\n## Overview\n\nTaskFlow uses schema-based multi-tenancy where each workspace has an isolated PostgreSQL schema for its data, while global entities (users, workspaces) live in the public schema.\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                      PostgreSQL Database                         │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│  ┌────────────────────────────────────────────────────────────┐ │\n│  │                     PUBLIC SCHEMA                           │ │\n│  │  Global entities shared across all tenants                  │ │\n│  │  ─────────────────────────────────────────────────────────  │ │\n│  │  • users              • team_memberships                    │ │\n│  │  • workspaces         • invites                             │ │\n│  │  • refresh_tokens     • audit_log                           │ │\n│  └────────────────────────────────────────────────────────────┘ │\n│                                                                  │\n│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ │\n│  │  ws_abc123...    │ │  ws_def456...    │ │  ws_ghi789...    │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  Workspace A     │ │  Workspace B     │ │  Workspace C     │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  boards          │ │  boards          │ │  boards          │ │\n│  │  columns         │ │  columns         │ │  columns         │ │\n│  │  tasks           │ │  tasks           │ │  tasks           │ │\n│  │  comments        │ │  comments        │ │  comments        │ │\n│  │  labels          │ │  labels          │ │  labels          │ │\n│  │  attachments     │ │  attachments     │ │  attachments     │ │\n│  └──────────────────┘ └──────────────────┘ └──────────────────┘ │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Benefits\n\n| Benefit | Description |\n|---------|-------------|\n| **Data Isolation** | Complete separation between workspaces |\n| **Regulatory Compliance** | Can implement per-tenant data residency |\n| **Performance** | Smaller indexes per schema, better query perf |\n| **Backup/Restore** | Can backup individual workspace schemas |\n| **Future Migration** | Easy to move a workspace to dedicated DB |\n\n## Implementation\n\n### Schema Provisioning\n\n```typescript\n// foundation/database/tenant.ts\n\nimport { db } from './client';\n\n// SQL template for workspace schema\nconst WORKSPACE_SCHEMA_SQL = `\n-- Boards\nCREATE TABLE boards (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  is_archived BOOLEAN DEFAULT FALSE,\n  position INTEGER NOT NULL DEFAULT 0,\n  created_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Columns\nCREATE TABLE columns (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  board_id UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n  name VARCHAR(255) NOT NULL,\n  color VARCHAR(7),\n  position INTEGER NOT NULL,\n  wip_limit INTEGER,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Tasks\nCREATE TABLE tasks (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  column_id UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n  title VARCHAR(500) NOT NULL,\n  description TEXT,\n  position INTEGER NOT NULL,\n  priority VARCHAR(20) DEFAULT 'medium',\n  due_date DATE,\n  assignee_id UUID,\n  created_by UUID NOT NULL,\n  completed_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n  CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- Comments\nCREATE TABLE comments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  user_id UUID NOT NULL,\n  content TEXT NOT NULL,\n  edited_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Labels\nCREATE TABLE labels (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(100) NOT NULL UNIQUE,\n  color VARCHAR(7) NOT NULL\n);\n\n-- Task Labels (M2M)\nCREATE TABLE task_labels (\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  label_id UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n  PRIMARY KEY (task_id, label_id)\n);\n\n-- Attachments\nCREATE TABLE attachments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  filename VARCHAR(255) NOT NULL,\n  file_url VARCHAR(1000) NOT NULL,\n  file_size BIGINT NOT NULL,\n  mime_type VARCHAR(100) NOT NULL,\n  uploaded_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Indexes\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n`;\n\nexport async function provisionWorkspaceSchema(workspaceId: string): Promise<string> {\n  // Generate safe schema name\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await db.client.$transaction(async (tx) => {\n    // Create schema\n    await tx.$executeRawUnsafe(`CREATE SCHEMA IF NOT EXISTS \"${schemaName}\"`);\n\n    // Set search path to new schema\n    await tx.$executeRawUnsafe(`SET search_path TO \"${schemaName}\"`);\n\n    // Create tables\n    await tx.$executeRawUnsafe(WORKSPACE_SCHEMA_SQL);\n\n    // Reset search path\n    await tx.$executeRawUnsafe('SET search_path TO public');\n\n    // Update workspace record\n    await tx.workspace.update({\n      where: { id: workspaceId },\n      data: { schemaName }\n    });\n  });\n\n  return schemaName;\n}\n\nexport async function deprovisionWorkspaceSchema(schemaName: string): Promise<void> {\n  // Drop schema and all its objects\n  await db.client.$executeRawUnsafe(`DROP SCHEMA IF EXISTS \"${schemaName}\" CASCADE`);\n}\n```\n\n### Request Context Middleware\n\n```typescript\n// middleware/workspace.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { db } from '@/foundation/database';\nimport { ForbiddenError, NotFoundError } from '@/shared/errors';\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      workspaceId?: string;\n      workspaceSchema?: string;\n      userRole?: string;\n    }\n  }\n}\n\nexport async function workspaceContext(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  // Get workspace ID from header or path parameter\n  const workspaceId = req.headers['x-workspace-id'] as string\n    || req.params.workspaceId;\n\n  if (!workspaceId) {\n    next();\n    return;\n  }\n\n  // Fetch workspace\n  const workspace = await db.client.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    throw new NotFoundError('Workspace');\n  }\n\n  // Verify user is a member\n  const membership = await db.client.teamMembership.findUnique({\n    where: {\n      userId_workspaceId: {\n        userId: req.userId!,\n        workspaceId\n      }\n    }\n  });\n\n  if (!membership) {\n    throw new ForbiddenError('Not a member of this workspace');\n  }\n\n  // Attach to request\n  req.workspaceId = workspaceId;\n  req.workspaceSchema = workspace.schemaName;\n  req.userRole = membership.role;\n\n  next();\n}\n```\n\n### Service Usage\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nexport class TaskboardService {\n  private schemaName: string;\n\n  constructor(schemaName: string) {\n    this.schemaName = schemaName;\n  }\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards WHERE is_archived = false ORDER BY position\n      `;\n    });\n  }\n}\n\n// In controller\nexport const taskboardController = {\n  async listBoards(req: Request, res: Response) {\n    const service = new TaskboardService(req.workspaceSchema!);\n    const boards = await service.listBoards();\n    res.json({ data: boards });\n  }\n};\n```\n\n## Cross-Reference Pattern\n\nWorkspace tables reference users by UUID but don't have FK constraints to public schema:\n\n```sql\n-- In workspace schema\nCREATE TABLE tasks (\n  ...\n  assignee_id UUID,        -- References public.users(id)\n  created_by UUID NOT NULL -- References public.users(id)\n  -- No FK constraint: cross-schema FKs are not recommended\n);\n```\n\nTo resolve user data:\n\n```typescript\nasync function getTaskWithAssignee(taskId: string, schemaName: string) {\n  const task = await db.withWorkspace(schemaName, async (prisma) => {\n    return prisma.$queryRaw`SELECT * FROM tasks WHERE id = ${taskId}`;\n  });\n\n  // Fetch user from public schema\n  if (task.assigneeId) {\n    task.assignee = await db.client.user.findUnique({\n      where: { id: task.assigneeId },\n      select: { id: true, name: true, avatarUrl: true }\n    });\n  }\n\n  return task;\n}\n```\n\n## Migration Strategy\n\nWhen applying schema changes:\n\n```typescript\n// migrations/apply-to-all-workspaces.ts\n\nasync function applyMigration(migrationSql: string): Promise<void> {\n  const workspaces = await db.client.workspace.findMany({\n    select: { schemaName: true }\n  });\n\n  for (const workspace of workspaces) {\n    await db.client.$executeRawUnsafe(\n      `SET search_path TO \"${workspace.schemaName}\"`\n    );\n    await db.client.$executeRawUnsafe(migrationSql);\n  }\n\n  await db.client.$executeRawUnsafe('SET search_path TO public');\n}\n```\n\n## Security Considerations\n\n1. **Schema name validation**: Always use parameterized names, never user input\n2. **Search path injection**: Reset search path after operations\n3. **Workspace verification**: Always verify membership before schema access\n4. **Audit logging**: Log all cross-workspace access attempts\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/refs/multi-tenancy.md",
        "content": "# Multi-Tenancy Pattern\n\n> **Type**: Reference | **Applies to**: [c3-2](../c3-2-api.md) and [c3-3](../c3-3-database.md)\n\n## Overview\n\nTaskFlow uses schema-based multi-tenancy where each workspace has an isolated PostgreSQL schema for its data, while global entities (users, workspaces) live in the public schema.\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                      PostgreSQL Database                         │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│  ┌────────────────────────────────────────────────────────────┐ │\n│  │                     PUBLIC SCHEMA                           │ │\n│  │  Global entities shared across all tenants                  │ │\n│  │  ─────────────────────────────────────────────────────────  │ │\n│  │  • users              • team_memberships                    │ │\n│  │  • workspaces         • invites                             │ │\n│  │  • refresh_tokens     • audit_log                           │ │\n│  └────────────────────────────────────────────────────────────┘ │\n│                                                                  │\n│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ │\n│  │  ws_abc123...    │ │  ws_def456...    │ │  ws_ghi789...    │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  Workspace A     │ │  Workspace B     │ │  Workspace C     │ │\n│  │  ──────────────  │ │  ──────────────  │ │  ──────────────  │ │\n│  │  boards          │ │  boards          │ │  boards          │ │\n│  │  columns         │ │  columns         │ │  columns         │ │\n│  │  tasks           │ │  tasks           │ │  tasks           │ │\n│  │  comments        │ │  comments        │ │  comments        │ │\n│  │  labels          │ │  labels          │ │  labels          │ │\n│  │  attachments     │ │  attachments     │ │  attachments     │ │\n│  └──────────────────┘ └──────────────────┘ └──────────────────┘ │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Benefits\n\n| Benefit | Description |\n|---------|-------------|\n| **Data Isolation** | Complete separation between workspaces |\n| **Regulatory Compliance** | Can implement per-tenant data residency |\n| **Performance** | Smaller indexes per schema, better query perf |\n| **Backup/Restore** | Can backup individual workspace schemas |\n| **Future Migration** | Easy to move a workspace to dedicated DB |\n\n## Implementation\n\n### Schema Provisioning\n\n```typescript\n// foundation/database/tenant.ts\n\nimport { db } from './client';\n\n// SQL template for workspace schema\nconst WORKSPACE_SCHEMA_SQL = `\n-- Boards\nCREATE TABLE boards (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(255) NOT NULL,\n  description TEXT,\n  is_archived BOOLEAN DEFAULT FALSE,\n  position INTEGER NOT NULL DEFAULT 0,\n  created_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Columns\nCREATE TABLE columns (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  board_id UUID NOT NULL REFERENCES boards(id) ON DELETE CASCADE,\n  name VARCHAR(255) NOT NULL,\n  color VARCHAR(7),\n  position INTEGER NOT NULL,\n  wip_limit INTEGER,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Tasks\nCREATE TABLE tasks (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  column_id UUID NOT NULL REFERENCES columns(id) ON DELETE CASCADE,\n  title VARCHAR(500) NOT NULL,\n  description TEXT,\n  position INTEGER NOT NULL,\n  priority VARCHAR(20) DEFAULT 'medium',\n  due_date DATE,\n  assignee_id UUID,\n  created_by UUID NOT NULL,\n  completed_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW(),\n  updated_at TIMESTAMPTZ DEFAULT NOW(),\n  CHECK (priority IN ('low', 'medium', 'high', 'urgent'))\n);\n\n-- Comments\nCREATE TABLE comments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  user_id UUID NOT NULL,\n  content TEXT NOT NULL,\n  edited_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Labels\nCREATE TABLE labels (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  name VARCHAR(100) NOT NULL UNIQUE,\n  color VARCHAR(7) NOT NULL\n);\n\n-- Task Labels (M2M)\nCREATE TABLE task_labels (\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  label_id UUID NOT NULL REFERENCES labels(id) ON DELETE CASCADE,\n  PRIMARY KEY (task_id, label_id)\n);\n\n-- Attachments\nCREATE TABLE attachments (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  filename VARCHAR(255) NOT NULL,\n  file_url VARCHAR(1000) NOT NULL,\n  file_size BIGINT NOT NULL,\n  mime_type VARCHAR(100) NOT NULL,\n  uploaded_by UUID NOT NULL,\n  created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Indexes\nCREATE INDEX idx_columns_board ON columns(board_id, position);\nCREATE INDEX idx_tasks_column ON tasks(column_id, position);\nCREATE INDEX idx_tasks_assignee ON tasks(assignee_id);\nCREATE INDEX idx_tasks_due_date ON tasks(due_date) WHERE due_date IS NOT NULL;\nCREATE INDEX idx_comments_task ON comments(task_id, created_at);\n`;\n\nexport async function provisionWorkspaceSchema(workspaceId: string): Promise<string> {\n  // Generate safe schema name\n  const schemaName = `ws_${workspaceId.replace(/-/g, '_')}`;\n\n  await db.client.$transaction(async (tx) => {\n    // Create schema\n    await tx.$executeRawUnsafe(`CREATE SCHEMA IF NOT EXISTS \"${schemaName}\"`);\n\n    // Set search path to new schema\n    await tx.$executeRawUnsafe(`SET search_path TO \"${schemaName}\"`);\n\n    // Create tables\n    await tx.$executeRawUnsafe(WORKSPACE_SCHEMA_SQL);\n\n    // Reset search path\n    await tx.$executeRawUnsafe('SET search_path TO public');\n\n    // Update workspace record\n    await tx.workspace.update({\n      where: { id: workspaceId },\n      data: { schemaName }\n    });\n  });\n\n  return schemaName;\n}\n\nexport async function deprovisionWorkspaceSchema(schemaName: string): Promise<void> {\n  // Drop schema and all its objects\n  await db.client.$executeRawUnsafe(`DROP SCHEMA IF EXISTS \"${schemaName}\" CASCADE`);\n}\n```\n\n### Request Context Middleware\n\n```typescript\n// middleware/workspace.ts\n\nimport { Request, Response, NextFunction } from 'express';\nimport { db } from '@/foundation/database';\nimport { ForbiddenError, NotFoundError } from '@/shared/errors';\n\ndeclare global {\n  namespace Express {\n    interface Request {\n      workspaceId?: string;\n      workspaceSchema?: string;\n      userRole?: string;\n    }\n  }\n}\n\nexport async function workspaceContext(\n  req: Request,\n  res: Response,\n  next: NextFunction\n): Promise<void> {\n  // Get workspace ID from header or path parameter\n  const workspaceId = req.headers['x-workspace-id'] as string\n    || req.params.workspaceId;\n\n  if (!workspaceId) {\n    next();\n    return;\n  }\n\n  // Fetch workspace\n  const workspace = await db.client.workspace.findUnique({\n    where: { id: workspaceId }\n  });\n\n  if (!workspace) {\n    throw new NotFoundError('Workspace');\n  }\n\n  // Verify user is a member\n  const membership = await db.client.teamMembership.findUnique({\n    where: {\n      userId_workspaceId: {\n        userId: req.userId!,\n        workspaceId\n      }\n    }\n  });\n\n  if (!membership) {\n    throw new ForbiddenError('Not a member of this workspace');\n  }\n\n  // Attach to request\n  req.workspaceId = workspaceId;\n  req.workspaceSchema = workspace.schemaName;\n  req.userRole = membership.role;\n\n  next();\n}\n```\n\n### Service Usage\n\n```typescript\n// modules/taskboard/taskboard.service.ts\n\nexport class TaskboardService {\n  private schemaName: string;\n\n  constructor(schemaName: string) {\n    this.schemaName = schemaName;\n  }\n\n  async listBoards(): Promise<Board[]> {\n    return db.withWorkspace(this.schemaName, async (prisma) => {\n      return prisma.$queryRaw`\n        SELECT * FROM boards WHERE is_archived = false ORDER BY position\n      `;\n    });\n  }\n}\n\n// In controller\nexport const taskboardController = {\n  async listBoards(req: Request, res: Response) {\n    const service = new TaskboardService(req.workspaceSchema!);\n    const boards = await service.listBoards();\n    res.json({ data: boards });\n  }\n};\n```\n\n## Cross-Reference Pattern\n\nWorkspace tables reference users by UUID but don't have FK constraints to public schema:\n\n```sql\n-- In workspace schema\nCREATE TABLE tasks (\n  ...\n  assignee_id UUID,        -- References public.users(id)\n  created_by UUID NOT NULL -- References public.users(id)\n  -- No FK constraint: cross-schema FKs are not recommended\n);\n```\n\nTo resolve user data:\n\n```typescript\nasync function getTaskWithAssignee(taskId: string, schemaName: string) {\n  const task = await db.withWorkspace(schemaName, async (prisma) => {\n    return prisma.$queryRaw`SELECT * FROM tasks WHERE id = ${taskId}`;\n  });\n\n  // Fetch user from public schema\n  if (task.assigneeId) {\n    task.assignee = await db.client.user.findUnique({\n      where: { id: task.assigneeId },\n      select: { id: true, name: true, avatarUrl: true }\n    });\n  }\n\n  return task;\n}\n```\n\n## Migration Strategy\n\nWhen applying schema changes:\n\n```typescript\n// migrations/apply-to-all-workspaces.ts\n\nasync function applyMigration(migrationSql: string): Promise<void> {\n  const workspaces = await db.client.workspace.findMany({\n    select: { schemaName: true }\n  });\n\n  for (const workspace of workspaces) {\n    await db.client.$executeRawUnsafe(\n      `SET search_path TO \"${workspace.schemaName}\"`\n    );\n    await db.client.$executeRawUnsafe(migrationSql);\n  }\n\n  await db.client.$executeRawUnsafe('SET search_path TO public');\n}\n```\n\n## Security Considerations\n\n1. **Schema name validation**: Always use parameterized names, never user input\n2. **Search path injection**: Reset search path after operations\n3. **Workspace verification**: Always verify membership before schema access\n4. **Audit logging**: Log all cross-workspace access attempts\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:18:30.124Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "in_progress",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:18:30.134Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "in_progress",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "in_progress",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "pending",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "in_progress",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:18:58.718Z",
      "event": "PreToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/index.md",
        "content": "# TaskFlow Architecture (C3)\n\n> **Last Updated**: 2026-01-12 | **Status**: Planning Phase\n\n## System Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on Kanban-style task boards within isolated team workspaces.\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                     TASKFLOW ARCHITECTURE                        │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│   Users ──────────► React SPA ──────────► Express API           │\n│                      [c3-1]                 [c3-2]               │\n│                         │                     │                  │\n│                         │    WebSocket        │                  │\n│                         └──────────┬──────────┘                  │\n│                                    │                             │\n│                    ┌───────────────┼───────────────┐             │\n│                    ▼               ▼               ▼             │\n│              PostgreSQL        Redis           Redis             │\n│               [c3-3]         (Cache)        (Pub/Sub)            │\n│                               [c3-4]          [c3-4]             │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Quick Navigation\n\n### Architecture Decision Records\n\n| ADR | Title | Status |\n|-----|-------|--------|\n| [ADR-000](adrs/adr-000-system-blueprint.md) | System Blueprint | Accepted |\n\n### Context & Containers (C4 Level 1-2)\n\n| ID | Name | Type | Description |\n|----|------|------|-------------|\n| [c3-0](c3-0-context.md) | System Context | Context | External actors and systems |\n| [c3-1](c3-1-web.md) | Web Application | Container | React SPA frontend |\n| [c3-2](c3-2-api.md) | API Server | Container | Express.js backend |\n| [c3-3](c3-3-database.md) | Database | Container | PostgreSQL with multi-tenant schemas |\n| [c3-4](c3-4-cache.md) | Cache | Container | Redis for caching and pub/sub |\n\n### Components (C4 Level 3)\n\n#### API Server Foundation Layer\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.7](components/c3-2.7-database.md) | Database Client | c3-2 | Prisma ORM wrapper with multi-tenant support |\n| [c3-2.8](components/c3-2.8-cache.md) | Cache Client | c3-2 | Redis client with typed operations |\n| [c3-2.9](components/c3-2.9-websocket.md) | WebSocket Server | c3-2 | Socket.io with Redis adapter |\n| [c3-2.10](components/c3-2.10-events.md) | Events Bus | c3-2 | Internal pub/sub for module decoupling |\n\n#### API Server Feature Modules\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.1](components/c3-2.1-auth-module.md) | Auth Module | c3-2 | Google OAuth, JWT management |\n| [c3-2.5](components/c3-2.5-taskboard-module.md) | TaskBoard Module | c3-2 | Boards, columns, tasks, real-time sync |\n\n### Reference Patterns\n\n| Pattern | Description |\n|---------|-------------|\n| [Module Structure](refs/module-structure.md) | Standard feature module organization |\n| [Error Handling](refs/error-handling.md) | Consistent error responses and classes |\n| [Multi-Tenancy](refs/multi-tenancy.md) | Schema-based tenant isolation |\n\n## Technology Stack\n\n| Layer | Technology | Version |\n|-------|------------|---------|\n| Frontend | React + TypeScript + Vite | 18.x / 5.x / 5.x |\n| Backend | Node.js + Express + TypeScript | 20.x LTS / 4.x / 5.x |\n| Database | PostgreSQL + Prisma | 16.x / 5.x |\n| Cache | Redis + ioredis | 7.x / 5.x |\n| Real-time | Socket.io | 4.x |\n| Validation | Zod | 3.x |\n\n## Key Architectural Decisions\n\n1. **Modular Monolith**: Single deployable with clear module boundaries\n2. **Schema-based Multi-tenancy**: PostgreSQL schema per workspace\n3. **Event-Driven**: Internal event bus for module decoupling\n4. **Real-time First**: WebSocket with Redis pub/sub for scaling\n\n## Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA [c3-1]\n│   │   ├── src/\n│   │   │   ├── features/       # Feature modules\n│   │   │   ├── components/     # Shared components\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API [c3-2]\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   └── middleware/     # Express middleware\n│   │   ├── prisma/             # Database schema\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types\n│       └── src/types/\n│\n├── .c3/                        # This documentation\n├── docker-compose.yml\n└── package.json\n```\n\n## Getting Started\n\n### Prerequisites\n- Node.js 20.x LTS\n- PostgreSQL 16.x\n- Redis 7.x\n- pnpm (package manager)\n\n### Local Development\n```bash\n# Clone and install\ngit clone <repo>\npnpm install\n\n# Start infrastructure\ndocker-compose up -d postgres redis\n\n# Run migrations\npnpm --filter api db:migrate\n\n# Start development servers\npnpm dev\n```\n\n## Contributing\n\nBefore making architectural changes:\n1. Create an ADR in `.c3/adrs/`\n2. Update relevant container/component docs\n3. Get review from tech lead\n"
      }
    },
    {
      "timestamp": "2026-01-12T12:18:58.733Z",
      "event": "PostToolUse",
      "tool": "Write",
      "input": {
        "file_path": "/tmp/tmp.W3TPal6rM5/.c3/index.md",
        "content": "# TaskFlow Architecture (C3)\n\n> **Last Updated**: 2026-01-12 | **Status**: Planning Phase\n\n## System Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on Kanban-style task boards within isolated team workspaces.\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                     TASKFLOW ARCHITECTURE                        │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│   Users ──────────► React SPA ──────────► Express API           │\n│                      [c3-1]                 [c3-2]               │\n│                         │                     │                  │\n│                         │    WebSocket        │                  │\n│                         └──────────┬──────────┘                  │\n│                                    │                             │\n│                    ┌───────────────┼───────────────┐             │\n│                    ▼               ▼               ▼             │\n│              PostgreSQL        Redis           Redis             │\n│               [c3-3]         (Cache)        (Pub/Sub)            │\n│                               [c3-4]          [c3-4]             │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Quick Navigation\n\n### Architecture Decision Records\n\n| ADR | Title | Status |\n|-----|-------|--------|\n| [ADR-000](adrs/adr-000-system-blueprint.md) | System Blueprint | Accepted |\n\n### Context & Containers (C4 Level 1-2)\n\n| ID | Name | Type | Description |\n|----|------|------|-------------|\n| [c3-0](c3-0-context.md) | System Context | Context | External actors and systems |\n| [c3-1](c3-1-web.md) | Web Application | Container | React SPA frontend |\n| [c3-2](c3-2-api.md) | API Server | Container | Express.js backend |\n| [c3-3](c3-3-database.md) | Database | Container | PostgreSQL with multi-tenant schemas |\n| [c3-4](c3-4-cache.md) | Cache | Container | Redis for caching and pub/sub |\n\n### Components (C4 Level 3)\n\n#### API Server Foundation Layer\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.7](components/c3-2.7-database.md) | Database Client | c3-2 | Prisma ORM wrapper with multi-tenant support |\n| [c3-2.8](components/c3-2.8-cache.md) | Cache Client | c3-2 | Redis client with typed operations |\n| [c3-2.9](components/c3-2.9-websocket.md) | WebSocket Server | c3-2 | Socket.io with Redis adapter |\n| [c3-2.10](components/c3-2.10-events.md) | Events Bus | c3-2 | Internal pub/sub for module decoupling |\n\n#### API Server Feature Modules\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.1](components/c3-2.1-auth-module.md) | Auth Module | c3-2 | Google OAuth, JWT management |\n| [c3-2.5](components/c3-2.5-taskboard-module.md) | TaskBoard Module | c3-2 | Boards, columns, tasks, real-time sync |\n\n### Reference Patterns\n\n| Pattern | Description |\n|---------|-------------|\n| [Module Structure](refs/module-structure.md) | Standard feature module organization |\n| [Error Handling](refs/error-handling.md) | Consistent error responses and classes |\n| [Multi-Tenancy](refs/multi-tenancy.md) | Schema-based tenant isolation |\n\n## Technology Stack\n\n| Layer | Technology | Version |\n|-------|------------|---------|\n| Frontend | React + TypeScript + Vite | 18.x / 5.x / 5.x |\n| Backend | Node.js + Express + TypeScript | 20.x LTS / 4.x / 5.x |\n| Database | PostgreSQL + Prisma | 16.x / 5.x |\n| Cache | Redis + ioredis | 7.x / 5.x |\n| Real-time | Socket.io | 4.x |\n| Validation | Zod | 3.x |\n\n## Key Architectural Decisions\n\n1. **Modular Monolith**: Single deployable with clear module boundaries\n2. **Schema-based Multi-tenancy**: PostgreSQL schema per workspace\n3. **Event-Driven**: Internal event bus for module decoupling\n4. **Real-time First**: WebSocket with Redis pub/sub for scaling\n\n## Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA [c3-1]\n│   │   ├── src/\n│   │   │   ├── features/       # Feature modules\n│   │   │   ├── components/     # Shared components\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API [c3-2]\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   └── middleware/     # Express middleware\n│   │   ├── prisma/             # Database schema\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types\n│       └── src/types/\n│\n├── .c3/                        # This documentation\n├── docker-compose.yml\n└── package.json\n```\n\n## Getting Started\n\n### Prerequisites\n- Node.js 20.x LTS\n- PostgreSQL 16.x\n- Redis 7.x\n- pnpm (package manager)\n\n### Local Development\n```bash\n# Clone and install\ngit clone <repo>\npnpm install\n\n# Start infrastructure\ndocker-compose up -d postgres redis\n\n# Run migrations\npnpm --filter api db:migrate\n\n# Start development servers\npnpm dev\n```\n\n## Contributing\n\nBefore making architectural changes:\n1. Create an ADR in `.c3/adrs/`\n2. Update relevant container/component docs\n3. Get review from tech lead\n"
      },
      "result": {
        "type": "create",
        "filePath": "/tmp/tmp.W3TPal6rM5/.c3/index.md",
        "content": "# TaskFlow Architecture (C3)\n\n> **Last Updated**: 2026-01-12 | **Status**: Planning Phase\n\n## System Overview\n\nTaskFlow is a task management SaaS for small teams, enabling real-time collaboration on Kanban-style task boards within isolated team workspaces.\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                     TASKFLOW ARCHITECTURE                        │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                  │\n│   Users ──────────► React SPA ──────────► Express API           │\n│                      [c3-1]                 [c3-2]               │\n│                         │                     │                  │\n│                         │    WebSocket        │                  │\n│                         └──────────┬──────────┘                  │\n│                                    │                             │\n│                    ┌───────────────┼───────────────┐             │\n│                    ▼               ▼               ▼             │\n│              PostgreSQL        Redis           Redis             │\n│               [c3-3]         (Cache)        (Pub/Sub)            │\n│                               [c3-4]          [c3-4]             │\n│                                                                  │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## Quick Navigation\n\n### Architecture Decision Records\n\n| ADR | Title | Status |\n|-----|-------|--------|\n| [ADR-000](adrs/adr-000-system-blueprint.md) | System Blueprint | Accepted |\n\n### Context & Containers (C4 Level 1-2)\n\n| ID | Name | Type | Description |\n|----|------|------|-------------|\n| [c3-0](c3-0-context.md) | System Context | Context | External actors and systems |\n| [c3-1](c3-1-web.md) | Web Application | Container | React SPA frontend |\n| [c3-2](c3-2-api.md) | API Server | Container | Express.js backend |\n| [c3-3](c3-3-database.md) | Database | Container | PostgreSQL with multi-tenant schemas |\n| [c3-4](c3-4-cache.md) | Cache | Container | Redis for caching and pub/sub |\n\n### Components (C4 Level 3)\n\n#### API Server Foundation Layer\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.7](components/c3-2.7-database.md) | Database Client | c3-2 | Prisma ORM wrapper with multi-tenant support |\n| [c3-2.8](components/c3-2.8-cache.md) | Cache Client | c3-2 | Redis client with typed operations |\n| [c3-2.9](components/c3-2.9-websocket.md) | WebSocket Server | c3-2 | Socket.io with Redis adapter |\n| [c3-2.10](components/c3-2.10-events.md) | Events Bus | c3-2 | Internal pub/sub for module decoupling |\n\n#### API Server Feature Modules\n\n| ID | Name | Parent | Description |\n|----|------|--------|-------------|\n| [c3-2.1](components/c3-2.1-auth-module.md) | Auth Module | c3-2 | Google OAuth, JWT management |\n| [c3-2.5](components/c3-2.5-taskboard-module.md) | TaskBoard Module | c3-2 | Boards, columns, tasks, real-time sync |\n\n### Reference Patterns\n\n| Pattern | Description |\n|---------|-------------|\n| [Module Structure](refs/module-structure.md) | Standard feature module organization |\n| [Error Handling](refs/error-handling.md) | Consistent error responses and classes |\n| [Multi-Tenancy](refs/multi-tenancy.md) | Schema-based tenant isolation |\n\n## Technology Stack\n\n| Layer | Technology | Version |\n|-------|------------|---------|\n| Frontend | React + TypeScript + Vite | 18.x / 5.x / 5.x |\n| Backend | Node.js + Express + TypeScript | 20.x LTS / 4.x / 5.x |\n| Database | PostgreSQL + Prisma | 16.x / 5.x |\n| Cache | Redis + ioredis | 7.x / 5.x |\n| Real-time | Socket.io | 4.x |\n| Validation | Zod | 3.x |\n\n## Key Architectural Decisions\n\n1. **Modular Monolith**: Single deployable with clear module boundaries\n2. **Schema-based Multi-tenancy**: PostgreSQL schema per workspace\n3. **Event-Driven**: Internal event bus for module decoupling\n4. **Real-time First**: WebSocket with Redis pub/sub for scaling\n\n## Directory Structure\n\n```\ntaskflow/\n├── packages/\n│   ├── web/                    # React SPA [c3-1]\n│   │   ├── src/\n│   │   │   ├── features/       # Feature modules\n│   │   │   ├── components/     # Shared components\n│   │   │   └── lib/            # Utilities\n│   │   └── package.json\n│   │\n│   ├── api/                    # Express API [c3-2]\n│   │   ├── src/\n│   │   │   ├── modules/        # Feature modules\n│   │   │   ├── foundation/     # Foundation layer\n│   │   │   └── middleware/     # Express middleware\n│   │   ├── prisma/             # Database schema\n│   │   └── package.json\n│   │\n│   └── shared/                 # Shared types\n│       └── src/types/\n│\n├── .c3/                        # This documentation\n├── docker-compose.yml\n└── package.json\n```\n\n## Getting Started\n\n### Prerequisites\n- Node.js 20.x LTS\n- PostgreSQL 16.x\n- Redis 7.x\n- pnpm (package manager)\n\n### Local Development\n```bash\n# Clone and install\ngit clone <repo>\npnpm install\n\n# Start infrastructure\ndocker-compose up -d postgres redis\n\n# Run migrations\npnpm --filter api db:migrate\n\n# Start development servers\npnpm dev\n```\n\n## Contributing\n\nBefore making architectural changes:\n1. Create an ADR in `.c3/adrs/`\n2. Update relevant container/component docs\n3. Get review from tech lead\n",
        "structuredPatch": [],
        "originalFile": null
      }
    },
    {
      "timestamp": "2026-01-12T12:19:04.760Z",
      "event": "PreToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "completed",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:19:04.769Z",
      "event": "PostToolUse",
      "tool": "TodoWrite",
      "input": {
        "todos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "completed",
            "activeForm": "Creating C3 index"
          }
        ]
      },
      "result": {
        "oldTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "in_progress",
            "activeForm": "Creating C3 index"
          }
        ],
        "newTodos": [
          {
            "content": "Create ADR-000 system blueprint",
            "status": "completed",
            "activeForm": "Creating ADR-000 system blueprint"
          },
          {
            "content": "Create C3 context diagram (c3-0-context.md)",
            "status": "completed",
            "activeForm": "Creating context diagram"
          },
          {
            "content": "Create container diagrams for each deployable unit",
            "status": "completed",
            "activeForm": "Creating container diagrams"
          },
          {
            "content": "Create component diagrams for Foundation layer",
            "status": "completed",
            "activeForm": "Creating Foundation components"
          },
          {
            "content": "Create component diagrams for Feature layer",
            "status": "completed",
            "activeForm": "Creating Feature components"
          },
          {
            "content": "Create refs for shared patterns",
            "status": "completed",
            "activeForm": "Creating shared pattern refs"
          },
          {
            "content": "Create C3 index file",
            "status": "completed",
            "activeForm": "Creating C3 index"
          }
        ]
      }
    },
    {
      "timestamp": "2026-01-12T12:19:07.672Z",
      "event": "PreToolUse",
      "tool": "Bash",
      "input": {
        "command": "find /tmp/tmp.W3TPal6rM5/.c3 -type f -name \"*.md\" | sort",
        "description": "List all C3 documentation files created"
      }
    },
    {
      "timestamp": "2026-01-12T12:19:07.694Z",
      "event": "PostToolUse",
      "tool": "Bash",
      "input": {
        "command": "find /tmp/tmp.W3TPal6rM5/.c3 -type f -name \"*.md\" | sort",
        "description": "List all C3 documentation files created"
      },
      "result": {
        "stdout": "/tmp/tmp.W3TPal6rM5/.c3/adrs/adr-000-system-blueprint.md\n/tmp/tmp.W3TPal6rM5/.c3/c3-0-context.md\n/tmp/tmp.W3TPal6rM5/.c3/c3-1-web.md\n/tmp/tmp.W3TPal6rM5/.c3/c3-2-api.md\n/tmp/tmp.W3TPal6rM5/.c3/c3-3-database.md\n/tmp/tmp.W3TPal6rM5/.c3/c3-4-cache.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.10-events.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.1-auth-module.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.5-taskboard-module.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.7-database.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.8-cache.md\n/tmp/tmp.W3TPal6rM5/.c3/components/c3-2.9-websocket.md\n/tmp/tmp.W3TPal6rM5/.c3/index.md\n/tmp/tmp.W3TPal6rM5/.c3/refs/error-handling.md\n/tmp/tmp.W3TPal6rM5/.c3/refs/module-structure.md\n/tmp/tmp.W3TPal6rM5/.c3/refs/multi-tenancy.md",
        "stderr": "",
        "interrupted": false,
        "isImage": false
      }
    }
  ],
  "judgment": {
    "pass": true,
    "score": 100,
    "expectations": [
      {
        "text": "ADR-000 exists and serves as the architectural blueprint",
        "pass": true,
        "reasoning": "ADR-000 (adr-000-system-blueprint.md) was created with comprehensive architectural decisions including technology stack, patterns, module boundaries, multi-tenancy strategy, real-time architecture, security model, and directory structure. It clearly serves as the blueprint for the TaskFlow system."
      },
      {
        "text": "Context README describes TaskFlow's purpose and high-level architecture",
        "pass": true,
        "reasoning": "The c3-0-context.md file describes TaskFlow as 'a task management SaaS for small teams, enabling real-time collaboration on task boards within isolated team workspaces' and includes a system context diagram showing actors, external systems, and container references. The index.md also provides high-level architecture overview."
      },
      {
        "text": "At least 3 containers are defined (frontend, API, database or similar)",
        "pass": true,
        "reasoning": "Four containers are defined: c3-1 (Web Application - React SPA), c3-2 (API Server - Express.js), c3-3 (Database - PostgreSQL), and c3-4 (Cache - Redis). Each has its own dedicated documentation file with detailed specifications."
      },
      {
        "text": "Real-time/WebSocket considerations are documented",
        "pass": true,
        "reasoning": "WebSocket/real-time features are extensively documented: ADR-000 includes a 'Real-Time Architecture' section with diagrams, c3-4-cache.md covers Redis pub/sub for event distribution, c3-2.9-websocket.md details Socket.io server configuration, and the events bus (c3-2.10-events.md) documents event-driven communication patterns."
      },
      {
        "text": "Component placeholders exist for key features (auth, tasks, teams)",
        "pass": true,
        "reasoning": "Component documentation exists for: Auth Module (c3-2.1-auth-module.md) covering OAuth and JWT, TaskBoard Module (c3-2.5-taskboard-module.md) covering boards/tasks/columns. The container docs (c3-2-api.md) reference Team Module, Workspace Module, User Module, and Notification Module with clear module boundaries defined in ADR-000."
      }
    ],
    "summary": "The agent successfully created a comprehensive C3 architecture documentation for TaskFlow SaaS, including ADR-000 as the system blueprint, context documentation, four container definitions, extensive real-time/WebSocket coverage, and component placeholders for all key features including auth, tasks, and team-related functionality."
  }
}