#!/usr/bin/env bash
#
# C3 Architecture Gate (Soft)
#
# Behavior:
# - Only active if .c3/README.md exists (project has adopted C3)
# - If not adopted: Allow all operations silently
#
# Exit codes:
# - 0: Allow the operation

set -uo pipefail

# Read JSON from stdin
INPUT=$(cat)

# Parse file_path using simple text extraction
FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)".*/\1/' 2>/dev/null || echo "")

# No file path means we can't check - allow
if [[ -z "$FILE_PATH" ]]; then
    exit 0
fi

# Get project directory
PROJECT_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}"

# Skip gate for .c3/ documentation files themselves
REL_PATH="${FILE_PATH#$PROJECT_DIR/}"
if [[ "$REL_PATH" == .c3/* ]]; then
    exit 0
fi

# Only active if project has adopted C3 (has .c3/README.md)
if [[ ! -f "$PROJECT_DIR/.c3/README.md" ]]; then
    # Not a C3 project - allow silently
    exit 0
fi

# C3 project - allow the operation
# Could add soft nudges here in the future
exit 0
