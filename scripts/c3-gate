#!/usr/bin/env bash
#
# C3 Architecture Gate (Soft)
#
# Behavior:
# - If .c3/ doesn't exist: Block and suggest c3-adopt
# - If .c3/ exists: Allow, but nudge toward c3-navigator for impact awareness
#
# Exit codes:
# - 0: Allow the operation
# - 2: Block the operation (stderr shown to Claude)

set -uo pipefail

# Read JSON from stdin
INPUT=$(cat)

# Parse tool_name and file_path using simple text extraction
TOOL_NAME=$(echo "$INPUT" | grep -o '"tool_name"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)".*/\1/' 2>/dev/null || echo "")
FILE_PATH=$(echo "$INPUT" | grep -o '"file_path"[[:space:]]*:[[:space:]]*"[^"]*"' | sed 's/.*:.*"\([^"]*\)".*/\1/' 2>/dev/null || echo "")

# No file path means we can't check - allow
if [[ -z "$FILE_PATH" ]]; then
    exit 0
fi

# Get project directory
PROJECT_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}"

# Skip gate for .c3/ documentation files themselves
REL_PATH="${FILE_PATH#$PROJECT_DIR/}"
if [[ "$REL_PATH" == .c3/* ]]; then
    exit 0
fi

# Check: Does .c3/ exist?
if [[ ! -d "$PROJECT_DIR/.c3" ]]; then
    cat >&2 <<EOF
C3 Architecture Gate

No architecture documentation found (.c3/ directory missing).

C3 helps you:
- Document system architecture at Context/Container/Component levels
- Track architectural decisions with ADRs
- Understand impact before making changes

To initialize: Use the c3-adopt skill

Blocking: ${TOOL_NAME:-Edit} on $FILE_PATH
EOF
    exit 2
fi

# .c3/ exists - allow the operation
# Optionally: provide a soft nudge (non-blocking)
# Uncomment below to show a reminder without blocking:
#
# cat >&2 <<EOF
# Tip: Use c3-navigator agent to understand how this change affects the architecture.
# EOF

exit 0
